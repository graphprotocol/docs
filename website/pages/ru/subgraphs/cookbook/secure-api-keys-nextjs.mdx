---
title: Как обезопасить API-ключи с использованием серверных компонентов Next.js
---

## Обзор

We can use [Next.js server components](https://nextjs.org/docs/app/building-your-application/rendering/server-components) to properly secure our API key from exposure in the frontend of our dapp. To further increase our API key security, we can also [restrict our API key to certain subgraphs or domains in Subgraph Studio](/cookbook/upgrading-a-subgraph/#securing-your-api-key).

В этом руководстве мы рассмотрим, как создать серверный компонент Next.js, который запрашивает субграф, одновременно скрывая API-ключ от фронтенда.

### Caveats

- Next.js server components do not protect API keys from being drained using denial of service attacks.
- The Graph Network gateways have denial of service detection and mitigation strategies in place, however using server components may weaken these protections.
- Серверные компоненты Next.js вносят риски централизации, так как сервер может выйти из строя.

### Почему это необходимо

In a standard React application, API keys included in the frontend code can be exposed to the client-side, posing a security risk. While `.env` files are commonly used, they don't fully protect the keys since React's code is executed on the client side, exposing the API key in the headers. Next.js Server Components address this issue by handling sensitive operations server-side.

### Использование рендеринга на клиентской стороне для запроса к субграфу

![Рендеринг на клиентской стороне](/img/api-key-client-side-rendering.png)

### Предварительные требования

- API-ключ от [Subgraph Studio](https://thegraph.com/studio)
- Basic knowledge of Next.js and React.
- Существующий проект Next.js, который использует [App Router](https://nextjs.org/docs/app).

## Пошаговое руководство

### Step 1: Set Up Environment Variables

1. В корневой папке нашего проекта Next.js создайте файл `.env.local`.
2. Добавьте наш API-ключ: `API_KEY=<api_key_here>`.

### Step 2: Create a Server Component

1. В директории `components` создайте новый файл `ServerComponent.js`.
2. Используйте приведённый пример кода для настройки серверного компонента.

### Step 3: Implement Server-Side API Request

В файл `ServerComponent.js` добавьте следующий код:

```javascript
const API_KEY = process.env.API_KEY

export default async function ServerComponent() {
  const response = await fetch(
    `https://gateway-arbitrum.network.thegraph.com/api/${API_KEY}/subgraphs/id/HUZDsRpEVP2AvzDCyzDHtdc64dyDxx8FQjzsmqSg4H3B`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query: /* GraphQL */ `
          {
            factories(first: 5) {
              id
              poolCount
              txCount
              totalVolumeUSD
            }
          }
        `,
      }),
    },
  )

  const responseData = await response.json()
  const data = responseData.data

  return (
    <div>
      <h1>Server Component</h1>
      {data ? (
        <ul>
          {data.factories.map((factory) => (
            <li key={factory.id}>
              <p>ID: {factory.id}</p>
              <p>Pool Count: {factory.poolCount}</p>
              <p>Transaction Count: {factory.txCount}</p>
              <p>Total Volume USD: {factory.totalVolumeUSD}</p>
            </li>
          ))}
        </ul>
      ) : (
        <p>Loading data...</p>
      )}
    </div>
  )
}
```

### Step 4: Use the Server Component

1. In our page file (e.g., `pages/index.js`), import `ServerComponent`.
2. Отрендерите компонент:

```javascript
import ServerComponent from './components/ServerComponent'

export default function Home() {
  return (
    <main>
      <ServerComponent />
    </main>
  )
}
```

### Step 5: Run and Test Our Dapp

Запустите наше приложение Next.js с помощью команды `npm run dev`. Убедитесь, что серверный компонент запрашивает данные, не раскрывая API-ключ.

![Рендеринг на стороне сервера](/img/api-key-server-side-rendering.png)

### Заключение

By utilizing Next.js Server Components, we've effectively hidden the API key from the client-side, enhancing the security of our application. This method ensures that sensitive operations are handled server-side, away from potential client-side vulnerabilities. Finally, be sure to explore [other API key security measures](/subgraphs/querying/managing-api-keys/) to increase your API key security even further.
