---
title: Развертывание подграфа Arweave в Hosted Service
---

> Если сеть не поддерживается в Hosted Service, вы можете запустить собственную [graph-node](https://github.com/graphprotocol/graph-node) для ее индексации.

На этой странице объясняется, как развернуть подграф в Hosted Service. Чтобы развернуть подграф, вам необходимо сначала установить [Graph CLI](https://github.com/graphprotocol/graph-cli). Если вы еще не создали подграф, см. раздел [создание подграфа](/developing/creating-a-subgraph).

## Создание учетной записи Hosted Service

Прежде чем использовать Hosted Service, создайте учетную запись в нашем Hosted Service. Вам понадобится учетная запись [Github](https://github.com/) для этого; если у вас ее нет, вам нужно сначала создать ее. Затем перейдите в [Hosted Service](https://thegraph.com/hosted-service/), нажмите на кнопку _'Sign up with Github'_ и завершите процедуру авторизации через Github.

## Хранение идентификатора доступа

После создания учетной записи перейдите к своему [дашборду](https://thegraph.com/hosted-service/dashboard). Скопируйте идентификатор доступа, отображаемый на панели, и запустите `graph auth --product hosted-service <ACCESS_TOKEN>`. Это сохранит идентификатор на вашем компьютере. Вам нужно сделать это только один раз, или если вы когда-либо повторно создадите идентификатор доступа.

## Создание подграфа в Hosted Service

Перед развертыванием подграфа вам необходимо создать его в The Graph Explorer. Перейдите в [дашборд](https://thegraph.com/hosted-service/dashboard) и нажмите на кнопку _ 'Add Subgraph'_ и соответствующим образом заполните приведенную ниже информацию:

**Image** - Выберите изображение, которое будет использоваться в качестве изображения предварительного просмотра и миниатюры для подграфа.

**Subgraph Name** - Вместе с именем учетной записи, под которым создается подграф, это также определит `account-name/subgraph-name`-имя стиля, используемого для развертываний и эндпоинтов GraphQL. _Это поле не может быть изменено позже._

** Account ** - учетная запись, под которой создается подграф. Это может быть учетная запись физического лица или организации. _Подграфы позже нельзя будет перемещать между учетными записями._

**Subtitle** - текст, который будет отображаться в виде карт подграфа.

** Description ** - Описание подграфа, видимое на странице сведений о подграфе.

**URL GitHub** - ссылка на subgraph репозиторий на GitHub.

** Hide ** - включение этого параметра скрывает подграф в The Graph Explorer.

После сохранения нового подграфа вы увидите экран с информацией о том, как установить Graph CLI, как сгенерировать scaffolding для нового подграфа и как запустить ваш подграф. Первые два шага были рассмотрены в разделе [Defining a Subgraph](/developing/defining-a-subgraph).

## Развертывание подграфа в Hosted Service

Развертывание вашего подграфа загрузит файлы подграфа, которые вы создали с помощью `yarn build`, в IPFS и попросит Graph Explorer начать индексирование вашего подграфа с использованием этих файлов.

Для развертывания подграфа выполните команду `yarn deploy`

После развертывания подграфа Graph Explorer переключится на отображение статуса синхронизации вашего подграфа. В зависимости от объема данных и количества событий, которые необходимо извлечь из исторических блоков, начиная с genesis блока, синхронизация может занять от нескольких минут до нескольких часов.

Статус подграфа переключается на `Synced`, как только Graph Node извлечет все данные из исторических блоков. The Graph Node будет продолжать проверять блоки для вашего подграфа по мере добывания этих блоков.

## Повторное развертывание подграфа

При внесении изменений в определение подграфа, например, для устранения проблемы в сопоставлении объектов, выполните команду `yarn deploy` выше, чтобы снова установить обновленную версию подграфа. Любое обновление подграфа требует, чтобы Graph Node заново проиндексировал весь ваш подграф, снова начиная с genesis блока.

Если ваш ранее развернутый подграф все еще находится в статусе `Syncing`, он будет немедленно заменен на недавно развернутую версию. Если ранее развернутый подграф уже полностью синхронизирован, нода Graph пометит вновь развернутую версию как `Pending Version`, синхронизирует ее в фоновом режиме и заменит текущую развернутую версию новой только после завершения синхронизации новой версии. Это гарантирует, что у вас есть подграф для работы во время синхронизации новой версии.

## Развертывание подграфа в нескольких сетях

В некоторых случаях вы захотите развернуть один и тот же подграф в нескольких сетях, не дублируя весь его код. Основная проблема, возникающая при этом, заключается в том, что адреса контрактов в этих сетях разные.

### Использование graph-cli

Как `graph build` (начиная с `v0.29.0`), так и `graph deploy` (начиная с `v0.32.0`) допускают две новые опции:

```sh
      ...
      --network <name> Конфигурация сети для использования из файла конфигурации сетей
      --network-file <path> Путь к файлу конфигурации сетей (по умолчанию: "./networks.json")
```

Вы можете использовать опцию `--network`, чтобы указать конфигурацию сети из стандартного файла `json` (по умолчанию используется `networks.json`), чтобы легко обновлять свой подграф во время разработки.

**Примечание:** Команда `init` теперь автоматически сгенерирует `networks.json` на основе предоставленной информации. Затем вы сможете обновить существующие или добавить дополнительные сети.

Если у вас нет файла `networks.json`, вам нужно будет вручную создать его со следующей структурой:

```json
{
    "network1": { // the network name
        "dataSource1": { // the dataSource name
            "address": "0xabc...", // the contract address (optional)
            "startBlock": 123456 // the startBlock (optional)
        },
        "dataSource2": {
            "address": "0x123...",
            "startBlock": 123444
        }
    },
    "network2": {
        "dataSource1": {
            "address": "0x987...",
            "startBlock": 123
        },
        "dataSource2": {
            "address": "0xxyz..",
            "startBlock": 456
        }
    },
    ...
}
```

**Примечание:** Вам не нужно указывать ни один из `templates` (если они у вас есть) в файле конфигурации, только `dataSources`. Если есть какие-либо `templates`, объявленные в файле `subgraph.yaml`, их сеть будет автоматически обновлена до указанной с помощью опции `--network`.

Теперь давайте предположим, что вы хотите иметь возможность развернуть свой подграф в сетях `mainnet` и `goerli`, и это ваш `subgraph.yaml`:

```yaml
# ...
dataSources:
  - kind: ethereum/contract
    name: Gravity
    network: mainnet
    source:
      address: '0x123...'
      abi: Gravity
    mapping:
      kind: ethereum/events
```

Вот как должен выглядеть файл конфигурации ваших сетей:

```json
{
  "mainnet": {
    "Gravity": {
      "address": "0x123..."
    }
  },
  "goerli": {
    "Gravity": {
      "address": "0xabc..."
    }
  }
}
```

Теперь мы можем запустить одну из следующих команд:

```sh
# Использование стандартного файла networks.json
yarn build --network goerli

# Использование файла с пользовательским именем
yarn build --network goerli --network-file path/to/config
```

Команда `build` обновит ваш `subgraph.yaml` конфигурацией `goerli`, а затем повторно скомпилирует подграф. Ваш файл `subgraph.yaml` теперь должен выглядеть следующим образом:

```yaml
# ...
dataSources:
  - kind: ethereum/contract
    name: Gravity
    network: goerli
    source:
      address: '0xabc...'
      abi: Gravity
    mapping:
      kind: ethereum/events
```

Теперь вы готовы к `yarn deploy`.

**Примечание:** Как упоминалось ранее, поскольку `graph-cli 0.32.0` вы можете напрямую запустить `yarn deploy` с опцией `--network`:

```sh
# Использование стандартного файла networks.json
yarn deploy --network goerli

# Использование файла с пользовательским именем
yarn deploy --network goerli --network-file path/to/config
```

### Использование шаблона subgraph.yaml

Одним из решений для старых версий graph-cli, которое позволяет параметризовать такие аспекты, как адреса контрактов, является генерация его частей с использованием системы шаблонов, такой как [Mustache](https://mustache.github.io/) или [Handlebars](https://handlebarsjs.com/).

Чтобы проиллюстрировать этот подход, давайте предположим, что подграф должен быть развернут в основной сети и в сети Goerli с использованием разных адресов контракта. Затем вы можете определить два файла конфигурации, содержащие адреса для каждой сети:

```json
{
  "network": "mainnet",
  "address": "0x123..."
}
```

и

```json
{
  "network": "goerli",
  "address": "0xabc..."
}
```

Наряду с этим, необходимо заменить имя сети и адреса в манифесте на variable placeholders `{{network}}` и `{{address}}` и переименовать манифест, например, `subgraph.template.yaml`:

```yaml
# ...
dataSources:
  - kind: ethereum/contract
    name: Gravity
    network: mainnet
    network: {{network}}
    source:
      address: '0x2E645469f354BB4F5c8a05B3b30A929361cf77eC'
      address: '{{address}}'
      abi: Gravity
    mapping:
      kind: ethereum/events
```

Чтобы сформировать манифест для любой сети, вы можете добавить две дополнительные команды в `package.json` вместе с dependency от `mustache`:

```json
{
  ...
  "scripts": {
    ...
    "prepare:mainnet": "mustache config/mainnet.json subgraph.template.yaml > subgraph.yaml",
    "prepare:goerli": "mustache config/goerli.json subgraph.template.yaml > subgraph.yaml"
  },
  "devDependencies": {
    ...
    "mustache": "^3.1.0"
  }
}
```

Чтобы развернуть этот подграф для основной сети или сети Goerli, вам нужно просто выполнить одну из двух следующих команд:

```sh
# Mainnet:
yarn prepare:mainnet && yarn deploy

# Goerli:
yarn prepare:goerli && yarn deploy
```

Рабочий пример этого можно найти [здесь](https://github.com/graphprotocol/example-subgraph/tree/371232cf68e6d814facf5e5413ad0fef65144759).

**Примечание:** Этот подход также может быть применен к более сложным ситуациям, где необходимо заменить больше, чем адреса контрактов и сетевые имена, или где также генерируются сопоставления или ABI из шаблонов.

## Проверка работоспособности подграфа

Если подграф успешно синхронизируется, это хороший признак того, что он будет работать надёжно. Однако новые триггеры в сети могут привести к тому, что ваш подграф попадет в состояние непроверенной ошибки, или он может начать отставать из-за проблем с производительностью или проблем с операторами нод.

Graph Node предоставляет эндпоинт graphql, к которому вы можете обратиться для проверки состояния вашего подграфа. В Hosted Service он доступен по адресу `https://api.thegraph.com/index-node/graphql`. На локальной ноде он доступен по умолчанию через порт `8030/graphql`. Полную схему для этого эндпоинта можно найти [здесь](https://github.com/graphprotocol/graph-node/blob/master/server/index-node/src/schema.graphql). Вот пример запроса, который проверяет статус текущей версии подграфа:

```graphql
{
  indexingStatusForCurrentVersion(subgraphName: "org/subgraph") {
    synced
    health
    fatalError {
      message
      block {
        number
        hash
      }
      handler
    }
    chains {
      chainHeadBlock {
        number
      }
      latestBlock {
        number
      }
    }
  }
}
```

Это даст вам `chainHeadBlock`, который вы можете сравнить с `latestBlock` на вашем подграфе, чтобы проверить, отстает ли он. `synced` сообщает, попадал ли когда-либо подграф в сеть. `health` в настоящее время может принимать значения `healthy`, если ошибок не произошло, или `failed`, если произошла ошибка, которая остановила работу подграфа. В этом случае вы можете проверить поле `FatalError` для получения подробной информации об этой ошибке.

## Политика архивирования подграфов в Hosted Service

The Hosted Service представляет собой бесплатного Индексатора ноды Graph. Разработчики могут развернуть подграфы, индексирующие ряд сетей, которые будут проиндексированы и станут доступными для запросов через GraphQL.

Чтобы повысить производительность службы для активных подграфов, The Hosted Service будет архивировать неактивные подграфы.

**Подграф определяется как "неактивный", если он был развернут в Hosted Service более 45 дней назад, и если за последние 45 дней он получил 0 запросов.**

Разработчики получат уведомление по электронной почте, если один из их подграфов будет помечен как неактивный за 7 дней до его удаления. Если они захотят "активировать" свой подграф, они могут сделать это, выполнив запрос на площадке graphQL в Hosted Service их подграфа. Разработчики всегда могут развернуть архивированный подграф, если он снова понадобится.

## Политика архивирования подграфов в Subgraph Studio

Когда развертывается новая версия подграфа, предыдущая версия архивируется (удаляется из базы данных graph-node). Это происходит только в том случае, если предыдущая версия не опубликована в децентрализованной сети Graph.

Если версия подграфа не запрашивается более 45 дней, эта версия архивируется.

У каждого подграфа, затронутого этой политикой, есть возможность вернуть соответствующую версию обратно.
