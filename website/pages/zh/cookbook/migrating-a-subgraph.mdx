---
title: 将现有子图迁移到Graph网络
---

## 介绍

这是关于如何将子图从托管服务迁移到Graph的去中心化网络的指南。Opyn、UMA、mStable、Audius、PoolTogether、Livepeer、RAI、Enzyme、DODO、Pickle和BadgerDAO等项目已成功迁移到Graph网络，所有这些项目都依赖网络上索引人提供的数据。现在，Graph的去中心化网络上有700多个子图在运行，产生查询费用，并主动为web3数据编制索引。

迁移过程很快，您的子图将永远受益于Graph网络上独有的高可靠性和高性能。

### 假设

- 您已经在托管服务上部署了子图。
- 该子图正在索引Graph网络上支持的链(或测试版中支持的链)。
- The subgraph does not use `ipfs.cat` in handler functions.
- The subgraph does not have full-text search dependencies (it is not fully supported on the decentralized network yet).

## 将现有子图迁移到Graph网络

> 您可以在[subgraph Studio](https://thegraph.com/studio/)中找到子图的特定命令。

1. 获取已安装的最新版本的 graph-cli：

```sh
npm install -g @graphprotocol/graph-cli
```

```sh
yarn global add @graphprotocol/graph-cli
```

还要确保subgrap.yaml中的`apiVersion`为`0.0.5`或更高版本。

2. 在子图的主项目存储库中，对子图进行身份验证，以便在studio上部署和构建:

```sh
graph auth --studio <DEPLOY_KEY>
```

3. 生成文件并构建子图：

```sh
graph codegen && graph build
```

如果您的子图有生成错误，请参考[AssemblyScript迁移指南](/release-notes/assemblyscript-migration-guide/)。

4. 用您的钱包登录[Subgraph Studio](https://thegraph.com/studio/)并部署子图。您可以在Studio UI中找到您的基于子图名称的`<SUBGRAPH_SLUG>`。

```sh
graph deploy --studio <SUBGRAPH_SLUG>
```

5. 在 Studio 的playground上测试查询。 以下是 [Sushi - Mainnet Exchange Subgraph](https://thegraph.com/explorer/subgraph?id=0x4bb4c1b0745ef7b4642feeccd0740dec417ca0a0-0&view=Playground) 的一些示例：

```sh
{
  users(first: 5) {
    id
    liquidityPositions {
      id
    }
  }
  bundles(first: 5) {
    id
    ethPrice
  }
}
```

6. 此时，您的子图现在已经部署在Subgraph Studio上，但还没有发布到去中心化网络上。现在，您可以使用上面右列顶部的临时查询URL来测试子图，以确保它正常工作。正如这个名称已经表明的那样，这是一个临时URL，不应该在生产环境中使用。

- 请记住，发布是一种链上操作，需要在以太坊中支付 gas - 请参阅[此处](https://etherscan.io/tx/0xd0c3fa0bc035703c9ba1ce40c1862559b9c5b6ea1198b3320871d535aa0de87b)的示例交易。 价格约为 100 gwei 时的 0.0425 ETH。
- 任何时候您需要升级您的子图，您将支付升级费用。记住，升级只是发布现有子图的另一个版本。因为这会带来成本，所以强烈建议在将子图部署到主网之前在Goerli进行部署和测试。在某些情况下，如果该子图上没有信号，那么它也需要一些GRT。在子图版本(使用自动迁移) 上有信号/策展的情况下，税收将被分割。

7. 通过点击“发布”按钮在Graph的去中心化网络上发布子图。

就是这样！在您完成发布之后，您将能够通过[Graph浏览器](https://thegraph.com/explorer)在去中心化的网络上实时查看您的子图。

随意利用 Discord 上的 [#Curators 频道](https://discord.gg/rC8rBuRtbH) 让策展人知道您的子图已准备好发出信号。 如果您与他们分享您的预期查询量，这也会很有帮助。 因此，他们可以估计他们应该在您的子图上发出多少 GRT。

### 创建一个API密钥

你可以在Subgraph Studio[这里](https://thegraph.com/studio/apikeys/)生成一个API密钥。

![创建 API 密钥页](/img/api-image.png)

在每周结束时，将根据在此期间发生的查询费用生成发票。此发票将自动使用您的余额中的GRT支付。您的查询费用的成本被撤回后，您的余额将被更新。查询费用通过Arbitrum网络以GRT支付。您需要将GRT添加到Arbitrum计费合同中，通过以下步骤启用您的API密钥:

- 在你选择的交换机上购买GRT。
- 把GRT送到你的钱包里。
- 在Studio中的Billing page上，单击Add GRT。

![在账单中加入 GRT](/img/Add-GRT-New-Page.png)

- 按照以下步骤将GRT添加到您的账单余额中。
- 您的GRT将自动连接到Arbitrum网络并添加到您的账单余额。

![账单面板](/img/New-Billing-Pane.png)

> 注意：有关将GRT添加到您的账单余额的完整说明，请参阅[正式账单页](../billing.mdx)。

### 保护您的API密钥

建议您通过以下两种限制API使用的方式来保护API：

1. 授权子图
2. 授权域名

您可以点击[这里](https://thegraph.com/studio/apikeys/test/)保护您的API密钥。

![子图封锁页面](/img/subgraph-lockdown.png)

### 在去中心化网络上查询子图

现在，您可以在Graph浏览器中检查网络上的索引人的索引状态([这里](https://thegraph.com/explorer/subgraph?id=S9ihna8D733WTEShJ1KctSTCvY1VJ7gdVwhUujq4Ejo&view=Indexers)的示例)。顶部的绿线表示在发布8个索引人时，成功索引了该子图。另外，在索引人选项卡中，您可以看到哪些索引人选择了您的子图。

![Rocket Pool 子图](/img/rocket-pool-subgraph.png)

一旦第一个索引人完全索引了您的子图，您就可以开始在去中心化的网络上查询子图。为了检索子图的查询URL，您可以通过单击查询URL旁边的符号来复制/粘贴它。你会看到这样的东西:

`https://gateway.thegraph.com/api/[api-key]/subgraphs/id/S9ihna8D733WTEShJ1KctSTCvY1VJ7gdVwhUujq4Ejo`

重要提示：确保用上一节中生成的实际API密钥替换`[api-key]`。

现在可以在dapp中使用该查询URL发送GraphQL请求。

恭喜! 你现在是去中心化的先驱了！

> 注意：由于网络的去中心化特性，不同的索引人可能会索引不同的区块。为了只接收新数据，你可以指定索引人必须索引的最小区块，以便为查询提供区块参数：`{ number_gte: $minBlock }` 字段参数如下例所示：

```graphql
{
  stakers(block: { number_gte: 14486109 }) {
    id
  }
}
```

关于网络的性质以及如何处理重组的更多信息将在[Distributed Systems](/querying/distributed-systems/)文档文章中描述。

## 升级网络上的子图

如果您想升级网络上的现有子图，可以通过使用 Graph CLI 将新版本的子图部署到 Subgraph Studio 来实现。

1. 更改您当前的子图。一个好主意是通过向Goerli发布内容来测试Subgraph Studio的小修补程序。
2. 部署以下内容并在命令中指定新版本（例如 v0.0.1、v0.0.2 等）：

```sh
graph deploy --studio <SUBGRAPH_SLUG>
```

3. 通过在 Playground 中查询来测试 Subgraph Studio 中的新版本。
4. 在 The Graph Network 上发布新版本。 请记住，这需要gas（如上一节所述）。

### 所有者升级费用：Deep Dive

升级要求GRT从子图的旧版本迁移到新版本。这意味着每次升级都会创建一条新的粘合曲线([这里](/network/curating#bonding-curve-101)更多与粘合曲线相关)。

The new bonding curve charges the 1% curation tax on all GRT being migrated to the new version. The owner must pay 50% of this or 1.25%. The other 1.25% is absorbed by all the curators as a fee. This incentive design is in place to prevent an owner of a subgraph from being able to drain all their curator's funds with recursive upgrade calls. If there is no curation activity, you will have to pay a minimum of 100 GRT in order to signal your own subgraph.

让我们举个例子，仅当您的子图正在获得积极时才策展会出现这种情况：

- 在子图的 v1 上使用自动迁移发出 100,000 GRT 信号
- 所有者升级到 v2。 100,000 GRT 被迁移到新粘合曲线，其中 97,500 GRT 进入新曲线，2,500 GRT 被用尽
- 然后，所有者耗费了 1250 GRT 以支付一半的费用。 升级前所有者钱包里必须有这个，否则升级不会成功。 这发生在与升级相同的交易中。

_虽然这种机制目前在网络上运行，但社区目前正在讨论降低子图开发人员升级成本的方法。_

### 维护子图的稳定版本

如果要对子图进行大量更改，那么不断升级子图并预付升级费用就不是一个好主意。维护您子图版本的稳定和一致是至关重要的，不仅从成本的角度来看，而且这样索引人可以对他们的同步时间有信心。在计划升级时，应该标记索引人，以便索引人同步时间不受影响。请随意利用Discord上的[#Indexers channel](https://discord.gg/rC8rBuRtbH)，以便您对您的子图进行版本控制时让索引人知道。

子图是外部开发人员正在利用的开放 API。 开放 API 需要遵循严格的标准，以免破坏外部开发人员的应用程序。 在 Graph网络中，子图开发人员必须考虑索引人以及同步新子图 ** 和** 使用其子图的其他开发人员需要多长时间。

### 更新子图的元数据

您可以更新子图的元数据，而无需发布新版本。 元数据包括子图名称、图像、描述、网站 URL、源代码 URL 和类别。 开发人员可以通过在 Subgraph Studio 中更新他们的子图详细信息来实现，您可以在其中编辑所有适用的字段。

确保选中**Update Subgraph Details in Explorer**，然后点击**保存**。 如果选中此项，将生成一个链上交易，更新浏览器中的子图详细信息，而无需发布具有新部署的新版本。

## 将子图部署到Graph网络的最佳实践

1. 利用 ENS 名称进行子图开发：

- 设置您的 ENS：[https://app.ens.domains/](https://app.ens.domains/)
- [此处](https://thegraph.com/explorer/settings?view=display-name)将您的 ENS 名称添加到您的设置中。

2. 您的个人资料填写得越多，您的子图被索引和管理的机会就越大。

## 弃用Graph网络上的子图

按照[这里](/managing/deprecating-a-subgraph)的步骤废弃您的子图并将其从Graph 网络中删除。

## 在Graph网络上查询子图 + 计费

托管服务的设置允许开发人员不受任何限制地部署他们的子图。

为了使Graph 网络真正去中心化，查询费用必须作为协议激励的核心部分支付。有关订阅API和支付查询费用的详细信息，请参阅[此处](/billing/)的账单文档。

### 估算网络上的查询费用

虽然这不是产品 UI 中的实时功能，但您可以通过将每月愿意支付的金额除以预期查询量来设置每次查询的最大预算。

虽然您可以决定查询预算，但不能保证索引人愿意以该价格提供查询服务。 如果网关可以将您与您愿意支付的价格或低于您愿意支付价格提供查询的索引人相匹配，您将支付预算的增量/差异**和** 与他们的价格。 因此，较低的查询价格会减少可供您使用的索引人池，这可能会影响您获得的服务质量。 收取高额查询费用是有益的，因为这可能会吸引策展和知名索引人到您的子图。

请记住，这是一个充满活力且不断增长的市场，但您如何与之互动在您的控制之下。 协议或网关中没有指定最高或最低价格。 例如，您可以查看网络上一些 dapps 支付的价格（每周），如下所示。 请参阅最后一列，它显示了 GRT 中的查询费用。 例如，Pickle Finance 每秒有 个请求，支付 GRT 一周。

![查询费](/img/QueryFee.png)

## 其他资源

如果您仍然感到困惑，请不要害怕！ 查看以下资源或观看我们的视频指南，了解将子图迁移到下面的去中心化网络：

<VideoEmbed youtube="CzdQ3dFFrjo" />

- [Graph网络合约](https://github.com/graphprotocol/contracts)
- [策展合约](https://github.com/graphprotocol/contracts/blob/dev/contracts/curation/Curation.sol) - GNS 包裹的底层合约
  - 地址 - `0x8fe00a685bcb3b2cc296ff6ffeab10aca4ce1538`
- [子图工作室文档](/deploying/subgraph-studio)
