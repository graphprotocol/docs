---
title: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
---

Matchstick ã¯[LimeChain](https://limechain.tech/)ãŒé–‹ç™ºã—ãŸãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã€ã‚µãƒ–ã‚°ãƒ©ãƒ•ã®é–‹ç™ºè€…ãŒã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã§ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã—ã€è‡ªä¿¡ã‚’æŒã£ã¦ã‚µãƒ–ã‚°ãƒ©ãƒ•ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™!

## ã¯ã˜ã‚ã«

### ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

```sh
yarn add --dev matchstick-as
```

â— `graph-node` ã¯PostgreSQLã«ä¾å­˜ã—ã¦ã„ã‚‹ã®ã§ã€ã‚‚ã—ã¾ã æŒã£ã¦ã„ãªã‘ã‚Œã°ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»–ã®æ–¹æ³•ã§è¿½åŠ ã™ã‚‹ã¨äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ï¼

#### MacOS

Postgresã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ï¼š

```sh
postgresql ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```

æœ€æ–°ã® libpq.5.lib ã¸ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¾ã™ _æœ€åˆã«ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™_ `/usr/local/opt/postgresql/lib/`

```sh
ln -sf /usr/local/opt/postgresql@14/lib/postgresql@14/libpq.5.dylib /usr/local/opt/postgresql/lib/libpq.5.dylib
```

#### Linux

Postgresã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ï¼ˆãŠä½¿ã„ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒ­ã«ä¾å­˜ã—ã¾ã™ï¼‰ã€‚

```sh
sudo apt postgresql ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```

### WSL (Linux ç”¨ Windows ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ )

WSLã§ã¯ã€Dockerã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ãƒã‚¤ãƒŠãƒªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®ä¸¡æ–¹ã§Matchstickã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚WSLã¯å°‘ã—ãƒˆãƒªãƒƒã‚­ãƒ¼ãªã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡Œã«é­é‡ã—ãŸå ´åˆã®ãƒ’ãƒ³ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

```
static BYTES = Symbol("Bytes") SyntaxError: Unexpected token =
```

ã¾ãŸã¯

```
<PROJECT_PATH>/node_modules/gluegun/build/index.js:13 throw up;
```

Node.jsã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ graph-cliã¯ã‚‚ã†**v10.19.0** ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚‰ãšã€ã“ã‚Œã¯ã¾ã WSLä¸Šã®æ–°ã—ã„Ubuntuã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãªã£ã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ãƒãƒƒãƒã‚¹ãƒ†ã‚£ãƒƒã‚¯ã¯**v18.1.0** ã§WSLä¸Šã§å‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¦ãŠã‚Šã€**nvm** ã‚’çµŒç”±ã™ã‚‹ã‹ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«Node.jsã‚’æ›´æ–°ã™ã‚Œã°åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚nodejsã‚’æ›´æ–°ã—ãŸã‚‰ã€`node_modules`ã‚’å‰Šé™¤ã—ã€`npm install`ã‚’å†åº¦å®Ÿè¡Œã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„! ãã‚Œã‹ã‚‰ã€**libpq** ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```
sudo apt-get install libpq-dev ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
```

æœ€å¾Œã«ã€`graph test` (ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸgraph-cliã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãªãœã‹WSLã§ã¯å£Šã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™)ã‚’ä½¿ç”¨ã›ãšã€`yarn test` ã‚„ `npm run test` (ãƒ­ãƒ¼ã‚«ãƒ«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã®graph-cliã‚’ä½¿ç”¨ã—ã€é­…åŠ›çš„ã«å‹•ä½œã—ã¾ã™ã€‚)ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ãã®ãŸã‚ã«ã¯ã€ã‚‚ã¡ã‚ã‚“ `"test"` ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ `package.json` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç°¡å˜ãªã‚‚ã®ã§ã™ã€‚

```json
{
  "name": "demo-subgraph",
  "version": "0.1.0",
  "scripts": {
    "test": "graph test",
    ...
  },
  "dependencies": {
    "@graphprotocol/graph-cli": "^0.30.0",
    "@graphprotocol/graph-ts": "^0.27.0",
    "matchstick-as": "^0.5.0"
  }
}
```

### ä½¿ã„æ–¹

**Matchstick** ã‚’ã‚µãƒ–ã‚°ãƒ©ãƒ•ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ãã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¦ã€ `graph test [options] <datasource>` ã¨å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã€æœ€æ–°ã® **Matchstick** ãƒã‚¤ãƒŠãƒªãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã€ãƒ†ã‚¹ãƒˆãƒ»ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹æŒ‡å®šã—ãŸãƒ†ã‚¹ãƒˆã¾ãŸã¯å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ (datasource flag ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°æ—¢å­˜ã®å…¨ã¦ã®ãƒ†ã‚¹ãƒˆ).

### CLI options

ã“ã‚Œã«ã‚ˆã‚Šã€test ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```sh
ã‚°ãƒ©ãƒ•ãƒ†ã‚¹ãƒˆ
```

ã“ã‚Œã¯ã€gravity.test.tsã¨ã„ã†åå‰ã®ãƒ†ã‚¹ãƒˆã¨ã€gravityã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã«ã‚ã‚‹ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```sh
gravityã®ãƒ†ã‚¹ãƒˆ
```

ã“ã‚Œã¯ã€ãã®ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```sh
graph test path/to/file.test.ts
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼š**

```sh
-c, --coverage                Run the tests in coverage mode
-d, --docker                  Run the tests in a docker container (Note: Please execute from the root folder of the subgraph)
-f, --force                   Binary: Redownloads the binary. Docker: Redownloads the Dockerfile and rebuilds the docker image.
-h, --help                    Show usage information
-l, --logs                    Logs to the console information about the OS, CPU model and download url (debugging purposes)
-r, --recompile               Forces tests to be recompiled
-v, --version <tag>           Choose the version of the rust binary that you want to be downloaded/used
```

### Docker

`graph-cli 0.25.2` ã‹ã‚‰ã¯ã€`graph test` ã‚³ãƒãƒ³ãƒ‰ãŒ `-d` ãƒ•ãƒ©ã‚°ã®ä»˜ã„ãŸ docker ã‚³ãƒ³ãƒ†ãƒŠã§ã® `matchstick` ã®å®Ÿè¡Œã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚docker ã®å®Ÿè£…ã§ã¯ã€[bind mount](https://docs.docker.com/storage/bind-mounts/) ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€`graph test -d` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã³ã« docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†æ§‹ç¯‰ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€[matchstick](https://github.com/LimeChain/matchstick#docker-) ãƒªãƒã‚¸ãƒˆãƒªã®èª¬æ˜ã«å¾“ã£ã¦ã€æ‰‹å‹•ã§Dockerã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

â— ä»¥å‰ã« `graph test` ã‚’å®Ÿè¡Œã—ãŸã“ã¨ãŒã‚ã‚‹å ´åˆã€docker build ä¸­ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```sh
  é€ä¿¡è€…ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼: xattr node_modules/binary-install-raw/bin/binary-<platform> ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚
```

ã“ã®å ´åˆã€ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã« `.dockerignore` ã‚’ä½œæˆã—ã€ `node_modules/binary-install-raw/bin` ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

### ã‚³ãƒ³ãƒ•ã‚£ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

Matchstick ã¯ã€`matchstick.yaml` è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã£ã¦ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚¹ãƒˆã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yaml
testsFolder: path/to/tests
libsFolder: path/to/libs
manifestPath: path/to/subgraph.yaml
```

### ãƒ‡ãƒ¢ãƒ»ã‚µãƒ–ã‚°ãƒ©ãƒ•

[Demo Subgraph ãƒ¬ãƒ](https://github.com/LimeChain/demo-subgraph)ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ã“ã¨ã§ã€ã“ã®ã‚¬ã‚¤ãƒ‰ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è©¦ã—ãŸã‚Šã€éŠã‚“ã ã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ“ãƒ‡ã‚ªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«

ã¾ãŸã€[ã€ŒMatchstickã‚’ä½¿ã£ã¦ã‚µãƒ–ã‚°ãƒ©ãƒ•ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’æ›¸ãæ–¹æ³•ã€](https://www.youtube.com/playlist?list=PLTqyKgxaGF3SNakGQwczpSGVjS_xvOv3h)ã®ãƒ“ãƒ‡ã‚ªã‚·ãƒªãƒ¼ã‚ºã‚‚ã”è¦§ãã ã•ã„ã€‚

## Tests structure (>=0.5.0)

_**IMPORTANT: Requires matchstick-as >=0.5.0**_

### describe()

`describe(name: String , () => {})` - Defines a test group.

**_æ³¨ï¼š_**

- _ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ¼ãƒˆã¯å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚describe() ãƒ–ãƒ­ãƒƒã‚¯ã®å¤–å´ã§ test() ã‚’æ—§æ¥ã®æ–¹æ³•ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚_

ä¾‹ï¼š

```typescript
import { describe, test } from "matchstick-as/assembly/index"
import { handleNewGravatar } from "../../src/gravity"

describe("handleNewGravatar()", () => {
  test("Should create a new Gravatar entity", () => {
    ...
  })
})
```

Nested `describe()` example:

```typescript
import { describe, test } from "matchstick-as/assembly/index"
import { handleUpdatedGravatar } from "../../src/gravity"

describe("handleUpdatedGravatar()", () => {
  describe("When entity exists", () => {
    test("updates the entity", () => {
      ...
    })
  })

  describe("When entity does not exists", () => {
    test("it creates a new entity", () => {
      ...
    })
  })
})
```

---

### test()

`test(name: String, () =>, should_fail: bool)` - ãƒ†ã‚¹ãƒˆ ã‚±ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚ test() ã¯ã€describe() ãƒ–ãƒ­ãƒƒã‚¯å†…ã¾ãŸã¯ç‹¬ç«‹ã—ã¦ä½¿ç”¨ã§ãã¾ã™

ä¾‹:

```typescript
import { describe, test } from "matchstick-as/assembly/index"
import { handleNewGravatar } from "../../src/gravity"

describe("handleNewGravatar()", () => {
  test("Should create a new Entity", () => {
    ...
  })
})
```

ã¾ãŸã¯

```typescript
test("handleNewGravatar() should create a new entity", () => {
  ...
})


```

---

### beforeAll()

ãƒ•ã‚¡ã‚¤ãƒ«ä¸­ã®ã©ã®ãƒ†ã‚¹ãƒˆã‚ˆã‚Šã‚‚å‰ã«ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚‚ã— `beforeAll` ãŒ `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§å®£è¨€ã•ã‚ŒãŸå ´åˆã€ãã® `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®å…ˆé ­ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¾‹

`beforeAll` å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã® _all_ ãƒ†ã‚¹ãƒˆã®å‰ã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, beforeAll } from "matchstick-as/assembly/index"
import { handleUpdatedGravatar, handleNewGravatar } from "../../src/gravity"
import { Gravatar } from "../../generated/schema"

beforeAll(() => {
  let gravatar = new Gravatar("0x0")
  gravatar.displayName = â€œFirst Gravatarâ€
  gravatar.save()
  ...
})

describe("When the entity does not exist", () => {
  test("it should create a new Gravatar with id 0x1", () => {
    ...
  })
})

describe("When entity already exists", () => {
  test("it should update the Gravatar with id 0x0", () => {
    ...
  })
})
```

`beforeAll` å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æœ€åˆã®è¨˜è¿°ãƒ–ãƒ­ãƒƒã‚¯ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã®å‰ã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, beforeAll } from "matchstick-as/assembly/index"
import { handleUpdatedGravatar, handleNewGravatar } from "../../src/gravity"
import { Gravatar } from "../../generated/schema"

describe("handleUpdatedGravatar()", () => {
  beforeAll(() => {
    let gravatar = new Gravatar("0x0")
    gravatar.displayName = â€œFirst Gravatarâ€
    gravatar.save()
    ...
  })

  test("updates Gravatar with id 0x0", () => {
    ...
  })

  test("creates new Gravatar with id 0x1", () => {
    ...
  })
})
```

---

### afterAll()

ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã®å¾Œã«ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚‚ã— `afterAll` ãŒ `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§å®£è¨€ã•ã‚ŒãŸå ´åˆã€ãã® `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®æœ€å¾Œã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¾‹:

`afterAll` å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«å†…ã® _all_ ãƒ†ã‚¹ãƒˆã®å¾Œã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, afterAll } from "matchstick-as/assembly/index"
import { handleUpdatedGravatar, handleNewGravatar } from "../../src/gravity"
import { store } from "@graphprotocol/graph-ts"

afterAll(() => {
  store.remove("Gravatar", "0x0")
  ...
})

describe("handleNewGravatar, () => {
  test("creates Gravatar with id 0x0", () => {
    ...
  })
})

describe("handleUpdatedGravatar", () => {
  test("updates Gravatar with id 0x0", () => {
    ...
  })
})
```

`afterAll`å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æœ€åˆã®è¨˜è¿°ãƒ–ãƒ­ãƒƒã‚¯ã®ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã®å¾Œã«ä¸€åº¦ã ã‘å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, afterAll, clearStore } from "matchstick-as/assembly/index"
import { handleUpdatedGravatar, handleNewGravatar } from "../../src/gravity"

describe("handleNewGravatar", () => {
    afterAll(() => {
    store.remove("Gravatar", "0x1")
    ...
    })

  test("It creates a new entity with Id 0x0", () => {
    ...
  })

  test("It creates a new entity with Id 0x1", () => {
    ...
  })
})

describe("handleUpdatedGravatar", () => {
  test("updates Gravatar with id 0x0", () => {
    ...
  })
})
```

---

### beforeEach()

å„ãƒ†ã‚¹ãƒˆã®å‰ã«ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚‚ã— `beforeEach` ãŒ `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§å®£è¨€ã•ã‚ŒãŸå ´åˆã€ãã® `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã®å„ãƒ†ã‚¹ãƒˆã®å‰ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¾‹ `beforeEach` å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€å„ãƒ†ã‚¹ãƒˆã®å‰ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, beforeEach, clearStore } from "matchstick-as/assembly/index"
import { handleNewGravatars } from "./utils"

beforeEach(() => {
  clearStore() // <-- clear the store before each test in the file
})

describe("handleNewGravatars, () => {
  test("A test that requires a clean store", () => {
    ...
  })

  test("Second that requires a clean store", () => {
    ...
  })
})

 ...
```

`beforeEach`å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ãã®è¨˜è¿°ä¸­ã®å„ãƒ†ã‚¹ãƒˆã®å‰ã«ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, beforeEach } from 'matchstick-as/assembly/index'
import { handleUpdatedGravatar, handleNewGravatar } from '../../src/gravity'

describe('handleUpdatedGravatars', () => {
  beforeEach(() => {
    let gravatar = new Gravatar('0x0')
    gravatar.displayName = 'First Gravatar'
    gravatar.imageUrl = ''
    gravatar.save()
  })

  test('Upates the displayName', () => {
    assert.fieldEquals('Gravatar', '0x0', 'displayName', 'First Gravatar')

    // code that should update the displayName to 1st Gravatar

    assert.fieldEquals('Gravatar', '0x0', 'displayName', '1st Gravatar')
    store.remove('Gravatar', '0x0')
  })

  test('Updates the imageUrl', () => {
    assert.fieldEquals('Gravatar', '0x0', 'imageUrl', '')

    // code that should changes the imageUrl to https://www.gravatar.com/avatar/0x0

    assert.fieldEquals('Gravatar', '0x0', 'imageUrl', 'https://www.gravatar.com/avatar/0x0')
    store.remove('Gravatar', '0x0')
  })
})
```

---

### afterEach()

å„ãƒ†ã‚¹ãƒˆã®å¾Œã«ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã‚‚ã— `afterEach` ãŒ `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§å®£è¨€ã•ã‚Œã¦ã„ã‚Œã°ã€ãã® `describe` ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã®å„ãƒ†ã‚¹ãƒˆã®å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ä¾‹:

`afterEach`å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€å„ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, beforeEach, afterEach } from "matchstick-as/assembly/index"
import { handleUpdatedGravatar, handleNewGravatar } from "../../src/gravity"

beforeEach(() => {
  let gravatar = new Gravatar("0x0")
  gravatar.displayName = â€œFirst Gravatarâ€
  gravatar.save()
})

afterEach(() => {
  store.remove("Gravatar", "0x0")
})

describe("handleNewGravatar", () => {
  ...
})

describe("handleUpdatedGravatar", () => {
  test("Upates the displayName", () => {
     assert.fieldEquals("Gravatar", "0x0", "displayName", "First Gravatar")

    // code that should update the displayName to 1st Gravatar

    assert.fieldEquals("Gravatar", "0x0", "displayName", "1st Gravatar")
  })

  test("Updates the imageUrl", () => {
    assert.fieldEquals("Gravatar", "0x0", "imageUrl", "")

    // code that should changes the imageUrl to https://www.gravatar.com/avatar/0x0

    assert.fieldEquals("Gravatar", "0x0", "imageUrl", "https://www.gravatar.com/avatar/0x0")
  })
})
```

`afterEach`å†…ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ãã®è¨˜è¿°ã®å„ãƒ†ã‚¹ãƒˆã®å¾Œã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```typescript
import { describe, test, beforeEach, afterEach } from "matchstick-as/assembly/index"
import { handleUpdatedGravatar, handleNewGravatar } from "../../src/gravity"

describe("handleNewGravatar", () => {
  ...
})

describe("handleUpdatedGravatar", () => {
  beforeEach(() => {
    let gravatar = new Gravatar("0x0")
    gravatar.displayName = "First Gravatar"
    gravatar.imageUrl = ""
    gravatar.save()
  })

  afterEach(() => {
    store.remove("Gravatar", "0x0")
  })

  test("Upates the displayName", () => {
     assert.fieldEquals("Gravatar", "0x0", "displayName", "First Gravatar")

    // code that should update the displayName to 1st Gravatar

    assert.fieldEquals("Gravatar", "0x0", "displayName", "1st Gravatar")
  })

  test("Updates the imageUrl", () => {
    assert.fieldEquals("Gravatar", "0x0", "imageUrl", "")

    // code that should changes the imageUrl to https://www.gravatar.com/avatar/0x0

    assert.fieldEquals("Gravatar", "0x0", "imageUrl", "https://www.gravatar.com/avatar/0x0")
  })
})
```

## ã‚¢ã‚µãƒ¼ãƒˆ

```typescript
fieldEquals(entityType: string, id: string, fieldName: string, expectedVal: string)

equals(expected: ethereum.Value, actual: ethereum.Value)

notInStore(entityType: string, id: string)

addressEquals(address1: Address, address2: Address)

bytesEquals(bytes1: Bytes, bytes2: Bytes)

i32Equals(number1: i32, number2: i32)

bigIntEquals(bigInt1: BigInt, bigInt2: BigInt)

booleanEquals(bool1: boolean, bool2: boolean)

stringEquals(string1: string, string2: string)

arrayEquals(array1: Array<ethereum.Value>, array2: Array<ethereum.Value>)

tupleEquals(tuple1: ethereum.Tuple, tuple2: ethereum.Tuple)

assertTrue(value: boolean)

assertNull<T>(value: T)

assertNotNull<T>(value: T)

entityCount(entityType: string, expectedCount: i32)
```

## å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

[Demo Subgraph](https://github.com/LimeChain/demo-subgraph/blob/main/src/gravity.ts) ã«ã‚ã‚‹ Gravatar ã®ä¾‹ã‚’ä½¿ã£ã¦ã€ç°¡å˜ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒã©ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

æ¬¡ã®ã‚ˆã†ãªãƒãƒ³ãƒ‰ãƒ©é–¢æ•°ãŒã‚ã‚‹ã¨ã—ã¾ã™ï¼ˆã•ã‚‰ã«ã€ç”Ÿæ´»ã‚’ä¾¿åˆ©ã«ã™ã‚‹ãŸã‚ã®2ã¤ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚‚ã‚ã‚Šã¾ã™ï¼‰ã€‚

```typescript
export function handleNewGravatar(event: NewGravatar): void {
  let gravatar = new Gravatar(event.params.id.toHex())
  gravatar.owner = event.params.owner
  gravatar.displayName = event.params.displayName
  gravatar.imageUrl = event.params.imageUrl
  gravatar.save()
}

export function handleNewGravatars(events: NewGravatar[]): void {
  events.forEach((event) => {
    handleNewGravatar(event)
  })
}

export function createNewGravatarEvent(
  id: i32,
  ownerAddress: string,
  displayName: string,
  imageUrl: string,
): NewGravatar {
  let mockEvent = newMockEvent()
  let newGravatarEvent = new NewGravatar(
    mockEvent.address,
    mockEvent.logIndex,
    mockEvent.transactionLogIndex,
    mockEvent.logType,
    mockEvent.block,
    mockEvent.transaction,
    mockEvent.parameters,
  )
  newGravatarEvent.parameters = new Array()
  let idParam = new ethereum.EventParam('id', ethereum.Value.fromI32(id))
  let addressParam = new ethereum.EventParam(
    'ownderAddress',
    ethereum.Value.fromAddress(Address.fromString(ownerAddress)),
  )
  let displayNameParam = new ethereum.EventParam('displayName', ethereum.Value.fromString(displayName))
  let imageUrlParam = new ethereum.EventParam('imageUrl', ethereum.Value.fromString(imageUrl))

  newGravatarEvent.parameters.push(idParam)
  newGravatarEvent.parameters.push(addressParam)
  newGravatarEvent.parameters.push(displayNameParam)
  newGravatarEvent.parameters.push(imageUrlParam)

  return newGravatarEvent
}
```

ã¾ãšã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€ãã®ã‚ˆã†ãªä¾‹ã§ã™ï¼š

```typescript
import { clearStore, test, assert } from 'matchstick-as/assembly/index'
import { Gravatar } from '../../generated/schema'
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { createNewGravatarEvent, handleNewGravatars } from '../mappings/gravity'

test('Can call mappings with custom events', () => {
  // Create a test entity and save it in the store as initial state (optional)
  let gravatar = new Gravatar('gravatarId0')
  gravatar.save()

  // Create mock events
  let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')
  let anotherGravatarEvent = createNewGravatarEvent(3546, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

  // Call mapping functions passing the events we just created
  handleNewGravatars([newGravatarEvent, anotherGravatarEvent])

  // Assert the state of the store
  assert.fieldEquals('Gravatar', 'gravatarId0', 'id', 'gravatarId0')
  assert.fieldEquals('Gravatar', '12345', 'owner', '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
  assert.fieldEquals('Gravatar', '3546', 'displayName', 'cap')

  // Clear the store in order to start the next test off on a clean slate
  clearStore()
})

test('Next test', () => {
  //...
})
```

ã“ã®ã‚ˆã†ã«æ§˜ã€…ãªå½¢ã§ç´è§£ã„ã¦ã¿ã¾ã—ãŸã€‚ã¾ãšæœ€åˆã«ã€é‡è¦ãªã“ã¨ã¯ã€AssemblyScript ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ `matchstick-as` ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã“ã¨ã§ã™ (npm ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦é…å¸ƒã•ã‚Œã¦ã„ã¾ã™)ã€‚ãƒªãƒã‚¸ãƒˆãƒªã¯[ã“ã¡ã‚‰](https://github.com/LimeChain/matchstick-as)ã«ã‚ã‚Šã¾ã™ã€‚`matchstick-as` ã¯ä¾¿åˆ©ãªãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã€ãƒ†ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ `test()` é–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚æ®‹ã‚Šã®éƒ¨åˆ†ã¯ã¨ã¦ã‚‚ç°¡å˜ã§ã€æ¬¡ã®ã‚ˆã†ãªã“ã¨ãŒèµ·ã“ã‚Šã¾ã™ã€‚

- åˆæœŸçŠ¶æ…‹ã‚’è¨­å®šã—ã€ã‚«ã‚¹ã‚¿ãƒ Gravatarã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’1ã¤è¿½åŠ ã—ã¦ã„ã¾ã™ï¼›
- `createNewGravatarEvent()` é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€2 ã¤ã® `NewGravatar` ã‚¤ãƒ™ãƒ³ãƒˆ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ãã‚Œã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®šç¾©ã—ã¾ã™ã€‚
- ã“ã‚Œã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¡ã‚½ãƒƒãƒ‰ - `handleNewGravatars()` ã‚’å‘¼ã³å‡ºã—ã€ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒˆã‚’æ¸¡ã—ã¦ã„ã¾ã™ï¼›
- storeã®çŠ¶æ…‹ã‚’ã‚¢ã‚µãƒ¼ãƒˆã™ã‚‹å ´åˆã€ã“ã‚Œã¯ã©ã®ã‚ˆã†ã«è¡Œã‚ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚- Entityã®ç¨®é¡ã¨idã®ä¸€æ„ã®çµ„ã¿åˆã‚ã›ã‚’æ¸¡ã—ã¾ã™ã€‚ãã—ã¦ã€ãã®Entityã®ç‰¹å®šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æœŸå¾…é€šã‚Šã®å€¤ã‚’æŒã£ã¦ã„ã‚‹ã“ã¨ã‚’è¡¨æ˜ã—ã¾ã™ã€‚ã“ã‚Œã¯storeã«è¿½åŠ ã—ãŸæœ€åˆã® Gravatar Entity ã¨ã€ãƒãƒ³ãƒ‰ãƒ©é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«è¿½åŠ ã•ã‚Œã‚‹ 2 ã¤ã® Gravatar Entity ã®ä¸¡æ–¹ã«å¯¾ã—ã¦è¡Œã£ã¦ã„ã‚‹ã®ã§ã™ã€‚
- æœ€å¾Œã«ã€`clearStore()`ã‚’ä½¿ã£ã¦ã‚¹ãƒˆã‚¢ã‚’æƒé™¤ã—ã€æ¬¡ã®ãƒ†ã‚¹ãƒˆãŒæ–°é®®ã§ç©ºã®ã‚¹ãƒˆã‚¢ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å§‹ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã¯å¿…è¦ã«å¿œã˜ã¦ã„ãã¤ã§ã‚‚å®šç¾©ã§ãã¾ã™ã€‚

ã“ã‚Œã§æœ€åˆã®ãƒ†ã‚¹ãƒˆãŒå®Œæˆã—ã¾ã—ãŸ! ğŸ‘

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ã‚µãƒ–ã‚°ãƒ©ãƒ•ã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

`gravityã®ãƒ†ã‚¹ãƒˆ`

ã™ã¹ã¦ãŒã†ã¾ãã„ãã¨ã€ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

![ã€Œã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ã¾ã—ãŸï¼ã€ã¨ã„ã†ãƒãƒƒãƒæ£’](/img/matchstick-tests-passed.png)

## ä¸€èˆ¬çš„ãªãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### ç‰¹å®šã®çŠ¶æ…‹ã§åº—èˆ—ã‚’æ½¤ã™

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€æ—¢çŸ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ã‚»ãƒƒãƒˆã§ã‚¹ãƒˆã‚¢ã‚’ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€Gravatarã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã‚¹ãƒˆã‚¢ã‚’åˆæœŸåŒ–ã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š

```typescript
let gravatar = new Gravatar('entryId')
gravatar.save()
```

### ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã£ãŸãƒãƒƒãƒ”ãƒ³ã‚°é–¢æ•°ã®å‘¼ã³å‡ºã—

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãã‚Œã‚’ã‚¹ãƒˆã‚¢ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸãƒãƒƒãƒ”ãƒ³ã‚°é–¢æ•°ã«æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ï¼š

```typescript
import { store } from 'matchstick-as/assembly/store'
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { handleNewGravatars, createNewGravatarEvent } from './mapping'

let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

handleNewGravatar(newGravatarEvent)
```

### ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã§ã™ã¹ã¦ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‘¼ã³å‡ºã™

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã§ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { store } from 'matchstick-as/assembly/store'
import { handleNewGravatars, createNewGravatarEvent } from './mapping'

let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

let anotherGravatarEvent = createNewGravatarEvent(3546, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

handleNewGravatars([newGravatarEvent, anotherGravatarEvent])
```

```
export function handleNewGravatars(events: NewGravatar[]): void {
    events.forEach(event => {
        handleNewGravatar(event);
    });
}
```

### ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚³ãƒ¼ãƒ«ã®ãƒ¢ãƒƒã‚¯

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚³ãƒ¼ãƒ«ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```typescript
import { addMetadata, assert, createMockedFunction, clearStore, test } from 'matchstick-as/assembly/index'
import { Gravity } from '../../generated/Gravity/Gravity'
import { Address, BigInt, ethereum } from '@graphprotocol/graph-ts'

let contractAddress = Address.fromString('0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
let expectedResult = Address.fromString('0x90cBa2Bbb19ecc291A12066Fd8329D65FA1f1947')
let bigIntParam = BigInt.fromString('1234')
createMockedFunction(contractAddress, 'gravatarToOwner', 'gravatarToOwner(uint256):(address)')
  .withArgs([ethereum.Value.fromSignedBigInt(bigIntParam)])
  .returns([ethereum.Value.fromAddress(Address.fromString('0x90cBa2Bbb19ecc291A12066Fd8329D65FA1f1947'))])

let gravity = Gravity.bind(contractAddress)
let result = gravity.gravatarToOwner(bigIntParam)

assert.equals(ethereum.Value.fromAddress(expectedResult), ethereum.Value.fromAddress(result))
```

ã“ã®ã‚ˆã†ã«ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®å‘¼ã³å‡ºã—ã¨æˆ»ã‚Šå€¤ã‚’ãƒãƒ¼ãƒ‰ã‚³ã‚¢åŒ–ã™ã‚‹ãŸã‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã€é–¢æ•°åã€é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã€å¼•æ•°ã®é…åˆ—ã€ãã—ã¦ã‚‚ã¡ã‚ã‚“æˆ»ã‚Šå€¤ã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š

```typescript
let contractAddress = Address.fromString('0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
createMockedFunction(contractAddress, 'getGravatar', 'getGravatar(address):(string,string)')
  .withArgs([ethereum.Value.fromAddress(contractAddress)])
  .reverts()
```

### Mocking IPFS files (from matchstick 0.4.1)

`mockIpfsFile(hash, filePath)`é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€IPFSãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚æœ€åˆã®å¼•æ•°ã¯IPFSãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥/ãƒ‘ã‚¹ã€2ç•ªç›®ã®å¼•æ•°ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã§ã™ã€‚

æ³¨æ„: `ipfs.map/ipfs.mapJSON` ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨ãã€ä¸‹è¨˜ã®ãƒ†ã‚¹ãƒˆä¾‹ã® `processGravatar()` é–¢æ•°ã®ã‚ˆã†ã«ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¯ matchstck ãŒãã‚Œã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

`.test.ts` file:

```typescript
import { assert, test, mockIpfsFile } from 'matchstick-as/assembly/index'
import { ipfs } from '@graphprotocol/graph-ts'
import { gravatarFromIpfs } from './utils'

// Export ipfs.map() callback in order for matchstck to detect it
export { processGravatar } from './utils'

test('ipfs.cat', () => {
  mockIpfsFile('ipfsCatfileHash', 'tests/ipfs/cat.json')

  assert.entityCount(GRAVATAR_ENTITY_TYPE, 0)

  gravatarFromIpfs()

  assert.entityCount(GRAVATAR_ENTITY_TYPE, 1)
  assert.fieldEquals(GRAVATAR_ENTITY_TYPE, '1', 'imageUrl', 'https://i.ytimg.com/vi/MELP46s8Cic/maxresdefault.jpg')

  clearStore()
})

test('ipfs.map', () => {
  mockIpfsFile('ipfsMapfileHash', 'tests/ipfs/map.json')

  assert.entityCount(GRAVATAR_ENTITY_TYPE, 0)

  ipfs.map('ipfsMapfileHash', 'processGravatar', Value.fromString('Gravatar'), ['json'])

  assert.entityCount(GRAVATAR_ENTITY_TYPE, 3)
  assert.fieldEquals(GRAVATAR_ENTITY_TYPE, '1', 'displayName', 'Gravatar1')
  assert.fieldEquals(GRAVATAR_ENTITY_TYPE, '2', 'displayName', 'Gravatar2')
  assert.fieldEquals(GRAVATAR_ENTITY_TYPE, '3', 'displayName', 'Gravatar3')
})
```

`.utils.ts` file:

```typescript
import { Address, ethereum, JSONValue, Value, ipfs, json, Bytes } from "@graphprotocol/graph-ts"
import { Gravatar } from "../../generated/schema"

...

// ipfs.map callback
export function processGravatar(value: JSONValue, userData: Value): void {
  // See the JSONValue documentation for details on dealing
  // with JSON values
  let obj = value.toObject()
  let id = obj.get('id')

  if (!id) {
    return
  }

  // Callbacks can also created entities
  let gravatar = new Gravatar(id.toString())
  gravatar.displayName = userData.toString() + id.toString()
  gravatar.save()
}

// function that calls ipfs.cat
export function gravatarFromIpfs(): void {
  let rawData = ipfs.cat("ipfsCatfileHash")

  if (!rawData) {
    return
  }

  let jsonData = json.fromBytes(rawData as Bytes).toObject()

  let id = jsonData.get('id')
  let url = jsonData.get("imageUrl")

  if (!id || !url) {
    return
  }

  let gravatar = new Gravatar(id.toString())
  gravatar.imageUrl = url.toString()
  gravatar.save()
}
```

### ã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹ã‚’ã‚¢ã‚µãƒ¼ãƒˆã™ã‚‹

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ã‚¢ã‚µãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒˆã‚¢ã®æœ€çµ‚çš„ãªçŠ¶æ…‹ï¼ˆã¾ãŸã¯é€”ä¸­ã®çŠ¶æ…‹ï¼‰ã‚’ã‚¢ã‚µãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç‰¹å®šã® IDã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœŸå¾…å€¤ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã«ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š

```typescript
import { assert } from 'matchstick-as/assembly/index'
import { Gravatar } from '../generated/schema'

let gravatar = new Gravatar('gravatarId0')
gravatar.save()

assert.fieldEquals('Gravatar', 'gravatarId0', 'id', 'gravatarId0')
```

Assert.fieldEquals()é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæŒ‡å®šã•ã‚ŒãŸæœŸå¾…å€¤ã¨ç­‰ã—ã„ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚å€¤ãŒ**ç­‰ã—ããªã„** å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆã¯æ­£å¸¸ã«é€šéã—ã¾ã™ã€‚

### ã‚¤ãƒ™ãƒ³ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã®ã‚„ã‚Šã¨ã‚Š

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€`newMockEvent()`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ ethereum.Eventã¨ã—ã¦è¿”ã•ã‚Œã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã“ã‚Œã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èª­ã¿æ›¸ãã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š

```typescript
// Read
let logType = newGravatarEvent.logType

// Write
let UPDATED_ADDRESS = '0xB16081F360e3847006dB660bae1c6d1b2e17eC2A'
newGravatarEvent.address = Address.fromString(UPDATED_ADDRESS)
```

### å¤‰æ•°ã®ç­‰å€¤æ€§ã®ä¸»å¼µ

```typescript
assert.equals(ethereum.Value.fromString("hello"); ethereum.Value.fromString("hello"));
```

### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚¹ãƒˆã‚¢ã«**ãªã„**ã“ã¨ã‚’ã‚¢ã‚µãƒ¼ãƒˆã™ã‚‹

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã‚ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚¹ãƒˆã‚¢ã«å­˜åœ¨ã—ãªã„ã“ã¨ã‚’ã‚¢ã‚µãƒ¼ãƒˆã§ãã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã¨ id ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå®Ÿéš›ã«ã‚¹ãƒˆã‚¢å†…ã«ã‚ã‚‹å ´åˆã€ãƒ†ã‚¹ãƒˆã¯é–¢é€£ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦å¤±æ•—ã—ã¾ã™ã€‚ã“ã®æ©Ÿèƒ½ã‚’ä½¿ã£ãŸç°¡å˜ãªä¾‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ï¼š

```typescript
assert.notInStore('Gravatar', '23')
```

### ã‚¹ãƒˆã‚¢å…¨ä½“ã‚’å°åˆ·ã™ã‚‹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

ã“ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½¿ã£ã¦ã€ã‚¹ãƒˆã‚¢å…¨ä½“ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```typescript
import { logStore } from 'matchstick-as/assembly/store'

logStore()
```

### äºˆæƒ³ã•ã‚Œã‚‹ä¸å…·åˆ

Test() é–¢æ•°ã®shouldFailãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ã‚¹ãƒˆã®å¤±æ•—ã‚’äºˆæƒ³ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```typescript
test(
  'Should throw an error',
  () => {
    throw new Error()
  },
  true,
)
```

ShouldFail = true ã¨ãƒãƒ¼ã‚¯ã•ã‚Œã¦ã„ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã¯ã€ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã€ãƒ†ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã¯å¤±æ•—ã—ã¾ã™ã€‚ã¾ãŸã€shouldFail = false (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹) ã¨è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œè€…ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

### ãƒ­ã‚®ãƒ³ã‚°

ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°ã‚’æŒãŸã›ã‚‹ã“ã¨ã¯ã€ãƒãƒƒãƒ”ãƒ³ã‚°ã«ãƒ­ã‚°ã‚’æŒãŸã›ã‚‹ã“ã¨ã¨å…¨ãåŒã˜ã§ã™ã€‚é•ã„ã¯ã€ãƒ­ã‚°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’graph-tsã§ã¯ãªãmatchstick-asã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚ä»¥ä¸‹ã¯ã€ã™ã¹ã¦ã®éé‡è¦ãªãƒ­ã‚°ã‚¿ã‚¤ãƒ—ã‚’ä½¿ã£ãŸç°¡å˜ãªä¾‹ã§ã™ï¼š

```typescript
import { test } from "matchstick-as/assembly/index";
import { log } from "matchstick-as/assembly/log";

test("Success", () => {
    log.success("Success!". []);
});
test("Error", () => {
    log.error("Error :( ", []);
});
test("Debug", () => {
    log.debug("Debugging...", []);
});
test("Info", () => {
    log.info("Info!", []);
});
test("Warning", () => {
    log.warning("Warning!", []);
});
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€ã“ã®ã‚ˆã†ã«è‡´å‘½çš„ãªå¤±æ•—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼š

```typescript
test('Blow everything up', () => {
  log.critical('Boom!')
})
```

ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¨ãƒ©ãƒ¼ã®ãƒ­ã‚°ã‚’å–ã‚‹ã¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡ŒãŒæ­¢ã¾ã‚Šã€ã™ã¹ã¦ãŒé£›ã‚“ã§ã—ã¾ã„ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã«é‡è¦ãªãƒ­ã‚°ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèªã—ã€ã‚‚ã—ç™ºç”Ÿã—ãŸå ´åˆã«ã¯ã™ãã«æ°—ä»˜ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### æ´¾ç”Ÿãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ†ã‚¹ãƒˆ

æ´¾ç”Ÿãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ†ã‚¹ãƒˆã¯ã€ï¼ˆä»¥ä¸‹ã®ä¾‹ã§ç¤ºã™ã‚ˆã†ã«ï¼‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¨­å®šã—ã€ãã‚ŒãŒæœ€åˆã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®1ã¤ã‚’æ´¾ç”Ÿã—ã¦ã„ã‚‹å ´åˆã€åˆ¥ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚é‡è¦ãªã®ã¯ã€è‡ªå‹•æ›´æ–°ã¯ASã‚³ãƒ¼ãƒ‰ãŒä¸å¯çŸ¥è«–ã§ã‚ã‚‹éŒ†ã®ã‚¹ãƒˆã‚¢å†…ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€æœ€åˆã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯å†ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚

```typescript
test('Derived fields example test', () => {
  let mainAccount = new GraphAccount('12')
  mainAccount.save()
  let operatedAccount = new GraphAccount('1')
  operatedAccount.operators = ['12']
  operatedAccount.save()
  let nst = new NameSignalTransaction('1234')
  nst.signer = '12'
  nst.save()

  assert.assertNull(mainAccount.get('nameSignalTransactions'))
  assert.assertNull(mainAccount.get('operatorOf'))

  mainAccount = GraphAccount.load('12')!

  assert.i32Equals(1, mainAccount.nameSignalTransactions.length)
  assert.stringEquals('1', mainAccount.operatorOf[0])
})
```

### å‹•çš„ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ

å‹•çš„ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆã¯ã€dataSource åå‰ç©ºé–“ã® `context()`, `address()`, `network()` é–¢æ•°ã®æˆ»ã‚Šå€¤ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šè¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®é–¢æ•°ã¯ç¾åœ¨ã€ä»¥ä¸‹ã®ã‚‚ã®ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚`context()` - ç©ºã®å®Ÿä½“ (DataSourceContext) ã‚’è¿”ã™ã€ `address()` - `0x000000000000000000000000` ã‚’è¿”ã™ã€ `network()` - `mainnet` ã‚’è¿”ã™ã€ã§ã™ã€‚`create(...)`ã¨`createWithContext(...)`é–¢æ•°ã¯ä½•ã‚‚ã—ãªã„ã‚ˆã†ã«ãƒ¢ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆã®ä¸­ã§å‘¼ã°ã‚Œã‚‹å¿…è¦ã¯å…¨ããªã„ã§ã—ã‚‡ã†ã€‚æˆ»ã‚Šå€¤ã®å¤‰æ›´ã¯ `matchstick-as` (version 0.3.0+) ã® `dataSourceMock` åå‰ç©ºé–“ã®é–¢æ•°ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ãã®ä¾‹ã§ã™ï¼š

ã¾ãšã€æ¬¡ã®ã‚ˆã†ãªã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ç”¨æ„ã—ã¾ã™ (ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ãƒ¢ãƒƒã‚­ãƒ³ã‚°ã‚’ç´¹ä»‹ã™ã‚‹ãŸã‚ã«æ„å›³çš„ã«å†åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™)ï¼š

```typescript
export function handleApproveTokenDestinations(event: ApproveTokenDestinations): void {
  let tokenLockWallet = TokenLockWallet.load(dataSource.address().toHexString())!
  if (dataSource.network() == 'rinkeby') {
    tokenLockWallet.tokenDestinationsApproved = true
  }
  let context = dataSource.context()
  if (context.get('contextVal')!.toI32() > 0) {
    tokenLockWallet.setBigInt('tokensReleased', BigInt.fromI32(context.get('contextVal')!.toI32()))
  }
  tokenLockWallet.save()
}
```

ãã—ã¦ã€dataSourceMock namespaceã®ãƒ¡ã‚½ãƒƒãƒ‰ã®1ã¤ã‚’ä½¿ç”¨ã—ã¦ã€ã™ã¹ã¦ã®dataSourceé–¢æ•°ã«æ–°ã—ã„æˆ»ã‚Šå€¤ã‚’è¨­å®šã™ã‚‹ãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ï¼š

```typescript
import { assert, test, newMockEvent, dataSourceMock } from 'matchstick-as/assembly/index'
import { BigInt, DataSourceContext, Value } from '@graphprotocol/graph-ts'

import { handleApproveTokenDestinations } from '../../src/token-lock-wallet'
import { ApproveTokenDestinations } from '../../generated/templates/GraphTokenLockWallet/GraphTokenLockWallet'
import { TokenLockWallet } from '../../generated/schema'

test('Data source simple mocking example', () => {
  let addressString = '0xA16081F360e3847006dB660bae1c6d1b2e17eC2A'
  let address = Address.fromString(addressString)

  let wallet = new TokenLockWallet(address.toHexString())
  wallet.save()
  let context = new DataSourceContext()
  context.set('contextVal', Value.fromI32(325))
  dataSourceMock.setReturnValues(addressString, 'rinkeby', context)
  let event = changetype<ApproveTokenDestinations>(newMockEvent())

  assert.assertTrue(!wallet.tokenDestinationsApproved)

  handleApproveTokenDestinations(event)

  wallet = TokenLockWallet.load(address.toHexString())!
  assert.assertTrue(wallet.tokenDestinationsApproved)
  assert.bigIntEquals(wallet.tokensReleased, BigInt.fromI32(325))

  dataSourceMock.resetValues()
})
```

æœ€å¾Œã«dataSourceMock.resetValues()ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€å€¤ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨è¨˜æ†¶ã•ã‚Œã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å€¤ã«æˆ»ã—ãŸã„å ´åˆã¯ãƒªã‚»ãƒƒãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚

## ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

Using **Matchstick**, subgraph developers are able to run a script that will calculate the test coverage of the written unit tests.

The test coverage tool takes the compiled test `wasm` binaries and converts them to `wat` files, which can then be easily inspected to see whether or not the handlers defined in `subgraph.yaml` have been called. Since code coverage (and testing as whole) is in very early stages in AssemblyScript and WebAssembly, **Matchstick** cannot check for branch coverage. Instead we rely on the assertion that if a given handler has been called, the event/function for it have been properly mocked.

### å‰ææ¡ä»¶

**Matchstick** ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ©Ÿèƒ½ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€äº‹å‰ã«æº–å‚™ã—ã¦ãŠãã“ã¨ãŒã„ãã¤ã‹ã‚ã‚Šã¾ã™ï¼š

#### ãƒãƒ³ãƒ‰ãƒ©ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

**Matchstick** ãŒã©ã®ãƒãƒ³ãƒ‰ãƒ©ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«ã€ãã‚Œã‚‰ã®ãƒãƒ³ãƒ‰ãƒ©ã¯ **test file** ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã“ã®ä¾‹ã§ã¯ã€gravity.test.ts ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¬¡ã®ãƒãƒ³ãƒ‰ãƒ©ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ï¼š

```typescript
import { handleNewGravatar } from '../../src/gravity'
```

ãã®é–¢æ•°ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆ`wat`ãƒ•ã‚¡ã‚¤ãƒ«**åå‰**ã«å«ã‚ã‚‹ï¼‰ã«ã¯ã€æ¬¡ã®ã‚ˆã†ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚‚å¿…è¦ã§ã™ã€‚

```typescript
export { handleNewGravatar }
```

### ä½¿ã„æ–¹

è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å®Ÿè¡Œã—ã¾ã™ï¼š

```sh
graph test -- -c
```

æ¬¡ã®ã‚ˆã†ã«ã€ã‚«ã‚¹ã‚¿ãƒ ã® `coverage` ã‚³ãƒãƒ³ãƒ‰ã‚’ `package.json` ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```typescript
 "scripts": {
    /.../
    "coverage": "graph test -- -c"
  },
```

That will execute the coverage tool and you should see something like this in the terminal:

```sh
$ graph test -c
Skipping download/install step because binary already exists at /Users/petko/work/demo-subgraph/node_modules/binary-install-raw/bin/0.4.0

___  ___      _       _         _   _      _
|  \/  |     | |     | |       | | (_)    | |
| .  . | __ _| |_ ___| |__  ___| |_ _  ___| | __
| |\/| |/ _` | __/ __| '_ \/ __| __| |/ __| |/ /
| |  | | (_| | || (__| | | \__ \ |_| | (__|   <
\_|  |_/\__,_|\__\___|_| |_|___/\__|_|\___|_|\_\

Compiling...

Running in coverage report mode.
 ï¸
Reading generated test modules... ğŸ”ï¸

Generating coverage report ğŸ“

Handlers for source 'Gravity':
Handler 'handleNewGravatar' is tested.
Handler 'handleUpdatedGravatar' is not tested.
Handler 'handleCreateGravatar' is tested.
Test coverage: 66.7% (2/3 handlers).

Handlers for source 'GraphTokenLockWallet':
Handler 'handleTokensReleased' is not tested.
Handler 'handleTokensWithdrawn' is not tested.
Handler 'handleTokensRevoked' is not tested.
Handler 'handleManagerUpdated' is not tested.
Handler 'handleApproveTokenDestinations' is not tested.
Handler 'handleRevokeTokenDestinations' is not tested.
Test coverage: 0.0% (0/6 handlers).

Global test coverage: 22.2% (2/9 handlers).
```

### ãƒ­ã‚°å‡ºåŠ›ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®è¡¨ç¤º

ãƒ­ã‚°å‡ºåŠ›ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ä»¥ä¸‹ã¯ãã®ä¾‹ã§ã™ï¼š

`[Thu, 31 Mar 2022 13:54:54 +0300] Program executed in: 42.270ms.`

## ä¸€èˆ¬çš„ãªã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã‚¨ãƒ©ãƒ¼

> Critical: æœ‰åŠ¹ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ WasmInstance ã‚’ä½œæˆã§ããªã„ã€‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒä¸æ˜ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: wasi_snapshot_preview1::fd_write ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„

ã“ã‚Œã¯ã€ã‚³ãƒ¼ãƒ‰å†…ã§`console.log`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã€AssemblyScriptã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚[Logging API](/developing/assemblyscript-api/#logging-api) ã®åˆ©ç”¨ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚

> ERROR TS2554: æœŸå¾…ã•ã‚ŒãŸå¼•æ•°ã¯?
>
> return new ethereum.Block(defaultAddressBytes, defaultAddressBytes, defaultAddressBytes, defaultAddress, defaultAddressBytes, defaultAddressBytes, defaultAddressBytes, defaultBigInt, defaultBigInt, defaultBigInt, defaultBigInt, defaultBigInt, defaultBigInt, defaultBigInt, defaultBigInt);
>
> in ~lib/matchstick-as/assembly/defaults.ts(18,12)
>
> ERROR TS2554: æœŸå¾…ã•ã‚ŒãŸå¼•æ•°ã¯?
>
> return new ethereum.Transaction(defaultAddressBytes, defaultBigInt, defaultAddress, defaultAddress, defaultBigInt, defaultBigInt, defaultBigInt, defaultAddressBytes, defaultBigInt);
>
> in ~lib/matchstick-as/assembly/defaults.ts(24,12)

å¼•æ•°ã®ä¸ä¸€è‡´ã¯ã€`graph-ts`ã¨`matchstick-as`ã®ä¸ä¸€è‡´ã«ã‚ˆã£ã¦èµ·ã“ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå•é¡Œã‚’è§£æ±ºã™ã‚‹æœ€å–„ã®æ–¹æ³•ã¯ã€ã™ã¹ã¦ã‚’æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ç‰ˆã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚

## ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

è³ªå•ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãªã©ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€The Graph Discordã«Matchstickå°‚ç”¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ğŸ”¥| unit-testing ãŒã‚ã‚Šã¾ã™ã®ã§ã€ãã¡ã‚‰ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
