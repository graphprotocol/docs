---
title: 既存のサブグラフをグラフネットワークに移行する
---

## イントロダクション

これは、サブグラフをホスティングサービスからThe Graphの分散型ネットワークに移行する方法について説明したガイドです。The Graph Networkへの移行は、Opyn, UMA, mStable, Audius, PoolTogether, Livepeer, RAI, Enzyme, DODO, Opyn, Pickle, BadgerDAOなどのプロジェクトで成功し、これらはすべてネットワーク上のインデクサーが提供するデータに依存しています。現在、The Graph Networkでは700以上のサブグラフが稼動しており、クエリフィーを生成し、Web3データのインデックス作成を積極的に行っています。

これで、分散型ネットワークへの移行やサブグラフの管理方法について、必要なことがすべてわかるようになります。移行作業は短時間で完了し、サブグラフは The Graph Network ならではの信頼性とパフォーマンスを永遠に享受することができます。

### 仮定

- 私はすでにホストされたサービスにサブグラフを展開しました
- サブグラフは、The Graph Networkで利用可能な（またはベータ版で利用可能な）チェーンのインデックスを作成しています。
- サブグラフはIPFSや全文検索の依存関係を持ちません（これらは分散型ネットワークではまだ完全にサポートされていません）

## 既存のサブグラフをグラフネットワークに移行する

> サブグラフに固有のコマンドは、[Subgraph Studio](https://thegraph.com/studio/)で確認することができます。

1. 最新版の graph-cli をインストールする:

```sh
npm install -g @graphprotocol/graph-cli
```

```sh
yarn global add @graphprotocol/graph-cli
```

subgraph.yamlの`apiVersion`が`0.0.5`以上であることを確認してください。

2. メイン・プロジェクトのサブグラフ・リポジトリ内で、スタジオ上でデプロイとビルドを行うためにサブグラフを認証します。

```sh
graph auth --studio <DEPLOY_KEY>
```

3. ファイルを生成し、サブグラフをビルドする:

```sh
graph codegen && graph build
```

サブグラフにビルドエラーがある場合は、[AssemblyScript Migration Guide](/release-notes/assemblyscript-migration-guide/) を参照してください。

4. ウォレットで[Subgraph Studio](https://thegraph.com/studio/)にサインインし、サブグラフをデプロイしてください。スタジオのUIで、サブグラフの名前に基づいた`<SUBGRAPH_SLUG>`を見つけることができます。

```sh
graph deploy --studio <SUBGRAPH_SLUG>
```

5. スタジオのプレイグラウンドでクエリをテストします。ここでは、[Sushi - Mainnet Exchange Subgraph](https://thegraph.com/explorer/subgraph?id=0x4bb4c1b0745ef7b4642feeccd0740dec417ca0a0-0&view=Playground)の例を示します。

```sh
{
  users(first: 5) {
    id
    liquidityPositions {
      id
    }
  }
  bundles(first: 5) {
    id
    ethPrice
  }
}
```

6. この時点で、サブグラフはSubgraph Studio上にデプロイされましたが、分散ネットワークにはまだ公開されていません。サブグラフが意図したとおりに動作しているか、右上の一時的なクエリURLを用いてテストすることができます。この名前が示すように、これは一時的なURLであり、実運用に使用すべきではありません。

- 公開はオンチェーン アクションであり、イーサリアムでガスを支払う必要があります。トランザクションの例は、[こちら](https://etherscan.io/tx/0xd0c3fa0bc035703c9ba1ce40c1862559b9c5b6ea1198b3320871d535aa0de87b)をご覧ください。 100 gwei で 0.0425 ETH。
- サブグラフをアップグレードする必要がある場合は、アップグレード料金が発生します。アップグレードとは、既存のサブグラフの別バージョンをチェーン上に公開することです。アップグレードには費用がかかりますので、メインネットにデプロイする前に、Rinkebyでサブグラフをデプロイしてテストすることを強くお勧めします。また、そのサブグラフにシグナルがない場合、場合によってはGRTが必要になることもあります。そのサブグラフのバージョンにシグナル/キュレーションがある場合（auto-migrateを使用）、税金は分割されます。

7. 「Publish」ボタンを押して、サブグラフをThe Graphの分散型ネットワーク上に公開する。

以上です！公開が完了すると、[The Graph Explorer](https://thegraph.com/explorer) を介して分散ネットワーク上でサブグラフをライブで表示できるようになります。

Discord の [#Curators チャンネル](https://discord.gg/rC8rBuRtbH) を自由に活用して、キュレーターにサブグラフが通知される準備ができていることを知らせてください。また、予想されるクエリ数を共有していただけると助かります。したがって、彼らはあなたのサブグラフでどれだけの GRT を通知する必要があるかを見積もることができます。

### APIキーの作成

APIキーは、Subgraph Studioの[こちら](https://thegraph.com/studio/apikeys/)で生成することができます。

![APIキー作成ページ](/img/api-image.png)

毎週末に、その期間に発生したクエリフィーに基づいて請求書が作成されます。この請求書は、お客様の残高にあるGRTを使用して自動的に支払われます。クエリ費用が引き落とされた後、残高が更新されます。クエリフィーは、ポリゴンネットワークを経由してGRTで支払われます。APIキーを有効にするには、以下の手順でPolygonの課金契約にGRTを追加する必要があります。

- ご希望の取引所でGRTをご購入ください。
- GRT をウォレットに送る.
- StudioのBillingページで「Add GRT」をクリックします。

![GRTを課金に追加](/img/Add-GRT-New-Page.png)

- 手順に沿って、GRTを課金バランスに追加してください。
- GRTは自動的にArbitrumのネットワークにブリッジされ、課金バランスに加算されます。

![請求ペイン](/img/New-Billing-Pane.png)

> 注意：GRTを課金バランスに追加するための詳しい説明は、[公式課金ページ](.../billing.mdx)をご覧ください。

### APIキーの確保

APIは2つの方法で利用を制限し、セキュリティを確保することが推奨されます。

1. オーソライズド・サブグラフ
2. オーソライズド・ドメイン

APIキーは[こちら](https://thegraph.com/studio/apikeys/test/)で確保することができます。

![サブグラフのロックダウンページ](/img/subgraph-lockdown.png)

### 分散ネットワーク上の自分のサブグラフをクエリ

これで、ネットワーク上のIndexersのインデックス作成状況をグラフエクスプローラで確認できます（例[こちら](https://thegraph.com/explorer/subgraph?id=S9ihna8D733WTEShJ1KctSTCvY1VJ7gdVwhUujq4Ejo&view=Indexers)）。上部の緑の線は、投稿時に8つのインデクサーがそのサブグラフのインデックス付けに成功したことを示します。また、Indexerタブでは、どのインデクサーがあなたのサブグラフをピックアップしたかを見ることができます。

![Rocket Poolのサブグラフ](/img/rocket-pool-subgraph.png)

最初のインデクサーがあなたのサブグラフを完全にインデックス化したら、分散ネットワーク上でサブグラフのクエリを開始することができます。クエリURLを取得するためには、クエリURLの横にある記号をクリックしてコピー＆ペーストしてください。以下のような画面が表示されます。

`https://gateway.thegraph.com/api/[api-key]/subgraphs/id/S9ihna8D733WTEShJ1KctSTCvY1VJ7gdVwhUujq4Ejo`

重要： `[api-key]` は、必ず上記のセクションで生成された実際の API キーに置き換えてください。

このQuery URLをダップ内で使用して、GraphQLリクエストを送信することができます。

おめでとうございます。あなたは今、分散化のパイオニアです！

> 注意: ネットワークが分散しているため、異なるインデクサーが異なるブロックまでインデックスを作成していることがあります。新鮮なデータだけを受け取るために、ブロックを使ってクエリを提供するために、 インデクサがインデックスを作成していなければならない最小のブロックを指定することができます。`{ number_gte: $minBlock }` フィールド引数で、以下の例のように指定します。

```graphql
{
  stakers(block: { number_gte: 14486109 }) {
    id
  }
}
```

ネットワークの性質や再起動の扱いについての詳細は、ドキュメントの記事[Distributed Systems](/querying/distributed-systems/)で説明されています。

## ネットワーク上のサブグラフのアップグレード

ネットワーク上の既存のサブグラフをアップグレードする場合は、Graph CLI を使用してサブグラフの新しいバージョンを Subgraph Studio にデプロイすることでこれを行うことができます。

1. 現在のサブグラフに変更を加える。Goerliに公開してSubgraph Studio上で小さな修正をテストするのが良いアイデアでしょう。
2. 以下のようにデプロイし、コマンドに新しいバージョンを指定します（例：v0.0.1、v0.0.2 など）。

```sh
graph deploy --studio <SUBGRAPH_SLUG>
```

3. Subgraph Studio のプレイグラウンドでクエリを実行し、新バージョンをテストします。
4. 新しいバージョンを The Graph Network で公開します。これにはガスが必要であることを忘れてはなりません（上のセクションで説明）。

### 所有者のアップグレード料金: 詳細

アップグレードには、旧バージョンのサブグラフから新バージョンのサブグラフへのGRTの移行が必要です。つまり、アップグレードのたびに、新しいボンディングカーブが作成されます（ボンディングカーブについての詳細は[こちら](/network/curating#bonding-curve-101)）

新しい結合曲線では、新しいバージョンに移行されるすべての GRT に対して 2.5% のキュレーション税が課されます。所有者は、この 50% または 1.25% を支払わなければなりません。残りの 1.25% は、手数料としてすべてのキュレーターによって吸収されます。サブグラフの所有者が再帰的なアップグレード呼び出しでキュレーターのすべての資金を使い果たすことができないようにするための場所です。キュレーション活動がない場合は、独自のサブグラフを通知するために最低 100 GRT を支払う必要があります。

例を挙げてみましょう。これは、サブグラフが積極的にキュレートされている場合にのみ当てはまります。

- サブグラフの v1 で自動移行を使用して 100,000 GRT が通知される
- 所有者は v2 にアップグレードします。 100,000 GRT が新しい結合曲線に移行され、そこで 97,500 GRT が新しい曲線に入れられ、2,500 GRT がバーンされます
- 所有者は料金の半分の1250GRTをバーンすることができます。アップグレードの前に、この資金をウォレットに用意しておかなければなりません。この操作は、アップグレードと同じトランザクションで行われます。

_このメカニズムは現在ネットワーク上で稼動していますが、現在コミュニティでは、サブグラフ開発者のアップグレードコストを削減する方法について議論しています。_

### サブグラフの安定したバージョンの維持

サブグラフに多くの変更を加えている場合、継続的にアップグレードしてアップグレード費用を負担するのは得策ではありません。サブグラフの安定した一貫性のあるバージョンを維持することは、コストの観点からだけでなく、インデクサーが自信を持って同期時間を設定できるようにするためにも重要です。アップグレードを計画する際には、インデクサーの同期時間に影響が出ないように、インデクサにフラグを立てる必要があります。Discordの[#Indexers channel](https://discord.gg/8tgJ7rKW)チャンネルを利用して、サブグラフのバージョンアップをインデクサーに知らせることができます。

サブグラフは、外部の開発者が活用しているオープン API です。オープン API は、外部開発者のアプリケーションを壊さないように、厳格な基準に従う必要があります。 The Graph Network では、サブグラフの開発者は、インデクサーと、新しいサブグラフを同期するのにかかる時間を考慮する必要があります**、およびサブグラフを使用している他の開発者**。

### サブグラフのメタデータの更新

新しいバージョンを公開しなくても、サブグラフのメタデータを更新できます。メタデータには、サブグラフ名、画像、説明、Web サイトの URL、ソース コードの URL、およびカテゴリが含まれます。開発者は、該当するすべてのフィールドを編集できる Subgraph Studio でサブグラフの詳細を更新することで、これを行うことができます。

**エクスプローラーでサブグラフの詳細を更新** がチェックされていることを確認し、**保存** をクリックします。これがチェックされている場合、新しい展開で新しいバージョンを公開する必要なく、Explorer のサブグラフの詳細を更新するオンチェーン トランザクションが生成されます。

## グラフネットワークにサブグラフを展開する際のベストプラクティス

1. サブグラフの開発に ENS 名を活用する

- ENSのセットアップ：[https://app.ens.domains/](https://app.ens.domains/)
- ENSネームの追加方法は name to your settings [こちら](https://thegraph.com/explorer/settings?view=display-name).

2. プロフィールが充実しているほど、サブグラフがインデックスやキュレーションされる可能性が高くなります。

## The Graph Network のサブグラフを廃止する

サブグラフを廃止し、The Graph Networkから削除するには、[こちら](/managing/deprecating-a-subgraph) の手順に従います。

## The Graph Network でのサブグラフのクエリと課金について

Hosted Service は、開発者が制限なくサブグラフを展開できるように設定されました。

The Graph Networkが真の意味で分散化されるためには、プロトコルのインセンティブの中核としてクエリ料が支払われる必要があります。APIの購読やクエリフィーの支払いに関する詳細は、[こちら](/billing/)の課金ドキュメントをご覧ください。

### ネットワーク上でのクエリ料の算出

これは製品 UI のライブ機能ではありませんが、1 か月に支払ってもよい金額を予想クエリ量で割ることで、クエリごとの最大予算を設定できます。

クエリ料は各自で決定できますが、インデクサーがその価格でクエリを提供する保証はありません。もしゲートウェイが、ユーザーが支払おうとする価格か、それよりも低い価格でクエリを提供するインデクサーとマッチングできた場合、予算** と**価格の差分を支払うことになります。結果として、クエリ料が低いと、利用できるインデクサープールが減少し、受けられるサービスの品質に影響を与える可能性があります。高いクエリ料は、あなたのサブグラフにキュレーションや有名なインデクサーを引き寄せるインセンティブを持つことから、有益になります。

これはダイナミックで成長中の市場ですが、どのように関わるかは自分でコントロールできることを忘れないでください。プロトコルにもゲートウェイにも、上限や下限の価格は指定されていません。例えば、ネットワーク上のいくつかのdappsが支払う価格（週単位）を以下に示します。最後の列はGRTでのクエリ料を示していますのでご覧ください。例えば、Pickle Financeは1秒あたり回のリクエストがあり、1週間でGRTを支払っています。

![クエリ料](/img/QueryFee.png)

## その他のリソース

まだよくわからないという方も、ご安心ください。以下のリソースをチェックしたり、分散型ネットワークへのサブグラフの移行に関するビデオガイドをご覧ください:

<VideoEmbed youtube="CzdQ3dFFrjo" />

- [The Graph Networkのコントラクト](https://github.com/graphprotocol/contracts)
- [キュレーションコントラクト](https://github.com/graphprotocol/contracts/blob/dev/contracts/curation/Curation.sol) - GNSが包括する基本的なコントラクト
  - アドレス - `0x8fe00a685bcb3b2cc296ff6ffeab10aca4ce1538`
- [Subgraph Studioドキュメント](/deploying/subgraph-studio)
