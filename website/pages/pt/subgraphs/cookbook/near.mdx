---
title: Construção de Subgraphs na NEAR
---

This guide is an introduction to building subgraphs indexing smart contracts on the [NEAR blockchain](https://docs.near.org/).

## O que é NEAR?

[NEAR](https://near.org/) is a smart contract platform for building decentralized applications. Visit the [official documentation](https://docs.near.org/concepts/basics/protocol) for more information.

## O que são subgraphs na NEAR?

The Graph gives developers tools to process blockchain events and make the resulting data easily available via a GraphQL API, known individually as a subgraph. [Graph Node](https://github.com/graphprotocol/graph-node) is now able to process NEAR events, which means that NEAR developers can now build subgraphs to index their smart contracts.

Subgraphs are event-based, which means that they listen for and then process onchain events. There are currently two types of handlers supported for NEAR subgraphs:

- Handlers de blocos: executados em todos os blocos novos
- Handlers de recibos: Executados sempre que uma mensagem é executada numa conta especificada

[From the NEAR documentation](https://docs.near.org/build/data-infrastructure/lake-data-structures/receipt):

> Um Recibo é o único objeto acionável no sistema. Quando falamos de "processar uma transação" na plataforma NEAR, em algum ponto isto eventualmente significa "aplicar recibos".

## Construindo um Subgraph no NEAR

`@graphprotocol/graph-cli` is a command-line tool for building and deploying subgraphs.

`@graphprotocol/graph-ts` is a library of subgraph-specific types.

NEAR subgraph development requires `graph-cli` above version `0.23.0`, and `graph-ts` above version `0.23.0`.

> Construir um subgraph NEAR é um processo muito parecido com a construção de um subgraph que indexa o Ethereum.

Há três aspectos de definição de subgraph:

**subgraph.yaml:** the subgraph manifest, defining the data sources of interest, and how they should be processed. NEAR is a new `kind` of data source.

**schema.graphql:** a schema file that defines what data is stored for your subgraph, and how to query it via GraphQL. The requirements for NEAR subgraphs are covered by [the existing documentation](/developing/creating-a-subgraph/#the-graphql-schema).

**AssemblyScript Mappings:** [AssemblyScript code](/subgraphs/developing/creating/graph-ts/api/) that translates from the event data to the entities defined in your schema. NEAR support introduces NEAR-specific data types and new JSON parsing functionality.

Durante o desenvolvimento de um subgraph, existem dois comandos importantes:

```bash
$ graph codegen # gera tipos do arquivo de schema identificado no manifest
$ graph build # gera Web Assembly dos arquivos AssemblyScript, e prepara todos os arquivos do subgraph em uma pasta /build
```

### Definição de Manifest de Subgraph

The subgraph manifest (`subgraph.yaml`) identifies the data sources for the subgraph, the triggers of interest, and the functions that should be run in response to those triggers. See below for an example subgraph manifest for a NEAR subgraph:

```yaml
specVersion: 0.0.2
schema:
  file: ./src/schema.graphql # link para o arquivo de schema
dataSources:
  - kind: near
    network: near-mainnet
    source:
      account: app.good-morning.near # Esta fonte de dados monitorará esta conta
      startBlock: 10662188 # Necessário para a NEAR
    mapping:
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # nome da função no arq. de mapeamento
      receiptHandlers:
        - handler: handleReceipt # nome da função no arq. de mapeamento
      file: ./src/mapping.ts # link ao arq. com os mapeamentos de Assemblyscript
```

- NEAR subgraphs introduce a new `kind` of data source (`near`)
- The `network` should correspond to a network on the hosting Graph Node. On Subgraph Studio, NEAR's mainnet is `near-mainnet`, and NEAR's testnet is `near-testnet`
- NEAR data sources introduce an optional `source.account` field, which is a human-readable ID corresponding to a [NEAR account](https://docs.near.org/concepts/protocol/account-model). This can be an account or a sub-account.
- NEAR data sources introduce an alternative optional `source.accounts` field, which contains optional suffixes and prefixes. At least prefix or suffix must be specified, they will match the any account starting or ending with the list of values respectively. The example below would match: `[app|good].*[morning.near|morning.testnet]`. If only a list of prefixes or suffixes is necessary the other field can be omitted.

```yaml
accounts:
  prefixes:
    - app
    - good
  suffixes:
    - morning.near
    - morning.testnet
```

As fontes de dados na NEAR apoiam duas categorias de handlers:

- `blockHandlers`: run on every new NEAR block. No `source.account` is required.
- `receiptHandlers`: run on every receipt where the data source's `source.account` is the recipient. Note that only exact matches are processed ([subaccounts](https://docs.near.org/tutorials/crosswords/basics/add-functions-call#create-a-subaccount) must be added as independent data sources).

### Definição de Schema

Schema definition describes the structure of the resulting subgraph database and the relationships between entities. This is agnostic of the original data source. There are more details on subgraph schema definition [here](/developing/creating-a-subgraph/#the-graphql-schema).

### Mapeamentos em AssemblyScript

The handlers for processing events are written in [AssemblyScript](https://www.assemblyscript.org/).

NEAR indexing introduces NEAR-specific data types to the [AssemblyScript API](/subgraphs/developing/creating/graph-ts/api/).

```typescript

class ExecutionOutcome {
      gasBurnt: u64,
      blockHash: Bytes,
      id: Bytes,
      logs: Array<string>,
      receiptIds: Array<Bytes>,
      tokensBurnt: BigInt,
      executorId: string,
  }

class ActionReceipt {
      predecessorId: string,
      receiverId: string,
      id: CryptoHash,
      signerId: string,
      gasPrice: BigInt,
      outputDataReceivers: Array<DataReceiver>,
      inputDataIds: Array<CryptoHash>,
      actions: Array<ActionValue>,
  }

class BlockHeader {
      height: u64,
      prevHeight: u64,// Always zero when version < V3
      epochId: Bytes,
      nextEpochId: Bytes,
      chunksIncluded: u64,
      hash: Bytes,
      prevHash: Bytes,
      timestampNanosec: u64,
      randomValue: Bytes,
      gasPrice: BigInt,
      totalSupply: BigInt,
      latestProtocolVersion: u32,
  }

class ChunkHeader {
      gasUsed: u64,
      gasLimit: u64,
      shardId: u64,
      chunkHash: Bytes,
      prevBlockHash: Bytes,
      balanceBurnt: BigInt,
  }

class Block {
      author: string,
      header: BlockHeader,
      chunks: Array<ChunkHeader>,
  }

class ReceiptWithOutcome {
      outcome: ExecutionOutcome,
      receipt: ActionReceipt,
      block: Block,
  }
```

These types are passed to block & receipt handlers:

- Block handlers will receive a `Block`
- Receipt handlers will receive a `ReceiptWithOutcome`

Otherwise, the rest of the [AssemblyScript API](/subgraphs/developing/creating/graph-ts/api/) is available to NEAR subgraph developers during mapping execution.

This includes a new JSON parsing function - logs on NEAR are frequently emitted as stringified JSONs. A new `json.fromString(...)` function is available as part of the [JSON API](/subgraphs/developing/creating/graph-ts/api/#json-api) to allow developers to easily process these logs.

## Lançando um Subgraph na NEAR

Once you have a built subgraph, it is time to deploy it to Graph Node for indexing. NEAR subgraphs can be deployed to any Graph Node `>=v0.26.x` (this version has not yet been tagged & released).

O Subgraph Studio e o Indexador de atualização na Graph Network apoiam atualmente a indexação da mainnet e da testnet do NEAR em beta, com os seguintes nomes de rede:

- `near-mainnet`
- `near-testnet`

More information on creating and deploying subgraphs on Subgraph Studio can be found [here](/deploying/deploying-a-subgraph-to-studio/).

As a quick primer - the first step is to "create" your subgraph - this only needs to be done once. On Subgraph Studio, this can be done from [your Dashboard](https://thegraph.com/studio/): "Create a subgraph".

Once your subgraph has been created, you can deploy your subgraph by using the `graph deploy` CLI command:

```sh
$ graph create --node <graph-node-url> <subgraph-name> # creates a subgraph on a local Graph Node (on Subgraph Studio, this is done via the UI)
$ graph deploy --node <graph-node-url> --ipfs https://api.thegraph.com/ipfs/ <subgraph-name> # uploads the build files to a specified IPFS endpoint, and then deploys the subgraph to a specified Graph Node based on the manifest IPFS hash
```

A configuração do nódulo dependerá de onde o subgraph será lançado.

### Subgraph Studio

```sh
graph auth
graph deploy <subgraph-name>
```

### Graph Node local (baseado na configuração padrão)

```sh
graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001 <subgraph-name>
```

Quando o seu subgraph for lançado, ele será indexado pelo Graph Node. O seu progresso pode ser conferido com um query no próprio subgraph:

```graphql
{
  _meta {
    block {
      number
    }
  }
}
```

### Como indexar a NEAR com um Graph Node local

Executar um Graph Node que indexa a NEAR exige estes requisitos opcionais:

- NEAR Indexer Framework (Estrutura de Indexer) com instrumentação Firehose
- Componente(s) de Firehose no NEAR
- Graph Node com endpoint Firehose configurado

Em breve, falaremos mais sobre como executar os componentes acima.

## Como Consultar um Subgraph na NEAR

The GraphQL endpoint for NEAR subgraphs is determined by the schema definition, with the existing API interface. Please visit the [GraphQL API documentation](/subgraphs/querying/graphql-api/) for more information.

## Exemplos de Subgraphs

Aqui estão alguns exemplos de subgraphs para referência:

[NEAR Blocks](https://github.com/graphprotocol/graph-tooling/tree/main/examples/near-blocks)

[NEAR Receipts](https://github.com/graphprotocol/graph-tooling/tree/main/examples/near-receipts)

## Perguntas Frequentes

### Como o beta funciona?

O apoio à NEAR está em beta; podem ocorrer mais mudanças na API enquanto continuamos a melhorar a integração. Por favor, contacte-nos em near@thegraph.com para podermos apoiar-te na construção de subgraphs no NEAR e avisar-te sobre os acontecimentos mais recentes!

### Um subgraph pode indexar chains da NEAR e da EVM?

Não, um subgraph só pode apoiar fontes de dados de apenas uma chain/rede.

### Os subgraphs podem reagir a gatilhos mais específicos?

Atualmente, só há apoio a gatilhos de Blocos e Recibos. Estamos a investigar gatilhos para chamadas de função a uma conta específica. Também temos interesse em apoiar gatilhos de eventos, quando a NEAR receber apoio nativo a eventos.

### Handlers de recibos ativarão para contas e subcontas?

If an `account` is specified, that will only match the exact account name. It is possible to match sub-accounts by specifying an `accounts` field, with `suffixes` and `prefixes` specified to match accounts and sub-accounts, for example the following would match all `mintbase1.near` sub-accounts:

```yaml
accounts:
  suffixes:
    - mintbase1.near
```

### Subgraphs na NEAR podem fazer chamadas de vistoria para contas NEAR durante os mapeamentos?

Não há apoio a isto. Estamos a avaliar se esta funcionalidade é necessária para indexação.

### Posso usar modelos de fontes de dados no meu subgraph na NEAR?

Não há apoio a isto no momento. Estamos a avaliar se esta funcionalidade é necessária para indexação.

### Subgraphs no Ethereum apoiam versões "pendentes" e "atuais". Como posso lançar uma versão "pendente" de um subgraph no NEAR?

No momento, não há apoio à funcionalidade de pendências para subgraphs na NEAR. Entretanto, podes lançar uma nova versão para um subgraph de "nome" diferente, e quando este for sincronizado com a cabeça da chain, podes relançá-la para seu subgraph de "nome" primário, que usará o mesmo ID de lançamento subjacente — e aí, o subgraph principal sincronizará instantaneamente.

### A minha pergunta não foi respondida. Onde posso conseguir mais ajuda sobre construir subgraphs na NEAR?

If it is a general question about subgraph development, there is a lot more information in the rest of the [Developer documentation](/subgraphs/quick-start/). Otherwise please join [The Graph Protocol Discord](https://discord.gg/graphprotocol) and ask in the #near channel or email near@thegraph.com.

## Referências

- [NEAR developer documentation](https://docs.near.org/tutorials/crosswords/basics/set-up-skeleton)
