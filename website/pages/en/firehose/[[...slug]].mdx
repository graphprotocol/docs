import { visit } from 'unist-util-visit'
import { RemoteContent } from 'nextra/data'
import { buildDynamicMDX } from 'nextra/remote'
import { listFiles } from './_meta.js'
import { getPageMap } from '@/src/getPageMap'

export async function getStaticPaths() {
  const files = await listFiles()
  return {
    fallback: false,
    paths: files.map((filePath) => ({
      params: {
        slug: filePath.replace(/\.mdx?/, '').split('/'),
      },
    })),
  }
}
export async function getStaticProps({ params: { slug = ['README'] } }) {
  const baseURL = 'https://raw.githubusercontent.com/streamingfast/firehose-docs/master/'
  const paths = slug.join('/')
  let fileURL = `${paths}.md`
  let response = await fetch(baseURL + fileURL)
  if (response.status === 404 && paths !== 'README') {
    fileURL = `$${paths}/README.md`
    response = await fetch(baseURL + fileURL)
  }
  const data = (await response.text())
    // replace {% embed ... %} with <iframe />
    .replaceAll(
      /{%\s+embed\s+url="(.*?)"\s+%}/g,
      (...m) =>
        `<iframe src="${m[1].replace(
          // we need enhance YouTube links, otherwise they will be not loaded in iframe
          'youtube.com/watch?v=',
          'youtube.com/embed/'
        )}" style={{aspectRatio: 16/9, width: '100%'}}/>`
    )
    // remove gitbook {% ... %} elements
    .replaceAll(/{%.*?%}/g, '')
    // Replaces all the relative paths of images to absolute paths to the repo
    .replaceAll('../assets', 'https://raw.githubusercontent.com/streamingfast/firehose-docs/master/assets/')
    // close img tags only if he doesn't point to .gitbook
    .replaceAll(/<img(.*?)>/g, (...m) => (m[1].includes('src=".gitbook') ? '' : `<img${m[1]}/>`))
  let mdx = await buildDynamicMDX(data, {
    mdxOptions: {
      // change-log contains `{variable}` text that is thrown an error by MDX2 parser since he treat it as variable injection, to fix it we parse chang-log with the markdown parser
      format: paths.endsWith('/change-log') ? 'md' : 'mdx',
      remarkPlugins: [
        () => (tree, _file, done) => {
          // enhance links
          visit(tree, 'link', (node) => {
            if (node.url.startsWith('./')) {
              node.url = node.url.slice(2)
            }
            if (node.url.startsWith('/')) {
              // (foo)[/foo/bar]
              node.url = node.url.replace('/', '/firehose/')
            } else if (!node.url.includes('/') && node.url.endsWith('.md')) {
              // (foo)[foo.md]
              node.url = [...slug.slice(0, -1), node.url].join('/')
            }
          })
          done()
        },
      ],
    },
    codeHighlight: false,
  })
  let parsedData = JSON.parse(mdx.__nextra_dynamic_opts)
  // remove title from frontMatter if it's the same as the title of the page
  if (parsedData.title === parsedData.frontMatter.title) {
    parsedData.frontMatter.title = ''
  }
  mdx.__nextra_dynamic_opts = JSON.stringify(parsedData)
  return {
    props: {
      ...mdx,
      __nextra_pageMap: await getPageMap('en'),
      hideLocaleSwitcher: true,
      remoteFilePath: `https://github.com/streamingfast/firehose-docs/tree/master/${fileURL}`,
    },
  }
}

<RemoteContent />
