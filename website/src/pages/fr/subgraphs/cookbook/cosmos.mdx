---
title: Création de subgraphes sur Cosmos
---

This guide is an introduction on building subgraphs indexing [Cosmos](https://cosmos.network/) based blockchains.

## Que sont les subgraphs de Cosmos ?

The Graph allows developers to process blockchain events and make the resulting data easily available via an open GraphQL API, known as a subgraph. [Graph Node](https://github.com/graphprotocol/graph-node) is now able to process Cosmos events, which means Cosmos developers can now build subgraphs to easily index onchain events.

Il existe quatre types de gestionnaires pris en charge dans les subgraphs de Cosmos :

- **Block handlers** run whenever a new block is appended to the chain.
- **Event handlers** run when a specific event is emitted.
- **Transaction handlers** run when a transaction occurs.
- **Message handlers** run when a specific message occurs.

Based on the [official Cosmos documentation](https://docs.cosmos.network/):

> [Events](https://docs.cosmos.network/main/learn/advanced/events) are objects that contain information about the execution of the application. They are mainly used by service providers like block explorers and wallets to track the execution of various messages and index transactions.
>
> [Transactions](https://docs.cosmos.network/main/learn/advanced/transactions) are objects created by end-users to trigger state changes in the application.
>
> [Messages](https://docs.cosmos.network/main/learn/advanced/transactions#messages) are module-specific objects that trigger state transitions within the scope of the module they belong to.

Même si toutes les données sont accessibles avec un gestionnaire de blocs, des gestionnaires tiers permettent aux développeurs de subgraphs de traiter les données de manière beaucoup plus précise.

## Création d'un subgraph ciblant Cosmos

### Dépendances des subgraphs

[graph-cli](https://github.com/graphprotocol/graph-tooling/tree/main/packages/cli) is a CLI tool to build and deploy subgraphs, version `>=0.30.0` is required in order to work with Cosmos subgraphs.

[graph-ts](https://github.com/graphprotocol/graph-tooling/tree/main/packages/ts) is a library of subgraph-specific types, version `>=0.27.0` is required in order to work with Cosmos subgraphs.

### Composants principaux du subgraph

La définition d'un subgraph comporte trois éléments clés :

**subgraph.yaml**: a YAML file containing the subgraph manifest, which identifies which events to track and how to process them.

**schema.graphql**: a GraphQL schema that defines what data is stored for your subgraph, and how to query it via GraphQL.

**AssemblyScript Mappings**: [AssemblyScript](https://github.com/AssemblyScript/assemblyscript) code that translates from blockchain data to the entities defined in your schema.

### Définition du manifeste du subgraph

The subgraph manifest (`subgraph.yaml`) identifies the data sources for the subgraph, the triggers of interest, and the functions (`handlers`) that should be run in response to those triggers. See below for an example subgraph manifest for a Cosmos subgraph:

```yaml
version spec: 0.0.5
description: Exemple de subgraph Cosmos
schéma:
  fichier: ./schema.graphql # lien vers le fichier de schéma
les sources de données:
  - genre: cosmos
    nom: CosmosHub
    réseau: cosmoshub-4 # Cela changera pour chaque blockchain basée sur le cosmos. Dans ce cas, l’exemple utilise le mainnet Cosmos Hub.
    source:
      startBlock: 0 # Requis pour Cosmos, définissez-le sur 0 pour démarrer l'indexation à partir de la genèse de la chaîne
    cartographie:
      Version api: 0.0.7
      langage: wasm/assemblyscript
      gestionnaires de blocs:
        - handler: handleNewBlock # le nom de la fonction dans le fichier de mappage
      Gestionnaires d'événements:
        - event: récompenses # le type d'événement qui sera géré
          handler: handleReward # le nom de la fonction dans le fichier de mappage
      Gestionnaires de transactions:
        - handler: handleTransaction # le nom de la fonction dans le fichier de mappage
      Gestionnaires de messages:
        - message: /cosmos.staking.v1beta1.MsgDelegate # le type d'un message
          handler: handleMsgDelegate # le nom de la fonction dans le fichier de mappage
      fichier: ./src/mapping.ts # lien vers le fichier avec les mappages Assemblyscript
```

- Cosmos subgraphs introduce a new `kind` of data source (`cosmos`).
- The `network` should correspond to a chain in the Cosmos ecosystem. In the example, the Cosmos Hub mainnet is used.

### Définition de schéma

Schema definition describes the structure of the resulting subgraph database and the relationships between entities. This is agnostic of the original data source. There are more details on subgraph schema definition [here](/developing/creating-a-subgraph/#the-graphql-schema).

### Cartographies AssemblyScript

The handlers for processing events are written in [AssemblyScript](https://www.assemblyscript.org/).

Cosmos indexing introduces Cosmos-specific data types to the [AssemblyScript API](/subgraphs/developing/creating/graph-ts/api/).

```tsx
class Block {
  header: Header
  evidence: EvidenceList
  resultBeginBlock: ResponseBeginBlock
  resultEndBlock: ResponseEndBlock
  transactions: Array<TxResult>
  validatorUpdates: Array<Validator>
}

class EventData {
  event: Event
  block: HeaderOnlyBlock
  tx: TransactionContext
}

class TransactionData {
  tx: TxResult
  block: HeaderOnlyBlock
}

class MessageData {
  message: Any
  block: HeaderOnlyBlock
  tx: TransactionContext
}

class TransactionContext {
  hash: Bytes
  index: u32
  code: u32
  gasWanted: i64
  gasUsed: i64
}

class HeaderOnlyBlock {
  header: Header
}

class Header {
  version: Consensus
  chainId: string
  height: u64
  time: Timestamp
  lastBlockId: BlockID
  lastCommitHash: Bytes
  dataHash: Bytes
  validatorsHash: Bytes
  nextValidatorsHash: Bytes
  consensusHash: Bytes
  appHash: Bytes
  lastResultsHash: Bytes
  evidenceHash: Bytes
  proposerAddress: Bytes
  hash: Bytes
}

class TxResult {
  height: u64
  index: u32
  tx: Tx
  result: ResponseDeliverTx
  hash: Bytes
}

class Event {
  eventType: string
  attributes: Array<EventAttribute>
}

class Any {
  typeUrl: string
  value: Bytes
}
```

Chaque structure de type de gestionnaire transmise en tant qu'argument à une fonction de mappage.

- Block handlers receive the `Block` type.
- Event handlers receive the `EventData` type.
- Transaction handlers receive the `TransactionData` type.
- Message handlers receive the `MessageData` type.

As a part of `MessageData` the message handler receives a transaction context, which contains the most important information about a transaction that encompasses a message. The transaction context is also available in the `EventData` type, but only when the corresponding event is associated with a transaction. Additionally, all handlers receive a reference to a block (`HeaderOnlyBlock`).

You can find the full list of types for the Cosmos integration [here](https://github.com/graphprotocol/graph-ts/blob/4c064a8118dff43b110de22c7756e5d47fcbc8df/chain/cosmos.ts).

### Décodage des messages

It's important to note that Cosmos messages are chain-specific and they are passed to a subgraph in the form of a serialized [Protocol Buffers](https://protobuf.dev/) payload. As a result, the message data needs to be decoded in a mapping function before it can be processed.

An example of how to decode message data in a subgraph can be found [here](https://github.com/graphprotocol/graph-tooling/blob/main/examples/cosmos-validator-delegations/src/decoding.ts).

## Création et construction d'un subgraph Cosmos

The first step before starting to write the subgraph mappings is to generate the type bindings based on the entities that have been defined in the subgraph schema file (`schema.graphql`). This will allow the mapping functions to create new objects of those types and save them to the store. This is done by using the `codegen` CLI command:

```bash
$ codegen graph
```

Once the mappings are ready, the subgraph needs to be built. This step will highlight any errors the manifest or the mappings might have. A subgraph needs to build successfully in order to be deployed to the Graph Node. It can be done using the `build` CLI command:

```bash
$ construction de graph
```

## Déploiement d'un subgraph Cosmos

Once your subgraph has been created, you can deploy your subgraph by using the `graph deploy` CLI command:

**Subgraph Studio**

Visitez Subgraph Studio pour créer un nouveau subgraph.

```bash
graph deploy nom-du-subgraph
```

**Local Graph Node (based on default configuration):**

```bash
graph create nom-du-subgraph --node http://localhost:8020
```

```bash
graph deploy nom-du-subgraph --node http://localhost:8020/ --ipfs http://localhost:5001
```

## Interroger un subgraph de Cosmos

The GraphQL endpoint for Cosmos subgraphs is determined by the schema definition, with the existing API interface. Please visit the [GraphQL API documentation](/subgraphs/querying/graphql-api/) for more information.

## Blockchains Cosmos prises en charge

### Cosmos Hub

#### Qu'est-ce qu'un Cosmos Hub ?

The [Cosmos Hub blockchain](https://hub.cosmos.network/) is the first blockchain in the [Cosmos](https://cosmos.network/) ecosystem. You can visit the [official documentation](https://docs.cosmos.network/) for more information.

#### Les Réseaux

Cosmos Hub mainnet is `cosmoshub-4`. Cosmos Hub current testnet is `theta-testnet-001`. <br/>Other Cosmos Hub networks, i.e. `cosmoshub-3`, are halted, therefore no data is provided for them.

### Osmosis

> La prise en charge d'Osmosis dans Graph Node et sur Subgraph Studio est en bêta : veuillez contacter l'équipe de The Graph pour toute question sur la création de subgraphs Osmosis !

#### Qu’est-ce que l’osmose ?

[Osmosis](https://osmosis.zone/) is a decentralized, cross-chain automated market maker (AMM) protocol built on top of the Cosmos SDK. It allows users to create custom liquidity pools and trade IBC-enabled tokens. You can visit the [official documentation](https://docs.osmosis.zone/) for more information.

#### Les Réseaux

Osmosis mainnet is `osmosis-1`. Osmosis current testnet is `osmo-test-4`.

## Exemples de subgraphs

Voici quelques exemples de subgraphs pour référence :

[Block Filtering Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-block-filtering)

[Validator Rewards Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-validator-rewards)

[Validator Delegations Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-validator-delegations)

[Osmosis Token Swaps Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-osmosis-token-swaps)
