---
title: Лучшая практика субграфов 6 — используйте графтинг для быстрого развертывания исправлений
sidebarTitle: 'Subgraph Best Practice 6: Grafting and Hotfixing'
---

## Краткое содержание

Графтинг — это мощная функция в разработке субграфов, которая позволяет создавать и разворачивать новые субграфы, повторно используя индексированные данные из существующих.

### Обзор

Эта функция позволяет быстро развертывать исправления для критических ошибок, устраняя необходимость повторного индексирования всего субграфа с нуля. Сохраняя исторические данные, графтинг минимизирует время простоя и обеспечивает непрерывность работы сервисов данных.

## Преимущества графтинга для оперативных исправлений

1. **Быстрое развертывание**

   - **Минимизация времени простоя**: когда субграф сталкивается с критической ошибкой и перестает индексировать данные, графтинг позволяет немедленно развернуть исправление без необходимости ждать повторного индексирования.
   - **Немедленное восстановление**: новый субграф продолжается с последнего индексированного блока, обеспечивая бесперебойную работу служб передачи данных.

2. **Сохранение данных**

   - **Повторное использование исторических данных**: графтинг копирует существующие данные из базового субграфа, что позволяет сохранить важные исторические записи.
   - **Консистентность**: поддерживает непрерывность данных, что имеет решающее значение для приложений, полагающихся на согласованные исторические данные.

3. **Эффективность**
   - **Экономия времени и ресурсов**: избегает вычислительных затрат на повторное индексирование больших объемов данных.
   - **Фокус на исправлениях**: позволяет разработчикам сосредоточиться на решении проблем, а не на восстановлении данных.

## Лучшие практики при использовании графтинга для оперативных исправлений

1. **Первоначальное развертывание без графтинга**

   - **Начните с чистого листа**: Всегда разворчивайте первоначальный субграф без использования графтинга, чтобы убедиться в его стабильности и корректной работе.
   - **Тщательно тестируйте**: проверьте производительность субграфа, чтобы свести к минимуму необходимость в будущих исправлениях.

2. **Реализация исправления с использованием графтинга**

   - **Определите проблему**: при возникновении критической ошибки определите номер блока последнего успешно проиндексированного события.
   - **Создайте новый субграф**: разработайте новый субграф, включающий оперативное исправление.
   - **Настройте графтинг**: используйте графтинг для копирования данных до определенного номера блока из неисправного субграфа.
   - **Быстро разверните**: опубликуйте графтинговый (перенесенный) субграф, чтобы как можно скорее восстановить работу сервиса.

3. **Действия после оперативного исправления**

   - **Мониторинг производительности**: убедитесь, что графтинговый (перенесенный) субграф индексируется правильно и исправление решает проблему.
   - **Публикация без графтинга**: как только субграф стабилизируется, разверните его новую версию без использования графтинга для долгосрочного обслуживания.
     > Примечание: Не рекомендуется использовать графтинг бесконечно, так как это может усложнить будущие обновления и обслуживание.
   - **Обновите ссылки**: перенаправьте все сервисы или приложения на новый субграф без использования графтинга.

4. **Важные замечания**
   - **Тщательный выбор блока**: тщательно выбирайте номер блока графтинга, чтобы избежать потери данных.
   - **Совет**: используйте номер блока последнего корректно обработанного события.
   - **Используйте идентификатор развертывания**: убедитесь, что Вы ссылаетесь на идентификатор развертывания базового субграфа, а не на идентификатор субграфа.
   - **Примечание**: идентификатор развертывания — это уникальный идентификатор для конкретного развертывания субграфа.
   - **Объявление функции**: не забудьте указать использование графтинга в манифесте субграфа в разделе функций.

## Пример: развертывание оперативного исправления с использованием графтинга

Предположим, у вас есть субграф, отслеживающий смарт-контракт, который перестал индексироваться из-за критической ошибки. Вот как Вы можете использовать графтинг для развертывания оперативного исправления.

1. **Манифест неудачного субграфа (subgraph.yaml)**

   ```yaml
   specVersion: 1.0.0
   schema:
     file: ./schema.graphql
   dataSources:
     - kind: ethereum/contract
       name: OldSmartContract
       network: sepolia
       source:
         address: '0xOldContractAddress'
         abi: Lock
         startBlock: 5000000
       mapping:
         kind: ethereum/events
         apiVersion: 0.0.7
         language: wasm/assemblyscript
         entities:
           - Withdrawal
         abis:
           - name: Lock
             file: ./abis/OldLock.json
         eventHandlers:
           - event: Withdrawal(uint256,uint256)
             handler: handleOldWithdrawal
         file: ./src/old-lock.ts
   ```

2. **Манифест нового субграфа с графтингом (subgraph.yaml)**
   ```yaml
   specVersion: 1.0.0
   schema:
     file: ./schema.graphql
   dataSources:
     - kind: ethereum/contract
       name: NewSmartContract
       network: sepolia
       source:
         address: '0xNewContractAddress'
         abi: Lock
         startBlock: 6000001 # Блок после последнего индексированного блока
       mapping:
         kind: ethereum/events
         apiVersion: 0.0.7
         language: wasm/assemblyscript
         entities:
           - Withdrawal
         abis:
           - name: Lock
             file: ./abis/Lock.json
         eventHandlers:
           - event: Withdrawal(uint256,uint256)
             handler: handleWithdrawal
         file: ./src/lock.ts
   features:
     - grafting
   graft:
     base: QmBaseDeploymentID # ID развертывания неудачного субграфа
     block: 6000000 # Последний успешно индексированный блок
   ```

**Пояснение:**

- **Обновление источника данных**: новый субграф указывает на 0xNewContractAddress, который может быть исправленной версией смарт-контракта.
- **Начальный блок**: устанавливается на один блок после последнего успешно индексированного блока, чтобы избежать повторной обработки ошибки.
- **Конфигурация графтинга**:
  - **base**: идентификатор развертывания неудачного субграфа.
  - **block**: номер блока, с которого должен начаться графтинг.

3. **Шаги развертывания**

   - **Обновите код**: внедрите исправление в свои скрипты мэппинга (например, handleWithdrawal).
   - **Отредактируйте манифест**: как показано выше, обновите файл `subgraph.yaml` с конфигурациями для графтинга.
   - **Разверните субграф**:
     - Аутентифицируйтесь с помощью Graph CLI.
     - Разверните новый субграф используя `graph deploy`.

4. **После развертывания**
   - **Проверьте индексирование**: убедитесь, что субграф корректно индексирует данные с точки графтинга.
   - **Следите за данными**: убедитесь, что новые данные индексируются и что исправление работает эффективно.
   - **Запланируйте повторную публикацию**: запланируйте развертывание версии без графтинга для обеспечения долгосрочной стабильности.

## Предупреждения и предостережения

Хотя графтинг является мощным инструментом для быстрого развертывания исправлений, существуют конкретные сценарии, когда его следует избегать для поддержания целостности данных и обеспечения оптимальной производительности.

- **Несовместимые изменения схемы**: если ваше исправление требует изменения типа существующих полей или удаления полей из схемы, графтинг не подходит. Графтинг предусматривает, что схема нового субграфа будет совместима со схемой базового субграфа. Несовместимые изменения могут привести к несоответствиям данных и ошибкам, так как существующие данные не будут соответствовать новой схеме.
- **Значительные изменения логики мэппинга**: когда исправление включает существенные изменения в вашей логике мэппинга, такие как изменение обработки событий или изменение функций обработчиков, графтинг может работать некорректно. Новая логика может быть несовместима с данными, обработанными по старой логике, что приведет к некорректным данным или сбоям в индексировании.
- **Развертывания в сеть The Graph**: графтинг не рекомендуется для субграфов, предназначенных для децентрализованной сети The Graph (майннет). Это может усложнить индексирование и не поддерживаться всеми Индексаторами, что может привести к непредсказуемому поведению или увеличению затрат. Для развертываний в майннете безопаснее перезапустить индексирование субграфа с нуля, чтобы обеспечить полную совместимость и надежность.

### Управление рисками

- **Целостность данных**: неверно указанные номера блоков могут привести к потере данных или их дублированию.
- **Тестирование**: всегда тестируйте графтинг в среде разработки перед развертыванием в рабочей среде.

## Заключение

Графтинг — это эффективная стратегия для развертывания оперативных исправлений в разработке субграфов, позволяющая Вам:

- **Быстро восстанавливаться** после критических ошибок без повторного индексирования.
- **Сохранять исторические данные**, поддерживая непрерывности работы для приложений и пользователей.
- **Обеспечить доступность сервиса**, минимизируя время простоя при критических исправлениях.

Однако важно использовать графтинг разумно и следовать лучшим практикам для снижения рисков. После стабилизации своего субграфа с помощью оперативных исправлений, спланируйте развертывание версии без графтинга для обеспечения долгосрочного обслуживания.

## Дополнительные ресурсы

- **[Документация графтинга](/subgraphs/cookbook/grafting/)**: замените контракт и сохраните его историю с помощью графтинга
- **[Понимание идентификаторов развертывания](/subgraphs/querying/subgraph-id-vs-deployment-id/)**: ознакомьтесь с разницей между идентификатором развертывания и идентификатором субграфа.

Включив графтинг в процесс разработки субграфов, Вы сможете быстрее реагировать на проблемы, обеспечивая стабильность и надежность Ваших сервисов данных.

## Лучшие практики для субграфов 1-6

1. [Увеличение скорости запросов с помощью обрезки субграфов](/subgraphs/best-practices/pruning/)

2. [Улучшение индексирования и отклика запросов с использованием @derivedFrom](/subgraphs/best-practices/derivedfrom/)

3. [Улучшение индексирования и производительности запросов с использованием неизменяемых объектов и байтов в качестве идентификаторов](/subgraphs/best-practices/immutable-entities-bytes-as-ids/)

4. [Увеличение скорости индексирования путем избегания `eth_calls`](/subgraphs/best-practices/avoid-eth-calls/)

5. [Упрощение и оптимизация с помощью временных рядов и агрегаций](/subgraphs/best-practices/timeseries/)

6. [Использование переноса (графтинга) для быстрого развертывания исправлений](/subgraphs/best-practices/grafting-hotfix/)
