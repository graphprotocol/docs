# The Graphå®¢æˆ·ç«¯å·¥å…·

è¿™ä¸ªä»“åº“æ˜¯[The Graph](https://thegraph.com)æ¶ˆè´¹è€…ç«¯å·¥å…·ï¼ˆé€‚ç”¨äºæµè§ˆå™¨å’ŒNodeJSç¯å¢ƒï¼‰çš„å®¶ã€‚

## èƒŒæ™¯

æœ¬èŠ‚æä¾›çš„å·¥å…·æ—¨åœ¨ä¸°å¯Œå’Œæ‰©å±•DX, å¹¶æ·»åŠ  dApp æ‰€éœ€çš„é™„åŠ å±‚ä»¥å®ç°åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºã€‚

ä»GraphQL API ä¸Š[[The Graph](https://thegraph.com) æ¶ˆè€—æ•°æ®çš„å¼€å‘è€…å¸¸å¸¸éœ€è¦å¤–è§‚æ‰èƒ½ä½¿æ•°æ®æ¶ˆè€—æ›´åŠ å®¹æ˜“ï¼Œ è€Œä¸”è¿˜å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªç´¢å¼•äººçš„å·¥å…·ã€‚

## ç‰¹å¾å’Œç›®æ ‡

è¿™ä¸ªåº“æ—¨åœ¨ç®€åŒ–dAppæ•°æ®æ¶ˆè€—çš„ç½‘ç»œæ–¹é¢ã€‚ è¿™ä¸ªä»“åº“ä¸­æä¾›çš„å·¥å…·æ˜¯ä¸ºäº†åœ¨æ„å»ºæ—¶è¿è¡Œï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶æ›´å¿«åœ°æ‰§è¡Œå’Œè¿è¡Œã€‚

> åœ¨è¿™ä¸ªä»“åº“ä¸­æä¾›çš„å·¥å…·å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä½†ä½ ä¹Ÿå¯ä»¥å’Œä»»ä½•ç°æœ‰çš„ GraphQL å®¢æˆ·ç«¯ä¸€èµ·ä½¿ç”¨ï¼

|  çŠ¶æ€ | ç‰¹å¾                                             | æ³¨æ„ï¼š                                                                                                   |
| :-: | ---------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
|  âœ…  | å¤šä¸ªç´¢å¼•äºº                                          | åŸºäºè·å–ç­–ç•¥                                                                                                |
|  âœ…  | è·å–ç­–ç•¥                                           | è¶…æ—¶ã€ é‡è¯•ã€ å›é€€ã€ ç§æ—ï¼Œæœ€é«˜å€¼                                                                                    |
|  âœ…  | æ„å»ºæ—¶é—´éªŒè¯å’Œä¼˜åŒ–                                      |                                                                                                       |
|  âœ…  | å®¢æˆ·ç«¯ç»„æˆ                                          | æ”¹è¿›æ‰§è¡Œè§„åˆ’ç¨‹åº(åŸºäº GraphQL-Mesh)                                                          |
|  âœ…  | è·¨é“¾å­å›¾å¤„ç†                                         | ä½¿ç”¨ç›¸ä¼¼å­å›¾ä½œä¸ºå•ä¸ªæº                                                                                           |
|  âœ…  | åŸå§‹æ‰§è¡Œ (ç‹¬ç«‹æ¨¡å¼)                 | æ²¡æœ‰åŒ…è£…GraphQLå®¢æˆ·ç«¯                                                                                        |
|  âœ…  | æœ¬åœ°(å®¢æˆ·ç«¯) çªå˜                  |                                                                                                       |
|  âœ…  | [è‡ªåŠ¨åŒºå—è·Ÿè¸ª](../packages/block-tracking/README.md) | è·Ÿè¸ªåŒºå—ç¼–å· [å¦‚è¿™é‡Œæè¿°çš„](https://thegraph.com/docs/en/developer/distributed-systems/#polling-for-updated-data) |
|  âœ…  | [è‡ªåŠ¨åˆ†é¡µ](../packages/auto-pagination/README.md)  | åœ¨å•æ¬¡è°ƒç”¨ä¸­æ‰§è¡Œå¤šä¸ªè¯·æ±‚ä»¥è·å–è¶…è¿‡ç´¢å¼•äººé™åˆ¶çš„æ•°æ®                                                                             |
|  âœ…  | ä¸ `@apollo/client` é›†æˆ                          |                                                                                                       |
|  âœ…  | ä¸ `urql` é›†æˆ                                    |                                                                                                       |
|  âœ…  | TypeScript æ”¯æŒ                                  | å…·æœ‰å†…ç½®çš„ GraphQL Codegen å’Œ `TypedDocumentNode`                                                           |
|  âœ…  | [`@live` æŸ¥è¯¢](./live.md)                        | åŸºäºæŠ•ç¥¨                                                                                                  |

> æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ª[æ‰©å±•æ¶æ„è®¾è®¡](./architecture.md)ã€‚

## å¼€å§‹

æ‚¨å¯ä»¥å…³æ³¨ [Episode 45 of `graphql.wtf`](https://graphql.wtf/episodes/45-the-graph-client) æ¥äº†è§£æ›´å¤šå…³äºGraphå®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼š

[![GraphQL.wtf Episode 45](https://img.youtube.com/vi/ZsRAmyUtvwg/0.jpg)](https://graphql.wtf/episodes/45-the-graph-client)

è‹¥è¦å¯åŠ¨ï¼Œè¯·ç¡®ä¿åœ¨æ‚¨çš„é¡¹ç›®ä¸­å®‰è£… [The Graphå®¢æˆ·ç«¯CLI] ï¼š

```sh
yarn add -D @graphprotocol/client-cli
# or, with NPM:
npm install --save-dev @graphprotocol/client-cli
```

> CLI æ˜¯ä½œä¸ºdev ä¾èµ–å®‰è£…çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨å®ƒæ¥äº§ç”Ÿä¼˜åŒ–çš„è¿è¡Œæ—¶å·¥ä»¶ï¼Œè¿™äº›å·¥ä»¶å¯ä»¥ç›´æ¥ä»æ‚¨çš„åº”ç”¨ä¸­åŠ è½½ï¼

åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ (åä¸º `.graphclientrc.yml`) å¹¶æŒ‡å‘æ‚¨çš„ç”±The Graphæä¾›çš„GraphQL ç«¯ç‚¹, ä¾‹å¦‚ï¼š

```yml
# .graphclientrc.yml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
```

ç°åœ¨ï¼Œé€šè¿‡è¿è¡Œ The Graphå®¢æˆ·ç«¯ CLI åˆ›å»ºè¿è¡Œæ—¶çš„å·¥ä»¶ï¼š

```sh
graphclient build
```

> æ³¨æ„ï¼šæ‚¨éœ€è¦ä½¿ç”¨ `yarn` å‰ç¼€è¿è¡Œæ­¤æ“ä½œï¼Œæˆ–è€…åœ¨æ‚¨çš„ `package.json` ä¸­æ·»åŠ ä¸€ä¸ªè„šæœ¬ã€‚

è¿™å°†äº§ç”Ÿä¸€ä¸ªå¯éšæ—¶ä½¿ç”¨çš„ç‹¬ç«‹`æ‰§è¡Œ`å‡½æ•°ã€‚ ä½ å¯ä»¥ç”¨æ¥è¿è¡Œä½ çš„åº”ç”¨ç¨‹åº GraphQL æ“ä½œï¼Œä½ åº”è¯¥æœ‰ä¸€ä¸ªç±»ä¼¼äºä»¥ä¸‹çš„è¾“å‡ºï¼š

```sh
GraphClient: Cleaning existing artifacts
GraphClient: Reading the configuration
ğŸ•¸ï¸: Generating the unified schema
ğŸ•¸ï¸: Generating artifacts
ğŸ•¸ï¸: Generating index file in TypeScript
ğŸ•¸ï¸: Writing index.ts for ESM to the disk.
ğŸ•¸ï¸: Cleanup
ğŸ•¸ï¸: Done! => .graphclient
```

ç°åœ¨ï¼Œ`.graphclient`çš„è‰ºæœ¯å“æ˜¯ä¸ºä½ ç”Ÿæˆçš„ï¼Œä½ å¯ä»¥ç›´æ¥ä»ä½ çš„ä»£ç ä¸­å¯¼å…¥å®ƒï¼Œå¹¶è¿è¡Œä½ çš„æŸ¥è¯¢ï¼š

```ts
import { execute } from '../.graphclient'

const myQuery = gql`
  query pairs {
    pair(id: "0x00004ee988665cdda9a1080d5792cecd16dc1220") {
      id
      token0 {
        id
        symbol
        name
      }
      token1 {
        id
        symbol
        name
      }
    }
  }
`

async function main() {
  const result = await execute(myQuery, {})
  console.log(result)
}

main()
```

### ä½¿ç”¨ Vanilla JavaScript è€Œä¸æ˜¯ TypeScript

GraphClient CLI é»˜è®¤æƒ…å†µä¸‹ä»¥ TypeScript æ–‡ä»¶ç”Ÿæˆå®¢æˆ·ç«¯å·¥ä»¶ï¼Œ ä½†æ‚¨å¯ä»¥ä½¿ç”¨ `--fileType js` æˆ– `--fileType js` æˆ– `--fileType json` æ¥é…ç½® CLI ä»¥ç”ŸæˆJavaScript å’Œ JSON æ–‡ä»¶ä»¥åŠé¢å¤–çš„ TypeScript å®šä¹‰æ–‡ä»¶ã€‚

`js` æ ‡å¿—ç”Ÿæˆäº†æ‰€æœ‰ä½¿ç”¨ JavaScript æ–‡ä»¶çš„æ–‡ä»¶ï¼Œå…¶ä¸­å«æœ‰ESM è¯­æ³•å’Œ `json` æ ‡å¿—ä½œä¸ºJSON æ–‡ä»¶ç”Ÿæˆäº†æºä»£ç ï¼ŒåŒæ—¶ä¹Ÿç”Ÿæˆäº†æ—§çš„ CommonJS è¯­æ³•çš„ JavaScript æ–‡ä»¶ï¼Œå› ä¸ºåªæœ‰CommonJSæ”¯æŒ JSON æ–‡ä»¶ä½œä¸ºæ¨¡å—ã€‚

é™¤éæ‚¨ä½¿ç”¨CommonJS(`require`)ï¼Œå¦åˆ™æˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨`js`æ ‡è®°ã€‚

`graphclient --fileType js`

- [ä½¿ç”¨JSONæ–‡ä»¶åœ¨CommonJSè¯­æ³•ä¸­ä½¿ç”¨JavaScriptçš„ç¤ºä¾‹](../examples/javascript-cjs)
- [ä¸€ä¸ª JavaScript åœ¨ESM è¯­æ³•ä¸­çš„ä½¿ç”¨ç¤ºä¾‹](../examples/javascript-esm)

#### The Graphå®¢æˆ·ç«¯å¼€å‘å·¥å…·

The Graphå®¢æˆ·ç«¯CLI å¸¦æœ‰å†…ç½®çš„ GraphiQLï¼Œå› æ­¤æ‚¨å¯ä»¥å®æ—¶å°è¯•æŸ¥è¯¢ã€‚

åœ¨è¿™ç§ç¯å¢ƒä¸‹æœåŠ¡çš„ GraphQL æ¨¡å¼æ˜¯åŸºäºæ‚¨åº”ç”¨çš„æ‰€æœ‰æ„æˆå­å›¾å’Œè½¬æ¢çš„æœ€ç»ˆæ¨¡å¼ ã€‚

è¦å¯åŠ¨DevTool GraphiQLï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```sh
graphclient serve-dev
```

ç„¶åæ‰“å¼€ http://localhost:4000/ä»¥ä½¿ç”¨ GraphiQLã€‚æ‚¨ç°åœ¨å¯ä»¥åœ¨æœ¬åœ°è¯•ç”¨æ‚¨çš„Graphå®¢æˆ·ç«¯GraphQL æ¨¡å¼ï¼ğŸ¥³

#### ä¾‹å­

æ‚¨è¿˜å¯ä»¥å‚è€ƒ[æ­¤ä»“åº“ä¸­çš„ç¤ºä¾‹ç›®å½•](../examples)ï¼Œäº†è§£æ›´é«˜çº§çš„ç¤ºä¾‹å’Œé›†æˆç¤ºä¾‹ï¼š

- [[TypeScript & Reactç¤ºä¾‹ä¸åŸå§‹çš„ `execute` å’Œå†…ç½®çš„ GraphQL-Codegen](../examples/execute)
- [TS/JS NodeJSç‹¬ç«‹æ¨¡å¼](../examples/node)
- [å®¢æˆ·ç«¯ GraphQL ç»„åˆ](../examples/composition)
- [ä¸Urql å’Œ Reacté›†æˆ](../examples/urql)
- [ä¸NextJS å’Œ TypeScripté›†æˆ](../examples/nextjs)
- [ä¸Apollo-Client å’Œ Reacté›†æˆ](../examples/apollo)
- [ä¸React-Queryé›†æˆ](../examples/react-query)
- _è·¨é“¾åˆå¹¶ (ç›¸åŒçš„å­å›¾ï¼Œä¸åŒçš„é“¾)_
- - [å¹¶è¡Œçš„ SDK è°ƒç”¨](../examples/cross-chain-sdk)
- - [å…·æœ‰æ¨¡å¼æ‰©å±•çš„å¹¶è¡Œå†…éƒ¨è°ƒç”¨](../examples/cross-chain-extension)
- [ä½¿ç”¨Transformsï¼ˆè‡ªåŠ¨åˆ†é¡µå’Œè‡ªåŠ¨å—è·Ÿè¸ªï¼‰è‡ªå®šä¹‰æ‰§è¡Œ](../examples/transforms)

### é«˜çº§ç¤ºä¾‹/åŠŸèƒ½

#### è‡ªå®šä¹‰ç½‘ç»œè°ƒç”¨

æ‚¨å¯ä»¥ä½¿ç”¨`operationHeaders`è‡ªå®šä¹‰ç½‘ç»œæ‰§è¡Œ (ä¾‹å¦‚ï¼Œæ·»åŠ èº«ä»½éªŒè¯å¤´)ï¼š

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
        operationHeaders:
          Authorization: Bearer MY_TOKEN
```

å¦‚æœæ‚¨æ„¿æ„ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨è¿è¡Œæ—¶å˜é‡ï¼Œå¹¶ä»¥å£°æ˜æ–¹å¼æŒ‡å®šï¼š

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
        operationHeaders:
          Authorization: Bearer {context.config.apiToken}
```

ç„¶åï¼Œæ‚¨å¯ä»¥æŒ‡å®šå½“æ‚¨æ‰§è¡Œæ“ä½œæ—¶ï¼š

```ts
execute(myQuery, myVariables, {
  config: {
    apiToken: 'MY_TOKEN',
  },
})
```

> æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ° [`graphql` å¤„ç†ç¨‹åºçš„å®Œæ•´æ–‡æ¡£](https://graphql-mesh.com/docs/handlers/graphql#config-api-reference)ã€‚

#### ç¯å¢ƒå˜é‡å†…æ’å€¼

å¦‚æœä½ æƒ³è¦åœ¨ä½ çš„Graphå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä½ å¯ä»¥ä½¿ç”¨ `env` åŠ©æ‰‹çš„æ’å€¼ï¼š

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
        operationHeaders:
          Authorization: Bearer {env.MY_API_TOKEN} # runtime
```

ç„¶åï¼Œè¯·ç¡®ä¿åœ¨è¿è¡Œ`process.env`æ—¶å®šä¹‰`MY_API_TOKEN`ã€‚

æ‚¨è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ Env-var åç§°æŒ‡å®šè¦åœ¨æ„å»ºæ—¶é—´(åœ¨ `graphclient build` è¿è¡Œæ—¶) å¡«å……çš„ç¯å¢ƒå˜é‡ï¼š

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
        operationHeaders:
          Authorization: Bearer ${MY_API_TOKEN} # build time
```

> æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ° [`graphql` å¤„ç†ç¨‹åºçš„å®Œæ•´æ–‡æ¡£](https://graphql-mesh.com/docs/handlers/graphql#config-api-reference)ã€‚

#### è·å–ç­–ç•¥å’Œå¤šå›¾ç´¢å¼•äºº

åœ¨dAppä¸­ä½¿ç”¨å¤šä¸ªç´¢å¼•äººæ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œä»¥ä¾¿å®ç°ç†æƒ³çš„The Graphä½“éªŒï¼Œ ä½ å¯ä»¥æŒ‡å®š `fetch` çš„å‡ ç§ç­–ç•¥æ¥ä½¿å®ƒæ›´åŠ é¡ºç•…å’Œç®€å•ã€‚

æ‰€æœ‰çš„ `fetch` ç­–ç•¥å¯ä»¥åˆå¹¶æ¥åˆ›å»ºæœ€ç»ˆçš„æ‰§è¡Œæµç¨‹ã€‚

<details>
 <summary>"é‡è¯•"</summary>

`é‡è¯•`æœºåˆ¶å…è®¸æ‚¨æŒ‡å®šé‡è¯•å•ä¸ªGraphQLç«¯ç‚¹/æºçš„å°è¯•ã€‚

é‡è¯•å°†åœ¨ä¸¤ä¸ªæ¡ä»¶ä¸‹æ‰§è¡Œï¼šç½‘ç»œé”™è¯¯æˆ–è¿è¡Œæ—¶é”™è¯¯(ç´¢å¼•é—®é¢˜/ç´¢å¼•äººä¸å¯ç”¨)ã€‚

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
        retry: 2 # specify here, if you have an unstable/error prone indexer
```

</details>

<details>
 <summary>"è¶…æ—¶"</summary>

`è¶…æ—¶`æœºåˆ¶å…è®¸æ‚¨ä¸ºç»™å®šçš„ GraphQL ç«¯ç‚¹æŒ‡å®š`è¶…æ—¶` ã€‚

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
        timeout: 5000 # 5 seconds
```

</details>

<details>
 <summary>â€œfallbackâ€</summary>

`fallback`æœºåˆ¶å…è®¸æ‚¨ä¸ºåŒä¸€æ¥æºæŒ‡å®šå¤šä¸ªGraphQLç«¯ç‚¹ã€‚

å¦‚æœæ‚¨æƒ³è¦ä¸ºåŒä¸€ä¸ªå­å›¾ä½¿ç”¨å¤šä¸ªç´¢å¼•äººï¼Œå¹¶åœ¨å‘ç”Ÿé”™è¯¯/è¶…æ—¶æ—¶æ—¶è¿›è¡Œå›é€€ï¼Œè¿™æ˜¯æœ‰ç”¨çš„ã€‚ æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤ç­–ç•¥æ¥ä½¿ç”¨è‡ªå®šä¹‰ç´¢å¼•äººï¼Œä½†å…è®¸å®ƒå›é€€åˆ° [The Graphæ‰˜ç®¡æœåŠ¡](https://thegraph.com/hosted-service)ã€‚

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        strategy: fallback
        sources:
          - endpoint: https://bad-uniswap-v2-api.com
            retry: 2
            timeout: 5000
          - endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
```

</details>

<details>
 <summary>"ç«æŠ€"</summary>

â€œç§æ—â€æœºåˆ¶å…è®¸æ‚¨ä¸ºåŒä¸€æºæŒ‡å®šå¤šä¸ªGraphQLç«¯ç‚¹ï¼Œä»¥åŠæ¯æ¬¡æ‰§è¡Œæ—¶çš„ç«èµ›ã€‚

å¦‚æœä½ æƒ³è¦åœ¨åŒä¸€ä¸ªå­å›¾ä¸­ä½¿ç”¨å¤šä¸ªç´¢å¼•äººï¼Œè¿™æ˜¯æœ‰ç”¨çš„ï¼Œ å¹¶ä¸”å…è®¸è¿™ä¸¤ä¸ªæ¥æºè¿›è¡Œç«èµ›ï¼Œå¹¶ä»æ‰€æœ‰æŒ‡å®šçš„ç´¢å¼•äººè·å¾—æœ€å¿«çš„å“åº”ã€‚

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        strategy: race
        sources:
          - endpoint: https://bad-uniswap-v2-api.com
          - endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
```

</details>

<details>
  <summary>"æœ€é«˜å€¼"</summary>

æ­¤ç­–ç•¥å…è®¸æ‚¨å°†å¹¶è¡Œè¯·æ±‚å‘é€åˆ°åŒä¸€æºçš„ä¸åŒç«¯ç‚¹å¹¶é€‰æ‹©æœ€å…ˆè¿›çš„ç«¯ç‚¹ã€‚

å¦‚æœæ‚¨æƒ³è¦ä»ä¸åŒçš„ç´¢å¼•äºº/æºé€‰æ‹©åŒä¸€å­å›¾ä¸­æœ€å¸¸åŒæ­¥çš„æ•°æ®ï¼Œè¿™æ˜¯æœ‰ç”¨çš„ã€‚

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        strategy: highestValue
        strategyConfig:
          selectionSet: |
            {
              _meta {
                block {
                  number
                }
              }
            }
          value: '_meta.block.number'
        sources:
          - endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2-1
          - endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2-2
```

```mermaid
graph LR;
    subgraph most-synced
    req(Outgoing Query)-->sA[Subgraph A];
    sA-->d{MostSyncedStrategy};
    d-->s1[Source 1];
    d-->s2[Source 2];
    s1-->synced["process"]
    s2-->synced
    synced-->|"max(_meta.block_number)"|d
    end
```

</details>

#### åŒºå—è·Ÿè¸ª

Graphå®¢æˆ·ç«¯å¯ä»¥è·Ÿè¸ªå—å·ç å¹¶é€šè¿‡ `blockTracking` è½¬æ¢é€šè¿‡ [æ­¤æ¨¡å¼](https://thegraph.com/docs/en/developer/distributed-systems/#polling-for-updated-data)è¿›è¡Œä»¥ä¸‹æŸ¥è¯¢:

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
    transforms:
      - blockTracking:
          # You might want to disable schema validation for faster startup
          validateSchema: true
          # Ignore the fields that you don't want to be tracked
          ignoreFieldNames: [users, prices]
          # Exclude the operation with the following names
          ignoreOperationNames: [NotFollowed]
```

[æ‚¨å¯ä»¥åœ¨æ­¤å°è¯•ä¸€ä¸ªå·¥ä½œç¤ºä¾‹](../examples/transforms)ã€‚

#### è‡ªåŠ¨åˆ†é¡µ

å¯¹å¤§å¤šæ•°å­å›¾ï¼Œæ‚¨å¯ä»¥è·å–çš„è®°å½•æ•°é‡æ˜¯æœ‰é™çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¿…é¡»å‘é€å¤šä¸ªå¸¦åˆ†é¡µçš„è¯·æ±‚ã€‚

```graphql
query {
  # Will throw an error if the limit is 1000
  users(first: 2000) {
    id
    name
  }
}
```

æ‰€ä»¥ä½ å¿…é¡»ä¸€ä¸ªæ¥ä¸€ä¸ªçš„å‘é€æ“ä½œï¼š

```graphql
query {
  # Will throw an error if the limit is 1000
  users(first: 1000) {
    id
    name
  }
}
```

ç„¶ååœ¨ç¬¬ä¸€ä¸ªå“åº”ä¹‹åï¼š

```graphql
query {
  # Will throw an error if the limit is 1000
  users(first: 1000, skip: 1000) {
    id
    name
  }
}
```

åœ¨ç¬¬äºŒä¸ªå“åº”åï¼Œæ‚¨å¿…é¡»æ‰‹åŠ¨åˆå¹¶ç»“æœã€‚ ä½†æ˜¯The Graphå®¢æˆ·ç«¯å…è®¸æ‚¨åšç¬¬ä¸€ä¸ªï¼Œå¹¶è‡ªåŠ¨ä¸ºæ‚¨åœ¨åœºæ™¯ä¸‹æ‰§è¡Œè¿™äº›å¤šä¸ªè¯·æ±‚ã€‚

æ‚¨å¿…é¡»åšçš„æ˜¯ï¼š

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
    transforms:
      - autoPagination:
          # You might want to disable schema validation for faster startup
          validateSchema: true
```

[æ‚¨å¯ä»¥åœ¨æ­¤å°è¯•ä¸€ä¸ªå·¥ä½œç¤ºä¾‹](../examples/transforms)ã€‚

#### å®¢æˆ·ç«¯ç»„æˆ

The Graphå®¢æˆ·ç«¯å†…ç½®æ”¯æŒå®¢æˆ·ç«¯GraphQLç»„æˆ(ç”± [GraphQL-Tools Schema-Stitching](https://graphql-tools.com/docs/schema-stitching/stitch-combining-schemas)é©±åŠ¨)ã€‚

æ‚¨å¯ä»¥åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œä»å¤šä¸ªå­å›¾ä¸­åˆ›å»ºä¸€ä¸ªå•ä¸€çš„ GraphQL å±‚ï¼Œéƒ¨ç½²åœ¨å¤šä¸ªç´¢å¼•äººã€‚

> ğŸ’¡ æç¤º: ä½ å¯ä»¥åˆ›å»ºä»»ä½•GraphQLæº, è€Œä¸ä»…ä»…æ˜¯å­å›¾ï¼

å¯é€šè¿‡å°†å¤šä¸ªGraphQLæºæ·»åŠ åˆ°æ‚¨çš„ `.graphclientrc.yml` æ–‡ä»¶æ¥å®Œæˆä¸‰è§’åˆæˆï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```yaml
sources:
  - name: uniswapv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/uniswap/uniswap-v2
  - name: compoundv2
    handler:
      graphql:
        endpoint: https://api.thegraph.com/subgraphs/name/graphprotocol/compound-v2
```

åªè¦åœ¨åˆæˆæ¨¡å¼ä¹‹é—´æ²¡æœ‰å†²çªï¼Œæ‚¨å°±å¯ä»¥ç¼–å†™å®ƒï¼Œç„¶åå¯¹ä¸¤ä¸ªå­å›¾æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ï¼š

```graphql
query myQuery {
  # this one is coming from compound-v2
  markets(first: 7) {
    borrowRate
  }
  # this one is coming from uniswap-v2
  pair(id: "0x00004ee988665cdda9a1080d5792cecd16dc1220") {
    id
    token0 {
      id
    }
    token1 {
      id
    }
  }
}
```

æ‚¨ä¹Ÿå¯ä»¥è§£å†³å†²çªï¼Œé‡å‘½åæ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼Œæ·»åŠ è‡ªå®šä¹‰ GraphQL å­—æ®µï¼Œå¹¶ä¿®æ”¹æ•´ä¸ªæ‰§è¡Œé˜¶æ®µã€‚

å…³äºç”±äººå‘˜ç»„æˆçš„é«˜çº§ä½¿ç”¨æ¡ˆä¾‹ï¼Œè¯·å‚è€ƒä»¥ä¸‹èµ„æºï¼š

- [Advanced Composition Example](../examples/composition)
- [GraphQL-Mesh Schema transformations](https://graphql-mesh.com/docs/transforms/transforms-introduction)
- [GraphQL-Tools Schema-Stitching documentation](https://graphql-tools.com/docs/schema-stitching/stitch-combining-schemas)

#### TypeScript æ”¯æŒ

å¦‚æœä½ çš„é¡¹ç›®æ˜¯åœ¨TypeScriptå†™çš„ï¼Œä½ å¯ä»¥åˆ©ç”¨[`TypedDocumentNode`](https://the-guild.dev/blog/typed-document-node)çš„åŠ›é‡ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„GraphQLå®¢æˆ·ç«¯ä½“éªŒã€‚

The standalone mode of The GraphQL, and popular GraphQL client libraries like Apollo-Client and urql has built-in support for `TypedDocumentNode`!

The Graphå®¢æˆ·ç«¯CLIå¸¦æœ‰ä¸€ä¸ªç°æˆé…ç½®çš„ [GraphQL ä»£ç ç”Ÿæˆå™¨](https://graphql-code-generator.com)ï¼Œå®ƒå¯ä»¥æ ¹æ®æ‚¨çš„ GraphQL æ“ä½œç”Ÿæˆ`TypedDocumentNode` ã€‚

è¦å¯åŠ¨ï¼Œè¯·åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­å®šä¹‰æ‚¨çš„ GraphQL æ“ä½œï¼Œå¹¶æŒ‡å‘ä½¿ç”¨ `.graphclientrc.yml` ä¸­çš„ `documents` éƒ¨åˆ†çš„æ–‡ä»¶ï¼š

```yaml
sources:
  -  # ... your Subgraphs/GQL sources here

documents:
  - ./src/example-query.graphql
```

æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ Glob è¡¨è¾¾å¼ï¼Œç”šè‡³æŒ‡å‘ä»£ç æ–‡ä»¶ï¼ŒCLI ä¼šè‡ªåŠ¨æ‰¾åˆ°æ‚¨çš„ GraphQL æŸ¥è¯¢ï¼š

```yaml
documents:
  - './src/**/*.graphql'
  - './src/**/*.{ts,tsx,js,jsx}'
```

ç°åœ¨ï¼Œå†æ¬¡è¿è¡Œ GraphQL CLI `build` å‘½ä»¤ï¼ŒCLI å°†åœ¨`.graphclient`ä¸‹ä¸ºæ‰¾åˆ°çš„æ¯ä¸ªæ“ä½œç”Ÿæˆä¸€ä¸ª `TypedDocumentNode` å¯¹è±¡ã€‚

> è¯·åŠ¡å¿…å‘½åæ‚¨çš„ GraphQL æ“ä½œï¼Œå¦åˆ™å°†è¢«å¿½ç•¥ï¼

ä¾‹å¦‚ï¼Œä¸€ä¸ªå«åš`query ExampleQuery`çš„æŸ¥è¯¢å°†åœ¨`.graphclient`ä¸­ç”Ÿæˆç›¸åº”çš„`ExampleQueryDocument`ã€‚ æ‚¨ç°åœ¨å¯ä»¥å¯¼å…¥å®ƒå¹¶ç”¨äºæ‚¨çš„ GraphQL è°ƒç”¨ï¼Œ æ‚¨å°†æ‹¥æœ‰å®Œæ•´ç±»å‹çš„ä½“éªŒï¼Œæ— éœ€æ‰‹åŠ¨å†™å…¥æˆ–æŒ‡å®šä»»ä½•ç±»å‹è„šæœ¬ï¼š

```ts
import { ExampleQueryDocument, execute } from '../.graphclient'

async function main() {
  // "result" variable is fully typed, and represents the exact structure of the fields you selected in your query.
  const result = await execute(ExampleQueryDocument, {})
  console.log(result)
}
```

> ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ª[TypeScripté¡¹ç›®ç¤ºä¾‹](../examples/urql)ã€‚

#### å®¢æˆ·ç«¯çªå˜

ç”±äºGraph-å®¢æˆ·ç«¯è®¾ç½®çš„æ€§è´¨ï¼Œå¯ä»¥æ·»åŠ å®¢æˆ·ç«¯æ¨¡å¼ï¼Œæ‚¨ä»¥åå¯ä»¥é€šè¿‡æ¡¥æ¥è¿è¡Œä»»æ„ä»£ç ã€‚

è¿™å¾ˆæœ‰å¸®åŠ©ï¼Œå› ä¸ºæ‚¨å¯ä»¥å®ç°è‡ªå®šä¹‰ä»£ç ä½œä¸ºæ‚¨çš„ GraphQL æ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼Œ è®©å®ƒä½œä¸ºç»Ÿä¸€çš„åº”ç”¨ç¨‹åºæ¨¡å¼æ›´å®¹æ˜“è·Ÿè¸ªå’Œå‘å±•ã€‚

> æœ¬æ–‡æ¡£è§£é‡Šäº†å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰çªå˜ï¼Œä½†äº‹å®ä¸Šï¼Œæ‚¨å¯ä»¥æ·»åŠ ä»»ä½•GraphQLæ“ä½œï¼ˆæŸ¥è¯¢/çªå˜/è®¢é˜…ï¼‰ã€‚è¯·å‚é˜…[æ‰©å±•ç»Ÿä¸€æ¨¡å¼æ–‡ç« ](https://graphql-mesh.com/docs/guides/extending-unified-schema)è·å–æœ‰å…³æ­¤åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ã€‚

è¦å¯åŠ¨ï¼Œè¯·åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ª `additionalTypeDefs` éƒ¨åˆ†ï¼š

```yaml
additionalTypeDefs: |
  # We should define the missing `Mutation` type
  extend schema {
    mutation: Mutation
  }

  type Mutation {
    doSomething(input: SomeCustomInput!): Boolean!
  }

  input SomeCustomInput {
    field: String!
  }
```

ç„¶åï¼Œåœ¨è‡ªå®šä¹‰GraphQLè§£æå™¨æ–‡ä»¶ä¸­æ·»åŠ æŒ‡é’ˆï¼š

```yaml
additionalResolvers:
  - './resolvers'
```

ç°åœ¨ï¼Œåœ¨ä½ çš„é¡¹ç›®ä¸­åˆ›å»º `resolver.js` (æˆ–`resolvers.ts`)ï¼Œå¹¶å®ç°ä½ çš„è‡ªå®šä¹‰çªå˜ï¼š

```js
module.exports = {
  Mutation: {
    async doSomething(root, args, context, info) {
      // Here, you can run anything you wish.
      // For example, use `web3` lib, connect a wallet and so on.

      return true
    },
  },
}
```

å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ TypeScriptï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ“ä½œè·å¾—å®Œå…¨å®‰å…¨ç±»å‹çš„ç­¾åï¼š

```ts
import { Resolvers } from './.graphclient'

// Now it's fully typed!
const resolvers: Resolvers = {
  Mutation: {
    async doSomething(root, args, context, info) {
      // Here, you can run anything you wish.
      // For example, use `web3` lib, connect a wallet and so on.

      return true
    },
  },
}

export default resolvers
```

å¦‚æœæ‚¨éœ€è¦å°†è¿è¡Œæ—¶å˜é‡æ³¨å…¥åˆ°æ‚¨çš„ GraphQL æ‰§è¡Œ`context`ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š

```ts
execute(
  MY_QUERY,
  {},
  {
    myHelper: {}, // this will be available in your Mutation resolver as `context.myHelper`
  },
)
```

> [æ‚¨å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºå®¢æˆ·ç«¯æ¨¡å¼æ‰©å±•çš„ä¿¡æ¯](https://graphql-mesh.com/docs/guides/extending-unified-schema)ã€‚

> [æ‚¨ä¹Ÿå¯ä»¥å§”æ‰˜å’Œé€šè¯æŸ¥è¯¢å­—æ®µä½œä¸ºæ‚¨çš„çªå˜çš„ä¸€éƒ¨åˆ†](https://graphql-mesh.com/docs/guides/extending-unified-schema#using-the-sdk-to-fetch-sources)ã€‚

## è®¸å¯åè®®

åœ¨ [MIT license](../LICENSE)ä¸‹å‘å¸ƒã€‚
