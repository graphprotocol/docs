---
title: Construção de Subgraphs na NEAR
---

This guide is an introduction to building Subgraphs indexing smart contracts on the [NEAR blockchain](https://docs.near.org/).

## O que é NEAR?

[NEAR](https://near.org/) é uma plataforma de contrato inteligente para construir aplicativos descentralizados. Visite a [documentação oficial](https://docs.near.org/concepts/basics/protocol) para mais informações.

## What are NEAR Subgraphs?

The Graph gives developers tools to process blockchain events and make the resulting data easily available via a GraphQL API, known individually as a Subgraph. [Graph Node](https://github.com/graphprotocol/graph-node) is now able to process NEAR events, which means that NEAR developers can now build Subgraphs to index their smart contracts.

Subgraphs are event-based, which means that they listen for and then process onchain events. There are currently two types of handlers supported for NEAR Subgraphs:

- Handlers de blocos: executados em todos os blocos novos
- Handlers de recibos: Executados sempre que uma mensagem é executada numa conta especificada

[Da documentação da NEAR](https://docs.near.org/build/data-infrastructure/lake-data-structures/receipt):

> Um Recibo é o único objeto acionável no sistema. Quando falamos de "processar uma transação" na plataforma NEAR, em algum ponto isto eventualmente significa "aplicar recibos".

## Construindo um Subgraph no NEAR

`@graphprotocol/graph-cli` is a command-line tool for building and deploying Subgraphs.

`@graphprotocol/graph-ts` is a library of Subgraph-specific types.

NEAR Subgraph development requires `graph-cli` above version `0.23.0`, and `graph-ts` above version `0.23.0`.

> Building a NEAR Subgraph is very similar to building a Subgraph that indexes Ethereum.

There are three aspects of Subgraph definition:

**subgraph.yaml:** the Subgraph manifest, defining the data sources of interest, and how they should be processed. NEAR is a new `kind` of data source.

**schema.graphql:** a schema file that defines what data is stored for your Subgraph, and how to query it via GraphQL. The requirements for NEAR Subgraphs are covered by [the existing documentation](/developing/creating-a-subgraph/#the-graphql-schema).

**Mapeamentos de AssemblyScript:** [Código AssemblyScript](/subgraphs/developing/creating/graph-ts/api/) que traduz dos dados do evento para as entidades definidas no seu esquema. O apoio à NEAR introduz tipos de dados específicos da NEAR e novas funções de análise JSON.

During Subgraph development there are two key commands:

```bash
$ graph codegen # generates types from the schema file identified in the manifest
$ graph build # generates Web Assembly from the AssemblyScript files, and prepares all the Subgraph files in a /build folder
```

### Definição de Manifest de Subgraph

The Subgraph manifest (`subgraph.yaml`) identifies the data sources for the Subgraph, the triggers of interest, and the functions that should be run in response to those triggers. See below for an example Subgraph manifest for a NEAR Subgraph:

```yaml
specVersion: 1.3.0
schema:
  file: ./src/schema.graphql # link to the schema file
dataSources:
  - kind: near
    network: near-mainnet
    source:
      account: app.good-morning.near # This data source will monitor this account
      startBlock: 10662188 # Required for NEAR
    mapping:
      apiVersion: 0.0.9
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # the function name in the mapping file
      receiptHandlers:
        - handler: handleReceipt # the function name in the mapping file
      file: ./src/mapping.ts # link to the file with the Assemblyscript mappings
```

- NEAR Subgraphs introduce a new `kind` of data source (`near`)
- O `network` deve corresponder a uma rede no Graph Node hóspede. No Subgraph Studio, a mainnet da NEAR é `near-mainnet`, e a testnet da NEAR é `near-testnet`
- Fontes de dados na NEAR introduzem um campo `source.account` opcional: uma ID legível a humanos que corresponde a uma [conta na NEAR](https://docs.near.org/concepts/protocol/account-model). Isto pode ser uma conta ou subconta.
- As fontes de dados da NEAR introduzem um campo alternativo `source.accounts` opcional, que contém sufixos e prefixos opcionais. Pelo menos prefix ou sufixo deve ser especificado, eles corresponderão a qualquer conta que comece ou termine com a lista de valores, respectivamente. O exemplo abaixo corresponderia a: `[app|good].*[morning.near|morning.testnet]`. Se apenas uma lista de prefixos ou sufixos for necessária, o outro campo pode ser omitido.

```yaml
accounts:
  prefixes:
    - app
    - good
  suffixes:
    - morning.near
    - morning.testnet
```

As fontes de dados na NEAR apoiam duas categorias de handlers:

- `blockHandlers`: executado em cada novo bloco na NEAR. Não é necessário nenhum `source.account`.
- `receiptHandlers`: executados em todo recibo onde o `source.account` da fonte de dados é o recipiente. Note que só são processadas combinações exatas ([subcontas](https://docs.near.org/tutorials/crosswords/basics/add-functions-call#create-a-subaccount) devem ser adicionadas como fontes de dados independentes).

### Definição de Schema

Schema definition describes the structure of the resulting Subgraph database and the relationships between entities. This is agnostic of the original data source. There are more details on Subgraph schema definition [here](/developing/creating-a-subgraph/#the-graphql-schema).

### Mapeamentos em AssemblyScript

Os handlers para processamento de eventos estão escritos em [AssemblyScript](https://www.assemblyscript.org/).

A indexação da NEAR introduz tipos de dados específicos desse ecossistema à [API do AssemblyScript](/subgraphs/developing/creating/graph-ts/api/).

```typescript

class ExecutionOutcome {
      gasBurnt: u64,
      blockHash: Bytes,
      id: Bytes,
      logs: Array<string>,
      receiptIds: Array<Bytes>,
      tokensBurnt: BigInt,
      executorId: string,
  }

class ActionReceipt {
      predecessorId: string,
      receiverId: string,
      id: CryptoHash,
      signerId: string,
      gasPrice: BigInt,
      outputDataReceivers: Array<DataReceiver>,
      inputDataIds: Array<CryptoHash>,
      actions: Array<ActionValue>,
  }

class BlockHeader {
      height: u64,
      prevHeight: u64,// Always zero when version < V3
      epochId: Bytes,
      nextEpochId: Bytes,
      chunksIncluded: u64,
      hash: Bytes,
      prevHash: Bytes,
      timestampNanosec: u64,
      randomValue: Bytes,
      gasPrice: BigInt,
      totalSupply: BigInt,
      latestProtocolVersion: u32,
  }

class ChunkHeader {
      gasUsed: u64,
      gasLimit: u64,
      shardId: u64,
      chunkHash: Bytes,
      prevBlockHash: Bytes,
      balanceBurnt: BigInt,
  }

class Block {
      author: string,
      header: BlockHeader,
      chunks: Array<ChunkHeader>,
  }

class ReceiptWithOutcome {
      outcome: ExecutionOutcome,
      receipt: ActionReceipt,
      block: Block,
  }
```

Estes tipos são repassados para handlers de blocos e recibos:

- Handlers de blocos receberão um `Block`
- Handlers de recibos receberão um `ReceiptWithOutcome`

Otherwise, the rest of the [AssemblyScript API](/subgraphs/developing/creating/graph-ts/api/) is available to NEAR Subgraph developers during mapping execution.

Isto inclui uma nova função de análise em JSON: logs na NEAR são frequentemente emitidos como JSONs em string. A nova função json.fromString(...) está disponível como parte da [API JSON](/subgraphs/developing/creating/graph-ts/api/#json-api) para que programadores processem estes logs com mais facilidade.

## Lançando um Subgraph na NEAR

Once you have a built Subgraph, it is time to deploy it to Graph Node for indexing. NEAR Subgraphs can be deployed to any Graph Node `>=v0.26.x` (this version has not yet been tagged & released).

O Subgraph Studio e o Indexador de atualização na Graph Network apoiam atualmente a indexação da mainnet e da testnet do NEAR em beta, com os seguintes nomes de rede:

- `near-mainnet`
- `near-testnet`

More information on creating and deploying Subgraphs on Subgraph Studio can be found [here](/deploying/deploying-a-subgraph-to-studio/).

As a quick primer - the first step is to "create" your Subgraph - this only needs to be done once. On Subgraph Studio, this can be done from [your Dashboard](https://thegraph.com/studio/): "Create a Subgraph".

Once your Subgraph has been created, you can deploy your Subgraph by using the `graph deploy` CLI command:

```sh
$ graph create --node <graph-node-url> <subgraph-name> # creates a Subgraph on a local Graph Node (on Subgraph Studio, this is done via the UI)
$ graph deploy --node <graph-node-url> --ipfs https://api.thegraph.com/ipfs/ <subgraph-name> # uploads the build files to a specified IPFS endpoint, and then deploys the Subgraph to a specified Graph Node based on the manifest IPFS hash
```

The node configuration will depend on where the Subgraph is being deployed.

### Subgraph Studio

```sh
graph auth
graph deploy <subgraph-name>
```

### Graph Node local (baseado na configuração padrão)

```sh
graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001 <subgraph-name>
```

Once your Subgraph has been deployed, it will be indexed by Graph Node. You can check its progress by querying the Subgraph itself:

```graphql
{
  _meta {
    block {
      number
    }
  }
}
```

### Como indexar a NEAR com um Graph Node local

Executar um Graph Node que indexa a NEAR exige estes requisitos opcionais:

- NEAR Indexer Framework (Estrutura de Indexer) com instrumentação Firehose
- Componente(s) de Firehose no NEAR
- Graph Node com endpoint Firehose configurado

Em breve, falaremos mais sobre como executar os componentes acima.

## Como Consultar um Subgraph na NEAR

The GraphQL endpoint for NEAR Subgraphs is determined by the schema definition, with the existing API interface. Please visit the [GraphQL API documentation](/subgraphs/querying/graphql-api/) for more information.

## Exemplos de Subgraphs

Here are some example Subgraphs for reference:

[Blocos da NEAR](https://github.com/graphprotocol/graph-tooling/tree/main/examples/near-blocks)

[Recibos da NEAR](https://github.com/graphprotocol/graph-tooling/tree/main/examples/near-receipts)

## Perguntas Frequentes

### Como o beta funciona?

NEAR support is in beta, which means that there may be changes to the API as we continue to work on improving the integration. Please email near@thegraph.com so that we can support you in building NEAR Subgraphs, and keep you up to date on the latest developments!

### Can a Subgraph index both NEAR and EVM chains?

No, a Subgraph can only support data sources from one chain/network.

### Can Subgraphs react to more specific triggers?

Atualmente, só há apoio a gatilhos de Blocos e Recibos. Estamos a investigar gatilhos para chamadas de função a uma conta específica. Também temos interesse em apoiar gatilhos de eventos, quando a NEAR receber apoio nativo a eventos.

### Handlers de recibos ativarão para contas e subcontas?

Se uma conta (`account`) for especificada, ela só combinará com o nome exacto da conta. É possível corresponder subcontas ao especificar um campo `accounts`, com sufixos (`suffixes`) e prefixos (`prefixes`) particularizados para encontrar contas e subcontas. Por exemplo, todas as subcontas `mintbase1.near` seriam encontradas com o seguinte:

```yaml
accounts:
  suffixes:
    - mintbase1.near
```

### Can NEAR Subgraphs make view calls to NEAR accounts during mappings?

Não há apoio a isto. Estamos a avaliar se esta funcionalidade é necessária para indexação.

### Can I use data source templates in my NEAR Subgraph?

Não há apoio a isto no momento. Estamos a avaliar se esta funcionalidade é necessária para indexação.

### Ethereum Subgraphs support "pending" and "current" versions, how can I deploy a "pending" version of a NEAR Subgraph?

Pending functionality is not yet supported for NEAR Subgraphs. In the interim, you can deploy a new version to a different "named" Subgraph, and then when that is synced with the chain head, you can redeploy to your primary "named" Subgraph, which will use the same underlying deployment ID, so the main Subgraph will be instantly synced.

### My question hasn't been answered, where can I get more help building NEAR Subgraphs?

If it is a general question about Subgraph development, there is a lot more information in the rest of the [Developer documentation](/subgraphs/quick-start/). Otherwise please join [The Graph Protocol Discord](https://discord.gg/graphprotocol) and ask in the #near channel or email near@thegraph.com.

## Referências

- [Documentação para programadores na NEAR](https://docs.near.org/tutorials/crosswords/basics/set-up-skeleton)
