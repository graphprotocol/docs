---
title: TAP-Migrationsleitfaden
---

Erfahren Sie mehr über das neue Zahlungssystem von The Graph, **Timeline Aggregation Protocol, TAP**. Dieses System bietet schnelle, effiziente Mikrotransaktionen mit minimiertem Vertrauen.

## Überblick

[TAP] (https://docs.rs/tap_core/latest/tap_core/index.html) ist ein direkter Ersatz für das derzeitige Scalar-Zahlungssystem. Es bietet die folgenden Hauptfunktionen:

- Effiziente Abwicklung von Mikrozahlungen.
- Fügt den Onchain-Transaktionen und -Kosten eine weitere Ebene der Konsolidierung hinzu.
- Ermöglicht den Indexern die Kontrolle über Eingänge und Zahlungen und garantiert die Bezahlung von Abfragen.
- Es ermöglicht dezentralisierte, vertrauenslose Gateways und verbessert die Leistung des `indexer-service` für mehrere Absender.

## Besonderheiten

TAP ermöglicht es einem Sender, mehrere Zahlungen an einen Empfänger zu leisten, **TAP Receipts**, der diese Zahlungen zu einer einzigen Zahlung zusammenfasst, einem **Receipt Aggregate Voucher**, auch bekannt als **RAV**. Diese aggregierte Zahlung kann dann auf der Blockchain verifiziert werden, wodurch sich die Anzahl der Transaktionen verringert und der Zahlungsvorgang vereinfacht wird.

Für jede Abfrage sendet Ihnen das Gateway eine „signierte Quittung“, die in Ihrer Datenbank gespeichert wird. Dann werden diese Abfragen von einem „Tap-Agent“ durch eine Anfrage aggregiert. Anschließend erhalten Sie ein RAV. Sie können ein RAV aktualisieren, indem Sie es mit neueren Quittungen senden, wodurch ein neues RAV mit einem höheren Wert erzeugt wird.

### RAV-Details

- Es ist Geld, das darauf wartet, an die Blockchain gesendet zu werden.

- Es werden weiterhin Anträge auf Zusammenlegung stellen und sicherstellen, dass der Gesamtwert der nicht zusammengefassten Einnahmen `amount willing to lose` (den „Betrag, den man zu verlieren bereit ist“), nicht übersteigt.

- Jedes RAV kann einmal in den Verträgen eingelöst werden, weshalb sie nach Abschluss der Zuteilung versandt werden.

### Einlösen des RAV

Solange Sie `tap-agent` und `indexer-agent` ausführen, wird alles automatisch ausgeführt. Im Folgenden finden Sie eine detaillierte Aufschlüsselung des Prozesses:

1. Ein Indexer schließt die Zuteilung ab.

2. `<recently-closed-allocation-buffer> period, tap-agent` nimmt alle ausstehenden Quittungen für diese spezifische Zuteilung und fordert eine Aggregation in einem RAV an, wobei es als `last` gekennzeichnet wird.

3. `indexer-agent` nimmt alle letzten RAVS und sendet Einlöseanforderungen an die Blockchain, die den Wert von ‚redeem_at‘ aktualisiert.

4. Während der `<finality-time>`-Periode überwacht der `indexer-agent`, ob es in der Blockchain irgendwelche Reorganisationen gibt, die die Transaktion rückgängig machen.

   - Wurde es rückgängig gemacht, wird das RAV erneut an die Blockchain gesendet. Wenn es nicht rückgängig gemacht wurde, wird es als `final` markiert.

## Blockchain-Adressen

### Verträge

| Vertrag                    | Arbitrum Mainnet (42161)                     | Arbitrum Sepolia (421614)                    |
| -------------------------- | -------------------------------------------- | -------------------------------------------- |
| TAP-Prüfer                 | `0x33f9E93266ce0E108fc85DdE2f71dab555A0F05a` | `0xfC24cE7a4428A6B89B52645243662A02BA734ECF` |
| AllocationIDTracker        | `0x5B2F33d7Ca6Ec88f5586f2528f58c20843D9FE7c` | `0xAaC28a10d707bbc6e02029f1bfDAEB5084b2aD11` |
| Treuhandkonto              | `0x8f477709eF277d4A880801D01A140a9CF88bA0d3` | `0x1e4dC4f9F95E102635D8F7ED71c5CdbFa20e2d02` |

### Gateway

| Komponente       | Edge- und Node-Mainnet (Arbitrum-Mainnet)      | Edge and Node Testnet (Arbitrum Sepolia)      |
| ---------------- | ---------------------------------------------- | --------------------------------------------- |
| Sender           | `0xDDE4cfFd3D9052A9cb618fC05a1Cd02be1f2F467`   | `0xC3dDf37906724732FfD748057FEBe23379b0710D`  |
| Unterzeichner    | `0xfF4B7A5EfD00Ff2EC3518D4F250A27e4c29A2211`   | `0xFb142dE83E261e43a81e9ACEADd1c66A0DB121FE`  |
| Aggregator       | `https://tap-aggregator.network.thegraph.com`  | `https://tap-aggregator.testnet.thegraph.com` |

### Anforderungen

Zusätzlich zu den typischen Anforderungen für den Betrieb eines Indexers benötigen Sie einen `tap-escrow-subgraph`-Endpunkt, um TAP-Aktualisierungen abzufragen. Sie können The Graph Network zur Abfrage verwenden oder sich selbst auf Ihrem `graph-node` hosten.

- [Graph TAP Arbitrum Sepolia Subgraph (for The Graph testnet)](https://thegraph.com/explorer/subgraphs/7ubx365MiqBH5iUz6XWXWT8PTof5BVAyEzdb8m17RvbD)
- [Graph TAP Arbitrum One Subgraph (for The Graph mainnet)](https://thegraph.com/explorer/subgraphs/4sukbNVTzGELnhdnpyPqsf1QqtzNHEYKKmJkgaT8z6M1)

> Note: `indexer-agent` does not currently handle the indexing of this Subgraph like it does for the network Subgraph deployment. As a result, you have to index it manually.

## Migrationsleitfaden

### Software-Versionen

Die erforderliche Softwareversion finden Sie [hier](https://github.com/graphprotocol/indexer/blob/main/docs/networks/arbitrum-one.md#latest-releases).

### Schritte

1. **Indexer-Agent**

   - Folgen Sie dem [gleichen Prozess](https://github.com/graphprotocol/indexer/pkgs/container/indexer-agent#graph-protocol-indexer-components).
   - Geben Sie das neue Argument `--tap-subgraph-endpoint` an, um die neuen TAP-Codepfade zu aktivieren und die Einlösung von TAP-RAVs zu ermöglichen.

2. **Indexer-Service**

   - Ersetzen Sie Ihre aktuelle Konfiguration vollständig durch den [neuen Indexer-Service rs](https://github.com/graphprotocol/indexer-rs). Es wird empfohlen, dass Sie das [Containerbild](https://github.com/orgs/graphprotocol/packages?repo_name=indexer-rs) verwenden.
   - Wie bei der älteren Version können Sie den Indexer-Service problemlos horizontal skalieren. Er ist immer noch zustandslos.

3. **TAP Agent**

   - Führen Sie immer _eine_ einzelne Instanz von [TAP Agent](https://github.com/graphprotocol/indexer-rs) aus. Es wird empfohlen, dass Sie das [Container-Image](https://github.com/orgs/graphprotocol/packages?repo_name=indexer-rs) verwenden.

4. **Indexer-Service und TAP-Agent konfigurieren**

   Die Konfiguration ist eine TOML-Datei, die von `indexer-service` und `tap-agent` gemeinsam genutzt wird und mit dem Argument `--config /path/to/config.toml` übergeben wird.

   Sehen Sie sich die vollständige [Konfiguration] (https://github.com/graphprotocol/indexer-rs/blob/main/config/maximal-config-example.toml) und die [Standardwerte] (https://github.com/graphprotocol/indexer-rs/blob/main/config/default_values.toml) an.

Für eine minimale Konfiguration verwenden Sie die folgende Vorlage:

```bash
# You will have to change *all* the values below to match your setup.
#
# Some of the config below are global graph network values, which you can find here:
# <https://github.com/graphprotocol/indexer/tree/main/docs/networks>
#
# Pro tip: if you need to load some values from the environment into this config, you
# can overwrite with environment variables. For example, the following can be replaced
# by [PREFIX]_DATABASE_POSTGRESURL, where PREFIX can be `INDEXER_SERVICE` or `TAP_AGENT`:
#
# [database]
# postgres_url = "postgresql://indexer:${POSTGRES_PASSWORD}@postgres:5432/indexer_components_0"

[indexer]
indexer_address = "0x1111111111111111111111111111111111111111"
operator_mnemonic = "celery smart tip orange scare van steel radio dragon joy alarm crane"

[database]
# The URL of the Postgres database used for the indexer components. The same database
# that is used by the `indexer-agent`. It is expected that `indexer-agent` will create
# the necessary tables.
postgres_url = "postgres://postgres@postgres:5432/postgres"

[graph_node]
# URL to your graph-node's query endpoint
query_url = "<http://graph-node:8000>"
# URL to your graph-node's status endpoint
status_url = "<http://graph-node:8000/graphql>"

[subgraphs.network]
# Query URL for the Graph Network Subgraph.
query_url = "<http://example.com/network-subgraph>"
# Optional, deployment to look for in the local `graph-node`, if locally indexed.
# Locally indexing the Subgraph is recommended.
# NOTE: Use `query_url` or `deployment_id` only
deployment_id = "Qmaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

[subgraphs.escrow]
# Query URL for the Escrow Subgraph.
query_url = "<http://example.com/network-subgraph>"
# Optional, deployment to look for in the local `graph-node`, if locally indexed.
# Locally indexing the Subgraph is recommended.
# NOTE: Use `query_url` or `deployment_id` only
deployment_id = "Qmaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

[blockchain]
# The chain ID of the network that the graph network is running on
chain_id = 1337
# Contract address of TAP's receipt aggregate voucher (RAV) verifier.
receipts_verifier_address = "0x2222222222222222222222222222222222222222"

########################################
# Specific configurations to tap-agent #
########################################
[tap]
# This is the amount of fees you are willing to risk at any given time. For ex.
# if the sender stops supplying RAVs for long enough and the fees exceed this
# amount, the indexer-service will stop accepting queries from the sender
# until the fees are aggregated.
# NOTE: Use strings for decimal values to prevent rounding errors
# e.g:
# max_amount_willing_to_lose_grt = "0.1"
max_amount_willing_to_lose_grt = 20

[tap.sender_aggregator_endpoints]
# Key-Value of all senders and their aggregator endpoints
# This one below is for the E&N testnet gateway for example.
0xDDE4cfFd3D9052A9cb618fC05a1Cd02be1f2F467 = "https://tap-aggregator.network.thegraph.com"
```

Anmerkungen:

- Die Werte für `tap.sender_aggregator_endpoints` finden Sie im Abschnitt [gateway](/indexing/tap/#gateway).
- Die Werte für `blockchain.receipts_verifier_address` müssen entsprechend dem Abschnitt [Blockchain-Adressen] (/indexing/tap/#contracts) unter Verwendung der entsprechenden Ketten-ID verwendet werden.

**Log Level**

- Sie können die Protokollstufe mit der Umgebungsvariablen `RUST_LOG` einstellen.
- Es wird empfohlen, die Einstellung `RUST_LOG=indexer_tap_agent=debug,info` zu verwenden.

## Monitoring

### Metriken

Alle Komponenten stellen den Port 7300 zur Abfrage durch prometheus zur Verfügung.

### Grafana-Dashboard

Sie können [Grafana-Dashboard] (https://github.com/graphprotocol/indexer-rs/blob/main/docs/dashboard.json) herunterladen und importieren.

### Launchpad

Derzeit gibt es eine WIP-Version von `indexer-rs` und `tap-agent`, die [hier](https://github.com/graphops/launchpad-charts/tree/main/charts/graph-network-indexer) zu finden ist.
