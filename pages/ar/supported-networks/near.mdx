---
title: بناء Subgraphs على NEAR
---

> يتوفر دعم NEAR في Graph Node وفي الخدمة المستضافة(Hosted Service) في مرحلة beta: يرجى التواصل بـ near@thegraph.com إذا كانت لديك أي أسئلة حول بناء subgraphs NEAR!

هذا الدليل عبارة عن مقدمة لبناء subgraphs تقوم بفهرسة العقود الذكية على [NEAR blockchain](https://docs.near.org/).

## ما هو NEAR؟

[NEAR](https://near.org/) هي عبارة عن منصة عقد ذكي لبناء تطبيقات لامركزية. قم بزيارة [ الوثائق الرسمية ](https://docs.near.org/docs/concepts/new-to-near) لمزيد من المعلومات.

## ماهي NEAR subgraphs؟

يوفر The Graph للمطورين أدوات لمعالجة أحداث blockchain وجعل البيانات الناتجة متاحة بسهولة عبر GraphQL API ، والمعروفة باسم subgraph. أصبح [ Graph Node ](https://github.com/graphprotocol/graph-node) الآن قادرًا على معالجة أحداث NEAR ، مما يعني أن مطوري NEAR يمكنهم الآن إنشاء subgraphs لفهرسة عقودهم الذكية (smart contracts).

تعتمد الـ Subgraphs على الأحداث ، مما يعني أنها تستمع إلى أحداث on-chain ثم تعالجها. يوجد حاليًا نوعان من المعالجات المدعومة لـ NEAR subgraphs:

- معالجات الكتل(Block handlers): يتم تشغيلها على كل كتلة جديدة
- معالجات الاستلام (Receipt handlers): يتم تشغيلها في كل مرة يتم فيها تنفيذ رسالة على حساب محدد

[ من وثائق NEAR ](https://docs.near.org/docs/concepts/transaction#receipt):

> الاستلام (Receipt) هو الكائن الوحيد القابل للتنفيذ في النظام. عندما نتحدث عن "معالجة الإجراء" على منصة NEAR ، فإن هذا يعني في النهاية "تطبيق الاستلامات" في مرحلة ما.

## بناء NEAR Subgraph

`graphprotocol/graph-cli@` هو أداة سطر أوامر لبناء ونشر الـ subgraphs.

`graphprotocol/graph-ts@` هي مكتبة لأنواع خاصة بـ subgraph.

تطوير NEAR subgraph يتطلب `graph-cli` إصدارا أعلى من ` 0.23.0 ` و `graph-ts` إصدارا أعلى من ` 0.23.0 `.

> بناء NEAR subgraph يشبه إلى حد كبير بناء subgraph يقوم بفهرسة الـ Ethereum.

هناك ثلاثة جوانب لتعريف الـ subgraph:

**subgraph.yaml:** الـ subgraph manifest ، وتحديد مصادر البيانات ذات الأهمية ، وكيف يجب أن تتم معالجتها. NEAR هو ` نوع ` جديد لمصدر البيانات.

**schema.graphql:** ملف مخطط يقوم بتعريف البيانات المخزنة لـ subgraph الخاص بك ، وكيفية الاستعلام عنها عبر GraphQL. تتم تغطية متطلبات NEAR subgraphs بواسطة [ الوثائق الحالية ](/developer/create-subgraph-hosted#the-graphql-schema).

**AssemblyScript Mappings:** هو [AssemblyScript كود ](/developer/assemblyscript-api) والذي يترجم من بيانات الحدث إلى الكيانات المعرفة في مخططك. دعم NEAR يقدم أنواع بيانات خاصة بـ NEAR ووظيفة تحليل JSON جديدة.

أثناء تطوير الـ subgraph ، هناك أمران رئيسيان:

```bash
$ graph codegen # generates types from the schema file identified in the manifest
$ graph build # generates Web Assembly from the AssemblyScript files, and prepares all the subgraph files in a /build folder
```

### تعريف Subgraph Manifest

Subgraph manifest (`subgraph.yaml`) يحدد مصادر البيانات لـ subgraph ، والمشغلات(triggers) ذات الأهمية ، والدوال التي يجب تشغيلها استجابة لتلك المشغلات. انظر أدناه للحصول على مثال لـ subgraph manifest لـ NEAR subgraph::

```yaml
specVersion: 0.0.2
schema:
  file: ./src/schema.graphql # link to the schema file
dataSources:
  - kind: near
    network: near-mainnet
    source:
      account: app.good-morning.near # This data source will monitor this account
      startBlock: 10662188 # Required for NEAR
    mapping:
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # the function name in the mapping file
      receiptHandlers:
        - handler: handleReceipt # the function name in the mapping file
      file: ./src/mapping.ts # link to the file with the Assemblyscript mappings
```

- NEAR subgraphs يقدم `نوعا ` جديدا من مصدر بيانات (`near`)
- The `network` should correspond to a network on the hosting Graph Node. On the Hosted Service, NEAR's mainnet is `near-mainnet`, and NEAR's testnet is `near-testnet`
- مصادر بيانات NEAR تقدم حقلًا اختياريًا ` source.account ` ، وهو ID يمكن قراءته و منسجما مع [ حساب NEAR ](https://docs.near.org/docs/concepts/account). يمكن أن يكون هذا حسابًا أو حسابًا فرعيًا.

مصادر بيانات NEAR تدعم نوعين من المعالجات:

- `blockHandlers`: يتم تشغيلها على كل كتلة NEAR جديدة. لا يتطلب `source.account`.
- `receiptHandlers`: يتم تشغيلها في كل استلام حيث يكون مصدر البيانات`source.account` هو المستلم. لاحظ أنه تتم معالجة المطابقات التامة فقط (يجب إضافة حسابات فرعية [subaccounts](https://docs.near.org/docs/concepts/account#subaccounts) كمصادر بيانات مستقلة).

### تعريف المخطط

Schema definition describes the structure of the resulting subgraph database, and the relationships between entities. This is agnostic of the original data source. There are more details on subgraph schema definition [here](/developer/create-subgraph-hosted#the-graphql-schema).

### AssemblyScript Mappings

The handlers for processing events are written in [AssemblyScript](https://www.assemblyscript.org/).

NEAR indexing introduces NEAR-specific data types to the [AssemblyScript API](/developer/assemblyscript-api).

```typescript

class ExecutionOutcome {
      gasBurnt: u64,
      blockHash: Bytes,
      id: Bytes,
      logs: Array<string>,
      receiptIds: Array<Bytes>,
      tokensBurnt: BigInt,
      executorId: string,
  }

class ActionReceipt {
      predecessorId: string,
      receiverId: string,
      id: CryptoHash,
      signerId: string,
      gasPrice: BigInt,
      outputDataReceivers: Array<DataReceiver>,
      inputDataIds: Array<CryptoHash>,
      actions: Array<ActionValue>,
  }

class BlockHeader {
      height: u64,
      prevHeight: u64,// Always zero when version < V3
      epochId: Bytes,
      nextEpochId: Bytes,
      chunksIncluded: u64,
      hash: Bytes,
      prevHash: Bytes,
      timestampNanosec: u64,
      randomValue: Bytes,
      gasPrice: BigInt,
      totalSupply: BigInt,
      latestProtocolVersion: u32,
  }

class ChunkHeader {
      gasUsed: u64,
      gasLimit: u64,
      shardId: u64,
      chunkHash: Bytes,
      prevBlockHash: Bytes,
      balanceBurnt: BigInt,
  }

class Block {
      author: string,
      header: BlockHeader,
      chunks: Array<ChunkHeader>,
  }

class ReceiptWithOutcome {
      outcome: ExecutionOutcome,
      receipt: ActionReceipt,
      block: Block,
  }
```

These types are passed to block & receipt handlers:

- Block handlers will receive a `Block`
- Receipt handlers will receive a `ReceiptWithOutcome`

Otherwise the rest of the [AssemblyScript API](/developer/assemblyscript-api) is available to NEAR subgraph developers during mapping execution.

This includes a new JSON parsing function - logs on NEAR are frequently emitted as stringified JSONs. A new `json.fromString(...)` function is available as part of the [JSON API](/developer/assemblyscript-api#json-api) to allow developers to easily process these logs.

## Deploying a NEAR Subgraph

Once you have a built subgraph, it is time to deploy it to Graph Node for indexing. NEAR subgraphs can be deployed to any Graph Node `>=v0.26.x` (this version has not yet been tagged & released).

The Graph's Hosted Service currently supports indexing NEAR mainnet and testnet in beta, with the following network names:

- `near-mainnet`
- `near-testnet`

More information on creating and deploying subgraphs on the Hosted Service can be found [here](/hosted-service/deploy-subgraph-hosted).

As a quick primer - the first step is to "create" your subgraph - this only needs to be done once. On the Hosted Service, this can be done from [your Dashboard](https://thegraph.com/hosted-service/dashboard): "Add Subgraph".

Once your subgraph has been created, you can deploy your subgraph by using the `graph deploy` CLI command:

```
$ graph create --node <graph-node-url> subgraph/name # creates a subgraph on a local Graph Node (on the Hosted Service, this is done via the UI)
$ graph deploy --node <graph-node-url> --ipfs https://api.thegraph.com/ipfs/ # uploads the build files to a specified IPFS endpoint, and then deploys the subgraph to a specified Graph Node based on the manifest IPFS hash
```

The node configuration will depend where the subgraph is being deployed.

#### Hosted Service:

```
graph deploy --node https://api.thegraph.com/deploy/ --ipfs https://api.thegraph.com/ipfs/ --access-token <your-access-token>
```

#### Local Graph Node (based on default configuration):

```
graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001
```

Once your subgraph has been deployed, it will be indexed by Graph Node. You can check its progress by querying the subgraph itself:

```
{
  _meta {
    block { number }
  }
}
```

### Indexing NEAR with a Local Graph Node

Running a Graph Node that indexes NEAR has the following operational requirements:

- NEAR Indexer Framework with Firehose instrumentation
- NEAR Firehose Component(s)
- Graph Node with Firehose endpoint configured

We will provide more information on running the above components soon.

## Querying a NEAR Subgraph

The GraphQL endpoint for NEAR subgraphs is determined by the schema definition, with the existing API interface. Please visit the [GraphQL API documentation](/developer/graphql-api) for more information.

## Example Subgraphs

Here are some example subgraphs for reference:

[NEAR Blocks](https://github.com/graphprotocol/example-subgraph/tree/near-blocks-example)

[NEAR Receipts](https://github.com/graphprotocol/example-subgraph/tree/near-receipts-example)

## الأسئلة الشائعة

### How does the beta work?

NEAR support is in beta, which means that there may be changes to the API as we continue to work on improving the integration. Please email near@thegraph.com so that we can support you in building NEAR subgraphs, and keep you up to date on the latest developments!

### Can a subgraph index both NEAR and EVM chains?

No, a subgraph can only support data sources from one chain / network.

### Can subgraphs react to more specific triggers?

Currently, only Block and Receipt triggers are supported. We are investigating triggers for function calls to a specified account. We are also interested in supporting event triggers, once NEAR has native event support.

### Will receipt handlers trigger for accounts and their sub accounts?

Receipt handlers will only be triggered for the exact-match of the named account. More flexibility may be added in future.

### Can NEAR subgraphs make view calls to NEAR accounts during mappings?

This is not supported. We are evaluating whether this functionality is required for indexing.

### Can I use data source templates in my NEAR subgraph?

This is not currently supported. We are evaluating whether this functionality is required for indexing.

### Ethereum subgraphs support "pending" and "current" versions, how can I deploy a "pending" version of a NEAR subgraph?

Pending functionality is not yet supported for NEAR subgraphs. In the interim, you can deploy a new version to a different "named" subgraph, and then when that is synced with the chain head, you can redeploy to your primary "named" subgraph, which will use the same underlying deployment ID, so the main subgraph will be instantly synced.

### My question hasn't been answered, where can I get more help building NEAR subgraphs?

If it is a general question about subgraph development, there is a lot more information in the rest of the [Developer documentation](/developer/quick-start). Otherwise please join [The Graph Protocol Discord](https://discord.gg/vtvv7FP) and ask in the #near channel, or email near@thegraph.com.

## References

- [NEAR developer documentation](https://docs.near.org/docs/develop/basics/getting-started)
