---
title: Развертывание сабграфа Arweave в размещенной службе
---

На этой странице объясняется, как развернуть сабграф в размещенной службе. Чтобы развернуть сабграф, вам необходимо сначала установить [Graph CLI](https://github.com/graphprotocol/graph-cli). Если вы еще не создали сабграф, см. раздел [создание подграфа](/developing/creating-a-subgraph).

> Если цепочка, совместимая с EVM, не поддерживается в размещенной службе, вы можете запустить свою собственную [graph-node](https://github.com/graphprotocol/graph-node) для его индексации.

## Создание учетной записи размещенной службы

Прежде чем использовать размещенный сервис, создайте учетную запись в нашем размещенном сервисе. Вам понадобится [ Учетная запись Github](https://github.com/) для этого; если у вас ее нет, вам нужно сначала создать ее. Затем перейдите к [Размещенный сервис](https://thegraph.com/hosted-service/), нажмите на кнопку _"Зарегистрироваться на Github"_ и завершите процедуру авторизации на Github.

## Хранение токена доступа

После создания учетной записи перейдите к своему [дашборду](https://thegraph.com/hosted-service/dashboard). Скопируйте маркер доступа, отображаемый на панели мониторинга, и запустите `graph auth --product hosted-service <ACCESS_TOKEN>`. Это сохранит маркер доступа на вашем компьютере. Вам нужно сделать это только один раз, или если вы когда-либо повторно создадите токен доступа.

## Создание сабграфа в размещенной службе

Перед развертыванием подграфа вам необходимо создать его в обозревателе графиков. Перейдите в [дашборд](https://thegraph.com/hosted-service/dashboard) и нажмите на кнопку _ "Добавить сабграф"_ и соответствующим образом заполните приведенную ниже информацию:

**Image** - Выберите изображение, которое будет использоваться в качестве изображения предварительного просмотра и миниатюры для сабграфа.

**Subgraph Name** - Вместе с именем учетной записи, под которым создается сабграф, это также определит `account-name/subgraph-name`-имя стиля, используемого для развертываний и конечных точек GraphQL. _Это поле не может быть изменено позже._

** Account ** - учетная запись, под которой создается сабграф. Это может быть учетная запись физического лица или организации. _Сабграфы позже нельзя будет перемещать между учетными записями._

** Subtitle ** - текст, который будет отображаться в карточках сабграфов.

** Description ** - Описание сабграфа, видимое на странице сведений о сабграфе.

**URL GitHub** - ссылка на репозиторий subgraph на GitHub.

** Hide ** - включение этого параметра скрывает сабграф в Graph Explorer.

После сохранения нового сабграфа вам будет показан экран со справкой о том, как установить графический интерфейс Graph CLI, как временные платформы для нового сабграфа и как развернуть свой сабграф. Первые два шага были описаны в разделе [Определение подграфа](/developing/defining-a-subgraph).

## Развертывание сабграфа в размещенной службе

Развертывание вашего сабграфа загрузит файлы подграфа, которые вы создали с помощью `yarn build`, в IPFS и попросит Graph Explorer начать индексирование вашего сабграфа с использованием этих файлов.

Вы развертываете сабграф, выполнив `yarn deploy`

После развертывания сабграфа Graph Explorer переключится на отображение статуса синхронизации вашего сабграфа. В зависимости от объема данных и количества событий, которые необходимо извлечь из исторических блоков Ethereum, начиная с блока genesis, синхронизация может занять от нескольких минут до нескольких часов. Статус сабграфа переключается на ` Synced ` после того, как нода Graph извлечет все данные из исторических блоков. Нода Graph продолжит проверку блоков Ethereum для вашего сабграфа по мере того, как эти блоки будут добыты.

## Повторное развертывание сабграфа

При внесении изменений в определение вашего сабграфа, например, для устранения проблемы в сопоставлениях сущностей, снова запустите приведенную выше команду `yarn deploy`, чтобы развернуть обновленную версию вашего сабграфа. Любое обновление сабграфа требует, чтобы нода Graph повторно индексировала весь ваш сабграф, снова начиная с блока genesis.

Если ваш ранее развернутый сабграф все еще находится в статусе `Syncing`, он будет немедленно заменен на недавно развернутую версию. Если ранее развернутый сабграф уже полностью синхронизирован, нода Graph пометит вновь развернутую версию как `Pending Version`, синхронизирует ее в фоновом режиме и заменит текущую развернутую версию новой только после завершения синхронизации новой версии. Это гарантирует, что у вас есть сабграф для работы во время синхронизации новой версии.

## Развертывание сабграфа в нескольких сетях Ethereum

В некоторых случаях вам захочется развернуть один и тот же сабграф в нескольких сетях Ethereum без дублирования всего его кода. Основная проблема, связанная с этим, заключается в том, что адреса контрактов в этих сетях разные.

### Использование graph-cli

Как `graph build` (начиная с `v0.29.0`), так и `graph deploy` (начиная с `v0.32.0`) допускают две новые опции:

```sh
      ...
      --network <name> Конфигурация сети для использования из файла конфигурации сетей
      --network-file <path> Путь к файлу конфигурации сетей (по умолчанию: "./networks.json")
```

Вы можете использовать опцию `--network`, чтобы указать конфигурацию сети из стандартного файла `json` (по умолчанию используется `networks.json`), чтобы легко обновлять свой сабграф во время разработки.

**Note:** Команда `init` теперь автоматически сгенерирует `networks.json` на основе предоставленной информации. Затем вы сможете обновить существующие или добавить дополнительные сети.

Если у вас нет файла `networks.json`, вам нужно будет вручную создать его со следующей структурой:

```json
{
    "network1": { // the network name
        "dataSource1": { // the dataSource name
            "address": "0xabc...", // the contract address (optional)
            "startBlock": 123456 // the startBlock (optional)
        },
        "dataSource2": {
            "address": "0x123...",
            "startBlock": 123444
        }
    },
    "network2": {
        "dataSource1": {
            "address": "0x987...",
            "startBlock": 123
        },
        "dataSource2": {
            "address": "0xxyz..",
            "startBlock": 456
        }
    },
    ...
}
```

**Примечание:** Вам не нужно указывать ни один из `шаблонов` (если они у вас есть) в файле конфигурации, только `Источники данных`. Если есть какие-либо `шаблоны`, объявленные в файле `subgraph.yaml`, их сеть будет автоматически обновлена до указанной с помощью опции `--network`.

Теперь давайте предположим, что вы хотите иметь возможность развернуть свой сабграф в сетях `mainnet` и `goerli`, и это ваш `subgraph.yaml`:

```yaml
# ...
dataSources:
  - kind: ethereum/contract
    name: Gravity
    network: mainnet
    source:
      address: '0x123...'
      abi: Gravity
    mapping:
      kind: ethereum/events
```

Вот как должен выглядеть файл конфигурации ваших сетей:

```json
{
  "mainnet": {
    "Gravity": {
      "address": "0x123..."
    }
  },
  "goerli": {
    "Gravity": {
      "address": "0xabc..."
    }
  }
}
```

Теперь мы можем запустить одну из следующих команд:

```sh
# Использование стандартного файла networks.json
yarn build --network goerli

# Использование пользовательского именованного файла
yarn build --network goerli --network-file path/to/config
```

Команда `build` обновит ваш `subgraph.yaml` конфигурацией `goerli`, а затем повторно скомпилирует сабграф. Ваш файл `subgraph.yaml` теперь должен выглядеть следующим образом:

```yaml
# ...
dataSources:
  - kind: ethereum/contract
    name: Gravity
    network: goerli
    source:
      address: '0xabc...'
      abi: Gravity
    mapping:
      kind: ethereum/events
```

Теперь вы готовы к `yarn deploy`.

**Примечание:** Как упоминалось ранее, поскольку `graph-cli 0.32.0` вы можете напрямую запустить `yarn deploy` с опцией `--network`:

```sh
# Использование стандартного файла networks.json
yarn deploy --network goerli

# Использование пользовательского именованного файла
yarn deploy --network goerli --network-file path/to/config
```

### Использование шаблона subgraph.yaml

Одним из решений для старых версий graph-cli, которое позволяет параметризовать такие аспекты, как адреса контрактов, является генерация его частей с использованием системы шаблонов, такой как [Mustache](https://mustache.github.io/) или [Handlebars](https://handlebarsjs.com/).

Чтобы проиллюстрировать этот подход, давайте предположим, что сабграф должен быть развернут в marine и Goerli с использованием разных адресов контракта. Затем вы могли бы определить два конфигурационных файла, содержащих адреса для каждой сети:

```json
{
  "network": "mainnet",
  "address": "0x123..."
}
```

и

```json
{
  "network": "goerli",
  "address": "0xabc..."
}
```

Наряду с этим, вы должны заменить имя сети и адреса в манифесте переменными заполнителями `{{network}}` и `{{address}}` и переименовать манифест, например, `subgraph.template.yaml`:

```yaml
# ...
dataSources:
  - kind: ethereum/contract
    name: Gravity
    network: mainnet
    network: {{network}}
    source:
      address: '0x2E645469f354BB4F5c8a05B3b30A929361cf77eC'
      address: '{{address}}'
      abi: Gravity
    mapping:
      kind: ethereum/events
```

Чтобы сгенерировать манифест для любой сети, вы могли бы добавить две дополнительные команды в `package.json` вместе с зависимостью от `mustache`:

```json
{
  ...
  "scripts": {
    ...
    "prepare:mainnet": "mustache config/mainnet.json subgraph.template.yaml > subgraph.yaml",
    "prepare:goerli": "mustache config/goerli.json subgraph.template.yaml > subgraph.yaml"
  },
  "devDependencies": {
    ...
    "mustache": "^3.1.0"
  }
}
```

Чтобы развернуть этот сабграф для mainnet или Girl, теперь вам нужно просто выполнить одну из двух следующих команд:

```sh
# Mainnet:
yarn prepare:mainnet && yarn deploy

# Goerli:
yarn prepare:goerli && yarn deploy
```

Рабочий пример этого можно найти [здесь](https://github.com/graphprotocol/example-subgraph/tree/371232cf68e6d814facf5e5413ad0fef65144759).

**Примечание:** Этот подход также может быть применен к более сложным ситуациям, где необходимо заменить больше, чем адреса контрактов и сетевые имена, или где также генерируются сопоставления или ABI из шаблонов.

## Проверка состояния работоспособности сабграфа

Если сабграф успешно синхронизируется, это хороший признак того, что он будет работать надёжно. Однако новые триггеры в сети могут привести к тому, что ваш сабграф попадет в состояние непроверенной ошибки, или он может начать отставать из-за проблем с производительностью или проблем с операторами нод.

Нода Graph предоставляет конечную точку graphql, которую вы можете запросить, чтобы проверить статус вашего сабграфа. В размещенном сервисе он доступен по адресу `https://api.thegraph.com/index-node/graphql`. На локальном узле он доступен по умолчанию через порт `8030/graphql`. Полную схему для этой конечной точки можно найти [здесь](https://github.com/graphprotocol/graph-node/blob/master/server/index-node/src/schema.graphql). Вот пример запроса, который проверяет статус текущей версии сабграфа:

```graphql
{
  indexingStatusForCurrentVersion(subgraphName: "org/subgraph") {
    synced
    health
    fatalError {
      message
      block {
        number
        hash
      }
      handler
    }
    chains {
      chainHeadBlock {
        number
      }
      latestBlock {
        number
      }
    }
  }
}
```

Это даст вам `chainHeadBlock`, который вы можете сравнить с `latestBlock` на вашем сабграфе, чтобы проверить, отстает ли он. `synced` сообщает, попадал ли когда-либо сабграф в сеть. `health` в настоящее время может принимать значения `healthy`, если ошибок не произошло, или `failed`, если произошла ошибка, которая остановила выполнение сабграфа. В этом случае вы можете проверить поле `FatalError` для получения подробной информации об этой ошибке.

## Политика архивирования сабграфов размещенной службы

Размещенный сервис представляет собой бесплатного Индексера ноды Graph. Разработчики могут развернуть сабграфы, индексирующие ряд сетей, которые будут проиндексированы и станут доступными для запросов через GraphQL.

Чтобы повысить производительность службы для активных сабграфов, размещенная служба будет архивировать неактивные сабграфы.

**Сабграф определяется как "неактивный", если он был развернут в размещенной службе более 45 дней назад и если за последние 45 дней он получил 0 запросов.**

Разработчики будут уведомлены по электронной почте, если один из их сабграфов был помечен как неактивный за 7 дней до его удаления. Если они хотят "активировать" свой сабграф, они могут сделать это, выполнив запрос в размещенном на их сабграфах сервисе GraphQL playground. Разработчики всегда могут повторно развернуть архивированный сабграф, если это потребуется снова.

## Политика архивирования сабграфов Subgraph Studio

Когда развертывается новая версия сабграфа, предыдущая версия архивируется (удаляется из базы данных graph-node). Это происходит только в том случае, если предыдущая версия не опубликована в децентрализованной сети Graph.

Если версия сабграфа не запрашивается более 45 дней, эта версия архивируется.

У каждого сабграфа, затронутого этой политикой, есть возможность вернуть соответствующую версию обратно.
