---
title: Перенос существующего сабграфа в сеть Graph
---

## Введение

Это руководство о том, как перенести ваш сабграф из размещенного сервиса в децентрализованную сеть The Graph. Переход на сеть The Graph был успешным для таких проектов, как Opyn, UMA, mStable, Audius, PoolTogether, Livepeer, RAI, Enzyme, DODO, Pickle и BadgerDAO, все из которых полагаются на данные, обслуживаемые индексаторами в сети. В настоящее время в децентрализованной сети Graph доступно более 600 сабграфов, которые генерируют плату за запросы и активно индексируют данные web3.

Процесс миграции происходит быстро, и ваши сабграфы всегда будут пользоваться надежностью и производительностью, которые вы можете получить только в сети Graph.

### Допущения

- Вы уже развернули сабграф в размещенном сервисе.
- Сабграф индексирует цепочку, доступную (или доступную в бета-версии) в сети Graph.
- Сабграф не имеет зависимостей IPFS или полнотекстового поиска (они еще не полностью поддерживаются в децентрализованной сети).

## Перенос существующего сабграфа в сеть Graph

1. Установите последнюю версию graph-cli:

```sh
npm install -g @graphprotocol/graph-cli
```

```sh
yarn global add @graphprotocol/graph-cli
```

Также убедитесь, что ваша версия `apiVersion` в subgraph.yaml равна `0.0.5` или выше.

2. Внутри основного репозитория проекта в сабграфе выполните аутентификацию сабграфа для развертывания и сборки в studio:

```sh
graph auth --studio <DEPLOY_KEY>
```

3. Сгенерируйте файлы и постройте сабграф:

```sh
graph codegen && graph build
```

Если в вашем сабграфе есть ошибки сборки, обратитесь к [Руководству по миграции AssemblyScript](/release-notes/assemblyscript-migration-guide/).

4. Войдите в [Subgraph Studio](https://thegraph.com/studio/) с помощью вашего кошелька и разверните сабграф. Вы можете найти свой `<SUBGRAPH_SLUG>` в пользовательском интерфейсе Studio, который основан на названии вашего сабграфа.

```sh
graph deploy --studio <SUBGRAPH_SLUG>
```

5. Тестируйте запросы на тестовой площадке Studio. Вот несколько примеров для [ Сабграф обмена Sushi - Mainnet](https://thegraph.com/explorer/subgraph?id=0x4bb4c1b0745ef7b4642feeccd0740dec417ca0a0-0&view=Playground):

```sh
{
  users(first: 5) {
    id
    liquidityPositions {
      id
    }
  }
  bundles(first: 5) {
    id
    ethPrice
  }
}
```

6. На данный момент ваш сабграф теперь развернут в Subgraph Studio, но еще не опубликован в децентрализованной сети. Теперь вы можете протестировать сабграф, чтобы убедиться, что он работает должным образом, используя временный URL-адрес запроса, как показано в верхней части правой колонки выше. Как уже следует из этого названия, это временный URL-адрес, и его не следует использовать в рабочей среде.

- Помните, что публикация является действием по цепочке и потребует оплаты газа в Ethereum - смотрите пример транзакции [здесь](https://etherscan.io/tx/0xd0c3fa0bc035703c9ba1ce40c1862559b9c5b6ea1198b3320871d535aa0de87b). Цены составляют примерно около 0,0425 ETH при 100 gwei.
- Каждый раз, когда вам потребуется обновить свой сабграф, с вас будет взиматься плата за обновление. Помните, что обновление - это просто публикация другой версии вашего существующего сабграфа в сети. Поскольку это сопряжено с определенными затратами, настоятельно рекомендуется развернуть и протестировать ваш сабграф на Goerli перед развертыванием в mainnet. В некоторых случаях также может потребоваться немного GRT, если на этом сабграфе нет сигнала. В случае, если в этой версии сабграфа есть сигнал / кураторство (с использованием автоматической миграции), налоги будут разделены.

7. Опубликуйте сабграф в децентрализованной сети Graphs, нажав кнопку "Publish".

И это все! После того, как вы закончите публикацию, вы сможете просматривать свои сабграфы в реальном времени в децентрализованной сети через [The Graph Explorer](https://thegraph.com/explorer).

Не стесняйтесь использовать [#Curators channel](https://discord.gg/rC8rBuRtbH) в Discord, чтобы сообщить кураторам, что ваш сабграф готов к отправке сигнала. Также было бы полезно, если бы вы поделились с ними ожидаемым объемом запросов. Следовательно, они могут оценить, какое количество запросов они должны сигнализировать на вашем сабграфе.

### Создайте ключ API

Вы можете сгенерировать ключ API в Subgraph Studio [здесь](https://thegraph.com/studio/apikeys/).

![Страница создания ключа API](/img/api-image.png)

В конце каждой недели будет формироваться счет на основе сборов за запрос, которые были понесены за этот период. Этот счет будет оплачен автоматически с использованием GRT, имеющейся на вашем балансе. Ваш баланс будет обновлен после того, как будут сняты сборы за ваш запрос. Плата за запрос оплачивается в GRT через сеть Arbitrium. Вам нужно будет добавить GRT в биллинговый контракт Arbitrum'а, чтобы включить ваш API-ключ, выполнив следующие действия:

- Приобретайте GRT на бирже, которую выберите сами.
- Отправьте GRT на свой кошелек.
- На странице выставления счетов в Studio нажмите Add GRT.

![Добавьте GRT в выставление счетов](/img/Add-GRT-New-Page.png)

- Следуйте инструкциям, чтобы добавить токен GRT к платежному балансу.
- Ваш токен GRT будет автоматически подключен к сети Arbitrum и добавлен к вашему платежному балансу.

![Платежная модель](/img/New-Billing-Pane.png)

> Примечание: см. [official billing page](../billing.mdx), чтобы получить полные инструкции по добавлению токена GRT к Вашему платежному балансу.

### Защита Вашего ключа API

Рекомендуется защитить API, ограничив его использование двумя способами:

1. Авторизованные сабграфы
2. Авторизованный домен

Вы можете защитить свой ключ API [here](https://thegraph.com/studio/apikeys/test/).

![Страница блокировки сабграфа](/img/subgraph-lockdown.png)

### Запрос Вашего сабграфа в децентрализованной сети

Теперь вы можете проверить статус индексации Индексеров в сети в Graph Explorer (пример [здесь](https://thegraph.com/explorer/subgraph?id=S9ihna8D733WTEShJ1KctSTCvY1VJ7gdVwhUujq4Ejo&view=Indexers)). Зеленая линия вверху указывает на то, что на момент публикации 8 Индексеров успешно проиндексировали этот сабграф. Также на вкладке Индексер вы можете увидеть, какие Индексеры подобрали ваш сабграф.

![Сабграф Rocket Pool](/img/rocket-pool-subgraph.png)

Как только первый индексер полностью проиндексирует ваш сабграф, вы можете начать запрашивать сабграф в децентрализованной сети. Чтобы получить URL-адрес запроса для вашего сабграфа, вы можете скопировать / вставить его, нажав на символ рядом с URL-адресом запроса. Вы увидите что-то вроде этого:

`https://gateway.thegraph.com/api/[api-key]/subgraphs/id/S9ihna8D733WTEShJ1KctSTCvY1VJ7gdVwhUujq4Ejo`

Важно: обязательно замените `[api-key]` актуальным ключом API, сгенерированным в разделе выше.

Теперь вы можете использовать этот URL-адрес запроса в своем приложении для отправки своих запросов GraphQL.

Поздравляю! Теперь вы являетесь пионером децентрализации!

> Примечание: Из-за распределенного характера сети может случиться так, что разные индексеры были проиндексированы до разных блоков. Чтобы получать только свежие данные, вы можете указать минимальный блок, который индексер должен проиндексировать, чтобы обслуживать ваш запрос с помощью аргумента поля block: `{ number_gte: $minBlock }`, как показано в примере ниже:

```graphql
{
  stakers(block: { number_gte: 14486109 }) {
    id
  }
}
```

Дополнительные сведения о природе построения сети и о том, как управлять реорганизацией, описаны в статье документации [Distributed Systems](/querying/distributed-systems/).

## Обновление сабграфа в сети

Если вы хотите обновить существующий сабграф в сети, вы можете сделать это, развернув новую версию вашего сабграфа в Subgraph Studio с помощью Graph CLI.

1. Внесите изменения в свой текущий сабграф. Хорошая идея - протестировать небольшие исправления в Subgraph Studio, опубликовав их в Goerli.
2. Разверните следующее и укажите новую версию в команде (например, v0.0.1, v0.0.2 и т. д.):

```sh
graph deploy --studio <SUBGRAPH_SLUG>
```

3. Протестируйте новую версию в Subgraph Studio, выполнив запрос на тестовой площадке
4. Опубликуйте новую версию в сети Graph. Помните, что для этого требуется газ (как описано в разделе выше).

### Плата владельца за апгрейд: Подробное описание

Обновление требует GRT для переноса со старой версии сабграфа на новую. Это означает, что для каждого обновления будет создаваться новая кривая соединения (подробнее о кривых соединения [здесь](/network/curating#bonding-curve-101)).

Новая кривая привязки взимает 2,5%-ный налог на кураторство со всех GRT, перенесенных на новую версию. Владелец должен оплатить 50% от этой суммы или 1,25%. Остальные 1,25% поглощаются всеми кураторами в качестве гонорара. Этот дизайн стимулирования создан для того, чтобы владелец сабграфа не мог истощить все средства своего куратора с помощью рекурсивных вызовов обновления. Если нет кураторской деятельности, вам придется заплатить минимум 100 GRT, чтобы подать сигнал о своем собственном сабграфе.

Давайте приведем пример, это только в том случае, если ваш сабграф активно курируется на:

- 100 000 GRT сигнализируется с помощью автоматической миграции на v1 сабграфа
- Владелец обновляется до версии v2. 100 000 GRT переносятся на новую кривую привязки, где 97 500 попадают в новую кривую, а 2500 GRT сжигаются
- Затем владелец должен сжечь 1250 GRT, чтобы оплатить половину платы. Владелец должен иметь это в своем кошельке перед обновлением, в противном случае обновление не будет успешным. Это происходит в той же транзакции, что и обновление.

_Хотя этот механизм в настоящее время доступен в сети, сообщество в настоящее время обсуждает способы снижения стоимости обновлений для разработчиков сабграфов._

### Поддержание стабильной версии сабграфа

Если вы вносите много изменений в свой сабграф, не стоит постоянно обновлять его и покрывать расходы на обновление. Поддержание стабильной и непротиворечивой версии вашего сабграфа имеет решающее значение не только с точки зрения затрат, но и для того, чтобы индексеры могли быть уверены во времени синхронизации. Индексеры должны быть оповещены, когда вы планируете обновление, чтобы это не повлияло на время синхронизации индексера. Не стесняйтесь использовать [#Indexers channel](https://discord.gg/rC8rBuRtbH) в Discord, чтобы сообщить индексерам, когда вы изменяете версии своих сабграфов.

Сабграфы - это открытые API, которые используют внешние разработчики. Открытые API-интерфейсы должны соответствовать строгим стандартам, чтобы они не нарушали работу приложений внешних разработчиков. В сети Graph разработчик сабграфа должен учитывать индексеры и то, сколько времени им требуется для синхронизации нового сабграфа **, а также** других разработчиков, которые используют свои сабграфы.

### Обновление метаданных сабграфа

Вы можете обновить метаданные своих сабграфов без необходимости публиковать новую версию. Метаданные включают название сабграфа, изображение, описание, URL веб-сайта, URL исходного кода и категории. Разработчики могут сделать это, обновив сведения о своих сабграфах в Subgraph Studio, где вы можете редактировать все применимые поля.

Убедитесь, что установлен флажок **Обновить сведения о сабграфе в проводнике**, и нажмите **Сохранить**. Если этот флажок установлен, будет сгенерирована транзакция по цепочке, которая обновляет сведения о сабграфе в проводнике без необходимости публикации новой версии с новым развертыванием.

## Рекомендации по развертыванию сабграфа в сети Graph

1. Использование имени ENS для разработки сабграфа:

- Настройте свой ENS: [https://app.ens.domains /](https://app.ens.domains/)
- Добавьте ваше ENS имя в свои настройки [здесь](https://thegraph.com/explorer/settings?view=display-name).

2. Чем более заполнены ваши профили, тем больше шансов, что ваши сабграфы будут проиндексированы и обработаны куратором.

## Осуждение сабграфа в сети Graph

Следуйте инструкциям [здесь](/managing/deprecating-a-subgraph), чтобы отказаться от вашего подграфа и удалить его из сети Graph.

## Запрос сабграфа + выставление счетов в сети Graph

Размещенный сервис был настроен таким образом, чтобы позволить разработчикам развертывать свои сабграфы без каких-либо ограничений.

Для того чтобы сеть Graph действительно была децентрализована, плата за запросы должна выплачиваться в качестве основной части стимулов протокола. Для получения дополнительной информации о подписке на API и оплате сборов за запросы ознакомьтесь с биллинговой документацией [здесь](/billing/).

### Оценка платы за запрос в Сети

Хотя это не реализовано в пользовательском интерфейсе продукта, вы можете установить максимальный бюджет для каждого запроса, взяв сумму, которую вы готовы платить в месяц, и разделив ее на ожидаемый объем запроса.

Хотя вы сами определяете бюджет своего запроса, нет никакой гарантии, что индексер будет готов обслуживать запросы по такой цене. Если шлюз может сопоставить вас с индексером, готовым обслуживать запрос по цене, которую вы готовы заплатить, или ниже этой цены, вы заплатите дельту / разницу вашего бюджета ** и** их цены. Как следствие, более низкая цена запроса сокращает пул доступных вам индексеров, что может повлиять на качество получаемого вами сервиса. Выгодно иметь высокую плату за запросы, так как это может привлечь кураторство и именитые индексеры к вашему сабграфу.

Помните, что это динамичный и растущий рынок, но то, как вы взаимодействуете с ним, зависит от вас. В протоколе или шлюзах не указана максимальная или минимальная цена. Например, вы можете посмотреть на цену, которую платят несколько приложений в сети (на еженедельной основе), ниже. Смотрите последний столбец, в котором показаны сборы за запрос в GRT. Например, [Pickle Finance](https://www.pickle.finance/) обрабатывает 8 запросов в секунду и платит 2,4 GRT за одну неделю.

![Плата за запрос](/img/QueryFee.png)

## Дополнительные ресурсы

Если вы все еще в замешательстве, не бойтесь! Ознакомьтесь со следующими ресурсами или посмотрите наше видео-руководство по миграции сабграфов в децентрализованную сеть ниже:

<VideoEmbed youtube="CzdQ3dFFrjo" />

- [Контракты в сети The Graph](https://github.com/graphprotocol/contracts)
- [Curation Contract](https://github.com/graphprotocol/contracts/blob/dev/contracts/curation/Curation.sol) - базовый контракт, на который распространяется GNS
  - Адрес - `0x8fe00a685bcb3b2cc296ff6ffeab10aca4ce1538`
- [Документация для Subgraph Studio](/deploying/subgraph-studio)
