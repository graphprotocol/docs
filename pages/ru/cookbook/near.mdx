---
title: Создание сабграфов на NEAR
---

> NEAR поддерживается в Graph Node и на размещенном сервисе находится в бета-версии: пожалуйста, свяжитесь near@thegraph.com по любым вопросам о создании сабграфов на NEAR!

Это руководство представляет собой введение в построение сабграфов, индексирующих смарт-контракты на [блокчейне NEAR](https://docs.near.org/).

## Что такое NEAR?

[NEAR](https://near.org/) - это платформа смарт-контрактов для создания децентрализованных приложений. Посетите [официальная документация](https://docs.near.org/docs/concepts/new-to-near) для получения дополнительной информации.

## Что такое NEAR сабграфы?

The Graph предоставляет разработчикам инструменты для обработки событий блокчейна и делает результирующие данные легко доступными через GraphQL API, известный индивидуально как сабграф. [Graph Node](https://github.com/graphprotocol/graph-node) теперь способен обрабатывать события NEAR, что означает, что разработчики NEAR теперь могут создавать сабграфы для индексации своих смарт-контрактов.

Сабграфы основаны на событиях, что означает, что они прослушивают и затем обрабатывают события по цепочке. В настоящее время для ближних Сабграфов поддерживаются два типа обработчиков:

- Обработчики блоков: они запускаются для каждого нового блока
- Обработчики квитанций: запускаются каждый раз, когда сообщение выполняется в указанной учетной записи

[Из документации NEAR](https://docs.near.org/docs/concepts/transaction#receipt):

> Квитанция - это единственный объект, к которому можно применить действие в системе. Когда мы говорим об "обработке транзакции" на платформе NEAR, это в конечном итоге означает "применение квитанций" в какой-то момент.

## Создание NEAR сабграфа

`@graphprotocol/graph-cli` - это инструмент командной строки для построения и развертывания сабграфов.

`@graphprotocol/graph-ts` - это библиотека типов, специфичных для сабграфов.

Для разработки NEAR сабграфа требуется `graph-cli` выше версии `0.23.0` и `graph-ts` выше версии `0.23.0`.

> Построение NEAR сабграфа очень похоже на построение сабграфа, индексирующего Ethereum.

Существует три аспекта определения сабграфа:

**subgraph.yaml:** манифест сабграфа, определяющий источники данных, представляющие интерес, и как они должны быть обработаны. РЯДОМ находится новый ` вид` источника данных.

**schema.graphql:** файл схемы, который определяет, какие данные хранятся для вашего сабграфа и как запрашивать их через GraphQL. Требования к БЛИЖНИМ сабграфам описаны в [существующей документации](/developing/creating-a-subgraph#the-graphql-schema).

<**Сопоставления AssemblyScript:** [Код AssemblyScript](/developing/assemblyscript-api), который преобразует данные события в объекты, определенные в вашей схеме. Поддержка NEAR вводит почти специфические типы данных и новые функции синтаксического анализа JSON.

Во время разработки сабграфа есть две ключевые команды:

```bash
$ graph codegen # генерирует типы из файла схемы, указанного в манифесте
$ $ graph build # генерирует веб-сборку из файлов AssemblyScript и подготавливает все файлы сабграфа в папке /build
```

### Определение манифеста сабграфа

Манифест сабграфа (`subgraph.yaml`) определяет источники данных для сабграфа, представляющие интерес триггеры и функции, которые должны выполняться в ответ на эти триггеры. Смотрите ниже пример манифеста сабграфа для NEAR сабграфа::

```yaml
specVersion: 0.0.2
schema:
  file: ./src/schema.graphql # link to the schema file
dataSources:
  - kind: near
    network: near-mainnet
    source:
      account: app.good-morning.near # This data source will monitor this account
      startBlock: 10662188 # Required for NEAR
    mapping:
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # the function name in the mapping file
      receiptHandlers:
        - handler: handleReceipt # the function name in the mapping file
      file: ./src/mapping.ts # link to the file with the Assemblyscript mappings
```

- NEAR сабграфы вводят новый ` вид` источника данных (`near`)
- `network` должна соответствовать сети на хостинге ноды Graph. В размещенной службе основная сеть NEAR - это `near-mainnet`, а тестовая сеть NEAR - это `near-testnet`
- Источники данных NEAR вводят необязательное поле `source.account`, которое представляет собой понятный для человека идентификатор, соответствующий [NEAR account](https://docs.near.org/docs/concepts/account). Это может быть учетная запись или субсчет.
- Источниками данных NEAR вводят альтернативное необязательное поле `source.accounts`, которое содержит необязательные суффиксы и префиксы. Необходимо указать по крайней мере префикс или суффикс, они будут соответствовать любой учетной записи, начинающейся или заканчивающейся списком значений соответственно. Приведенный ниже пример соответствовал бы: `[app|good].*[morning.near|morning.testnet]`. Если необходим только список префиксов или суффиксов, другое поле можно опустить.

```yaml
accounts:
  prefixes:
    - app
    - good
  suffixes:
    - morning.near
    - morning.testnet
```

Источники данных NEAR поддерживают два типа обработчиков:

- `blockHandlers` запускаются при каждом новом ближайшем блоке. Не требуется `source.account`.
- `receiptHandlers`: запускаются для каждой квитанции, получателем которой является `source.account`. Обратите внимание, что обрабатываются только точные совпадения ([subaccounts](https://docs.near.org/docs/concepts/account#subaccounts) должны быть добавлены в качестве независимых источников данных).

### Определение схемы

Определение схемы описывает структуру результирующей базы данных сабграфов и взаимосвязи между сущностями. Это не зависит от исходного источника данных. Более подробная информация об определении схемы сабграфа [ приведена здесь](/developing/creating-a-subgraph#the-graphql-schema).

### Сопоставления AssemblyScript

Обработчики событий написаны на языке [AssemblyScript](https://www.assemblyscript.org/).

Индексация NEAR вводит NEAR-специфические типы данных в [AssemblyScript API](/developing/assemblyscript-api).

```typescript

class ExecutionOutcome {
      gasBurnt: u64,
      blockHash: Bytes,
      id: Bytes,
      logs: Array<string>,
      receiptIds: Array<Bytes>,
      tokensBurnt: BigInt,
      executorId: string,
  }

class ActionReceipt {
      predecessorId: string,
      receiverId: string,
      id: CryptoHash,
      signerId: string,
      gasPrice: BigInt,
      outputDataReceivers: Array<DataReceiver>,
      inputDataIds: Array<CryptoHash>,
      actions: Array<ActionValue>,
  }

class BlockHeader {
      height: u64,
      prevHeight: u64,// Always zero when version < V3
      epochId: Bytes,
      nextEpochId: Bytes,
      chunksIncluded: u64,
      hash: Bytes,
      prevHash: Bytes,
      timestampNanosec: u64,
      randomValue: Bytes,
      gasPrice: BigInt,
      totalSupply: BigInt,
      latestProtocolVersion: u32,
  }

class ChunkHeader {
      gasUsed: u64,
      gasLimit: u64,
      shardId: u64,
      chunkHash: Bytes,
      prevBlockHash: Bytes,
      balanceBurnt: BigInt,
  }

class Block {
      author: string,
      header: BlockHeader,
      chunks: Array<ChunkHeader>,
  }

class ReceiptWithOutcome {
      outcome: ExecutionOutcome,
      receipt: ActionReceipt,
      block: Block,
  }
```

Эти типы передаются обработчикам блоков и квитанций:

- Обработчики блоков получат `Block`
- Обработчики квитанций получат `ReceiptWithOutcome`

В противном случае остальная часть [AssemblyScript API](/developing/assemblyscript-api) доступна разработчикам NEAR сабграфа во время выполнения сопоставления.

Это включает в себя новую функцию синтаксического анализа JSON - журналы на NEAR часто выдаются в виде stringified JSONs. Новая функция `json.fromString(...)` доступна как часть [JSON API](/developing/assemblyscript-api#json-api), позволяющая разработчикам легко обрабатывать эти журналы.

## Развертываение NEAR сабграфа

Как только у вас будет встроенный сабграф, пришло время развернуть его в Graph Node для индексации. NEAR сабграфы могут быть развернуты на любой ноде Graph `>=v0.26.x` (эта версия еще не была помечена & выпущена).

Размещенный сервис The Graph в настоящее время поддерживает индексацию NEAR с mainnet и testnet в бета-версии со следующими сетевыми именами:

- `near-mainnet`
- `near-testnet`

Дополнительную информацию о создании и развертывании сабграфов в размещенной службе можно найти [здесь](/deploying/deploying-a-subgraph-to-hosted).

В качестве краткого примера - первым шагом является "создание" вашего сабграфа - это нужно сделать только один раз. В размещенном сервисе это можно сделать из [ваша панель мониторинга](https://thegraph.com/hosted-service/dashboard): "Добавить сабграф".

Как только ваш сабграф создан, вы можете развернуть его с помощью команды `graph deploy` CLI:

```
$ graph create --node <graph-node-url> subgraph/name # создает сабграф на локальной ноде Graph (в размещенном сервисе это делается через пользовательский интерфейс)
$ graph deploy --node <graph-node-url> --ipfs https://api.thegraph.com/ipfs/ # загружает файлы сборки в указанную конечную точку IPFS, а затем развертывает сабграф в указанной ноде Graph на основе хэша манифеста IPFS
```

Конфигурация узла будет зависеть от того, где развертывается сабграф.

#### Размещенный сервис:

```
graph deploy --node https://api.thegraph.com/deploy/ --ipfs https://api.thegraph.com/ipfs/ --access-token <your-access-token>
```

#### Локальная Graph Node (на основе конфигурации по умолчанию):

```
graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001
```

Как только ваш сабграф будет развернут, он будет проиндексирован нодой Graph. Вы можете проверить его прогресс, запросив сам сабграф:

```
{
  _meta {
    block { number }
  }
}
```

### Индексирование NEAR с локальной нодой Graph

Запуск ноды Graph, который индексирует NEAR, имеет следующие эксплуатационные требования:

- Фреймворк NEAR Indexer с инструментарием Firehose
- Компонент(ы) NEAR Firehose
- Нода Graph с настроенной конечной точкой Firehose

В ближайшее время мы предоставим более подробную информацию о запуске вышеуказанных компонентов.

## Запрос NEAR сабграфа

Конечная точка GraphQL для NEAR сабграфов определяется определением схемы с помощью существующего интерфейса API. Пожалуйста, посетите [Документацию GraphQL API](/querying/graphql-api) для получения дополнительной информации.

## Примеры сабграфов

Вот несколько примеров сабграфов для справки:

[NEAR Blocks](https://github.com/graphprotocol/example-subgraphs/tree/main/near/blocks-example)

[NEAR Receipts](https://github.com/graphprotocol/example-subgraphs/tree/main/near/receipts-example)

## Часто задаваемые вопросы

### Как работает бета-версия?

Поддержка NEAR находится в стадии бета-тестирования, что означает, что в API могут быть внесены изменения, поскольку мы продолжаем работать над улучшением интеграции. Пожалуйста, напишите по электронной почте near@thegraph.com чтобы мы могли поддержать вас в создании NEAR сабграфов и держать вас в курсе последних разработок!

### Может ли сабграф индексировать как NEAR, так и EVM-цепочки?

Нет, сабграф может поддерживать источники данных только из одной цепочки / сети.

### Могут ли сабграфы реагировать на более конкретные триггеры?

В настоящее время поддерживаются только триггеры Block и Receipt. Мы исследуем триггеры для вызовов функций к указанной учетной записи. Мы также заинтересованы в поддержке триггеров событий, когда NEAR обладает собственной поддержкой событий.

### Будут ли запускаться обработчики квитанций для учетных записей и их субсчетов?

Если указана `учетная запись`, это будет соответствовать только точному имени учетной записи. Можно сопоставить субсчеты, указав поле `учетные записи` с `суффиксами` и `префиксами`, указанными для сопоставления учетных записей и субсчетов, например, следующее будет соответствовать всем `mintbase1.near`:

```yaml
accounts:
  suffixes:
    - mintbase1.near
```

### Могут ли NEAR подграфы выполнять вызовы просмотра для NEAR учетных записей во время сопоставлений?

Это не поддерживается. Мы оцениваем, требуется ли эта функциональность для индексации.

### Могу ли я использовать шаблоны источников данных в моем NEAR сабграфе?

В настоящее время это не поддерживается. Мы оцениваем, требуется ли эта функциональность для индексации.

### Сабграфы Ethereum поддерживают "ожидающие" и "текущие" версии, как я могу развернуть "ожидающую" версию NEAR сабграфа?

Ожидающая функциональность еще не поддерживается для NEAR сабграфов. Тем временем вы можете развернуть новую версию на другом "именованном" сабграфе, а затем, когда она будет синхронизирована с заголовком цепочки, вы можете повторно развернуть ее на свой основной "именованный" сабграф, который будет использовать тот же базовый идентификатор развертывания, поэтому основной сабграф будет мгновенно синхронизирован.

### На мой вопрос не было ответа, где я могу получить дополнительную помощь в построении NEAR сабграфов?

Если это общий вопрос о разработке сабграфа, то гораздо больше информации содержится в остальной части [документации разработчика](/cookbook/quick-start). В противном случае, пожалуйста, присоединяйтесь [The Graph Protocol Discord](https://discord.gg/vtvv7FP) и задайте вопрос в канале #near или по электронной почте near@thegraph.com.

## Рекомендации

- [Документация разработчика NEAR](https://docs.near.org/docs/develop/basics/getting-started)
