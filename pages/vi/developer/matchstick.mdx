---
title: Khung Unit Test
---

Matchstick l√† m·ªôt khung unit test ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi [LimeChain](https://limechain.tech/), cho ph√©p c√°c nh√† ph√°t tri·ªÉn subgraph ki·ªÉm tra logic √°nh x·∫° c·ªßa h·ªç trong m√¥i tr∆∞·ªùng h·ªôp c√°t v√† t·ª± tin tri·ªÉn khai c√°c subgraph c·ªßa h·ªç!

L√†m theo [h∆∞·ªõng d·∫´n c√†i ƒë·∫∑t Matchstick](https://github.com/LimeChain/matchstick/blob/main/README.md#quick-start-) ƒë·ªÉ c√†i ƒë·∫∑t. B√¢y gi·ªù, b·∫°n c√≥ th·ªÉ chuy·ªÉn sang vi·∫øt b√†i unit test ƒë·∫ßu ti√™n c·ªßa m√¨nh.

## Vi·∫øt Unit Test

H√£y xem m·ªôt b√†i ki·ªÉm tra ƒë∆°n v·ªã ƒë∆°n gi·∫£n s·∫Ω tr√¥ng nh∆∞ th·∫ø n√†o, b·∫±ng c√°ch s·ª≠ d·ª•ng [Subgraph m·∫´u](https://github.com/graphprotocol/example-subgraph) Gravatar.

Gi·∫£ s·ª≠ ch√∫ng ta c√≥ h√†m x·ª≠ l√Ω sau (c√πng v·ªõi hai h√†m tr·ª£ gi√∫p ƒë·ªÉ l√†m cho cu·ªôc s·ªëng c·ªßa ch√∫ng ta d·ªÖ d√†ng h∆°n):

```javascript
export function handleNewGravatar(event: NewGravatar): void {
  let gravatar = new Gravatar(event.params.id.toHex())
  gravatar.owner = event.params.owner
  gravatar.displayName = event.params.displayName
  gravatar.imageUrl = event.params.imageUrl
  gravatar.save()
}

export function handleNewGravatars(events: NewGravatar[]): void {
  events.forEach((event) => {
    handleNewGravatar(event)
  })
}

export function createNewGravatarEvent(
  id: i32,
  ownerAddress: string,
  displayName: string,
  imageUrl: string
): NewGravatar {
  let mockEvent = newMockEvent()
  let newGravatarEvent = new NewGravatar(
    mockEvent.address,
    mockEvent.logIndex,
    mockEvent.transactionLogIndex,
    mockEvent.logType,
    mockEvent.block,
    mockEvent.transaction,
    mockEvent.parameters
  )
  newGravatarEvent.parameters = new Array()
  let idParam = new ethereum.EventParam('id', ethereum.Value.fromI32(id))
  let addressParam = new ethereum.EventParam(
    'ownderAddress',
    ethereum.Value.fromAddress(Address.fromString(ownerAddress))
  )
  let displayNameParam = new ethereum.EventParam('displayName', ethereum.Value.fromString(displayName))
  let imageUrlParam = new ethereum.EventParam('imageUrl', ethereum.Value.fromString(imageUrl))

  newGravatarEvent.parameters.push(idParam)
  newGravatarEvent.parameters.push(addressParam)
  newGravatarEvent.parameters.push(displayNameParam)
  newGravatarEvent.parameters.push(imageUrlParam)

  return newGravatarEvent
}
```

ƒê·∫ßu ti√™n ch√∫ng ta ph·∫£i t·∫°o m·ªôt t·ªáp th·ª≠ nghi·ªám trong d·ª± √°n c·ªßa m√¨nh. Ch√∫ng t√¥i ƒë√£ ch·ªçn t√™n `gravity.test.ts`. Trong t·ªáp m·ªõi t·∫°o, ch√∫ng ta c·∫ßn x√°c ƒë·ªãnh m·ªôt h√†m c√≥ t√™n l√† `runTests()`. ƒêi·ªÅu quan tr·ªçng l√† h√†m ph·∫£i c√≥ t√™n ch√≠nh x√°c ƒë√≥. ƒê√¢y l√† m·ªôt v√≠ d·ª• v·ªÅ c√°ch c√°c b√†i ki·ªÉm tra c·ªßa ch√∫ng ta c√≥ th·ªÉ tr√¥ng nh∆∞ th·∫ø n√†o:

```typescript
import { clearStore, test, assert } from 'matchstick-as/assembly/index'
import { Gravatar } from '../../generated/schema'
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { createNewGravatarEvent, handleNewGravatars } from '../mappings/gravity'

export function runTests(): void {
  test('Can call mappings with custom events', () => {
    // Initialise
    let gravatar = new Gravatar('gravatarId0')
    gravatar.save()

    // Call mappings
    let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

    let anotherGravatarEvent = createNewGravatarEvent(3546, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

    handleNewGravatars([newGravatarEvent, anotherGravatarEvent])

    assert.fieldEquals('Gravatar', 'gravatarId0', 'id', 'gravatarId0')
    assert.fieldEquals('Gravatar', '12345', 'owner', '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
    assert.fieldEquals('Gravatar', '3546', 'displayName', 'cap')

    clearStore()
  })

  test('Next test', () => {
    //...
  })
}
```

Kh√° nhi·ªÅu ƒë·ªÉ gi·∫£i th√≠ch nh·ªâ? Tr∆∞·ªõc h·∫øt, m·ªôt ƒëi·ªÅu quan tr·ªçng c·∫ßn l∆∞u √Ω l√† ch√∫ng ta ƒëang nh·∫≠p m·ªçi th·ª© t·ª´ `matchstick-as`, th∆∞ vi·ªán tr√¨nh tr·ª£ gi√∫p AssemblyScript c·ªßa ch√∫ng ta (ƒë∆∞·ª£c ph√¢n ph·ªëi d∆∞·ªõi d·∫°ng m√¥-ƒëun npm). B·∫°n c√≥ th·ªÉ t√¨m th·∫•y kho l∆∞u tr·ªØ [t·∫°i ƒë√¢y](https://github.com/LimeChain/matchstick-as). `matchstick-as` cung c·∫•p cho ch√∫ng ta c√°c ph∆∞∆°ng ph√°p ki·ªÉm tra h·ªØu √≠ch v√† c≈©ng x√°c ƒë·ªãnh h√†m `test()` m√† ch√∫ng ta s·∫Ω s·ª≠ d·ª•ng ƒë·ªÉ x√¢y d·ª±ng c√°c kh·ªëi ki·ªÉm tra c·ªßa m√¨nh. Ph·∫ßn c√≤n l·∫°i c·ªßa n√≥ kh√° ƒë∆°n gi·∫£n - ƒë√¢y l√† nh·ªØng g√¨ s·∫Ω x·∫£y ra:

- Ch√∫ng ta ƒëang thi·∫øt l·∫≠p tr·∫°ng th√°i ban ƒë·∫ßu v√† th√™m m·ªôt th·ª±c th·ªÉ Gravatar t√πy ch·ªânh;
- Ch√∫ng ta x√°c ƒë·ªãnh hai ƒë·ªëi t∆∞·ª£ng s·ª± ki·ªán `NewGravatar` c√πng v·ªõi d·ªØ li·ªáu c·ªßa ch√∫ng, s·ª≠ d·ª•ng h√†m `createNewGravatarEvent()`;
- Ch√∫ng ta ƒëang g·ªçi c√°c ph∆∞∆°ng th·ª©c x·ª≠ l√Ω cho c√°c s·ª± ki·ªán ƒë√≥ - `handleNewGravatars()` v√† chuy·ªÉn v√†o danh s√°ch c√°c s·ª± ki·ªán t√πy ch·ªânh c·ªßa ch√∫ng ta;
- Ch√∫ng ta kh·∫≥ng ƒë·ªãnh tr·∫°ng th√°i c·ªßa c·ª≠a h√†ng. N√≥ ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o? - Ch√∫ng ta ƒëang chuy·ªÉn m·ªôt s·ª± k·∫øt h·ª£p duy nh·∫•t c·ªßa lo·∫°i Th·ª±c th·ªÉ v√† id. Sau ƒë√≥, ch√∫ng ta ki·ªÉm tra m·ªôt tr∆∞·ªùng c·ª• th·ªÉ tr√™n ƒê·ªëi t∆∞·ª£ng ƒë√≥ v√† kh·∫≥ng ƒë·ªãnh r·∫±ng n√≥ c√≥ gi√° tr·ªã m√† ch√∫ng ta mong ƒë·ª£i. Ch√∫ng ta ƒëang l√†m ƒëi·ªÅu n√†y cho c·∫£ Th·ª±c th·ªÉ Gravatar ban ƒë·∫ßu m√† ch√∫ng ta ƒë√£ th√™m v√†o c·ª≠a h√†ng, c≈©ng nh∆∞ hai th·ª±c th·ªÉ Gravatar ƒë∆∞·ª£c th√™m v√†o khi h√†m x·ª≠ l√Ω ƒë∆∞·ª£c g·ªçi;
- V√† cu·ªëi c√πng - ch√∫ng ta ƒëang d·ªçn d·∫πp c·ª≠a h√†ng b·∫±ng c√°ch s·ª≠ d·ª•ng `clearStore()` ƒë·ªÉ th·ª≠ nghi·ªám ti·∫øp theo c·ªßa ch√∫ng ta c√≥ th·ªÉ b·∫Øt ƒë·∫ßu v·ªõi m·ªôt ƒë·ªëi t∆∞·ª£ng c·ª≠a h√†ng m·ªõi v√† tr·ªëng. Ch√∫ng ta c√≥ th·ªÉ x√°c ƒë·ªãnh bao nhi√™u kh·ªëi th·ª≠ nghi·ªám t√πy th√≠ch.

V·∫≠y l√† xong - ch√∫ng ta ƒë√£ t·∫°o b√†i ki·ªÉm tra ƒë·∫ßu ti√™n c·ªßa m√¨nh! üëè

‚ùó **QUAN TR·ªåNG:** _ƒê·ªÉ c√°c b√†i ki·ªÉm tra ho·∫°t ƒë·ªông, ch√∫ng ta c·∫ßn xu·∫•t h√†m `runTests()` trong t·ªáp √°nh x·∫° c·ªßa ch√∫ng ta. N√≥ s·∫Ω kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng ·ªü ƒë√≥, nh∆∞ng c√¢u l·ªánh xu·∫•t ph·∫£i ·ªü ƒë√≥ ƒë·ªÉ n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c Rust ch·ªçn sau n√†y khi ch·∫°y c√°c b√†i ki·ªÉm tra._

B·∫°n c√≥ th·ªÉ xu·∫•t h√†m tr√¨nh bao b·ªçc ki·ªÉm tra rong t·ªáp √°nh x·∫° c·ªßa m√¨nh nh∆∞ sau:

```
export { runTests } from "../tests/gravity.test.ts";
```

‚ùó **QUAN TR·ªåNG:** _Hi·ªán t·∫°i c√≥ m·ªôt v·∫•n ƒë·ªÅ v·ªõi vi·ªác s·ª≠ d·ª•ng Matchstick khi tri·ªÉn khai subgraph c·ªßa b·∫°n. Vui l√≤ng ch·ªâ s·ª≠ d·ª•ng Matchstick ƒë·ªÉ ki·ªÉm tra c·ª•c b·ªô v√† x√≥a/nh·∫≠n x√©t d√≤ng n√†y (`export { runTests } from "../tests/gravity.test.ts"`) khi b·∫°n ƒë√£ ho√†n th√†nh. Ch√∫ng t√¥i hy v·ªçng s·∫Ω gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y trong th·ªùi gian ng·∫Øn, xin l·ªói v√¨ s·ª± b·∫•t ti·ªán n√†y!_

_N·∫øu b·∫°n kh√¥ng x√≥a d√≤ng ƒë√≥, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o l·ªói sau khi c·ªë g·∫Øng tri·ªÉn khai subgraph c·ªßa m√¨nh:_

```
/...
Mapping terminated before handling trigger: oneshot canceled
.../
```

B√¢y gi·ªù ƒë·ªÉ ch·∫°y c√°c ki·ªÉm tra c·ªßa ch√∫ng ta, b·∫°n ch·ªâ c·∫ßn ch·∫°y ph·∫ßn sau trong th∆∞ m·ª•c g·ªëc c·ªßa subgraph c·ªßa b·∫°n:

`graph test Gravity`

V√† n·∫øu m·ªçi vi·ªác su√¥n s·∫ª, b·∫°n s·∫Ω ƒë∆∞·ª£c ch√†o ƒë√≥n v·ªõi nh·ªØng ƒëi·ªÅu sau:

![Matchstick saying ‚ÄúAll tests passed!‚Äù](/img/matchstick-tests-passed.png)

## C√°c t√¨nh hu·ªëng ki·ªÉm tra ph·ªï bi·∫øn

### Hydrat h√≥a c·ª≠a h√†ng v·ªõi m·ªôt tr·∫°ng th√°i nh·∫•t ƒë·ªãnh

Ng∆∞·ªùi d√πng c√≥ th·ªÉ hydrat h√≥a cho c·ª≠a h√†ng v·ªõi m·ªôt t·∫≠p h·ª£p c√°c th·ª±c th·ªÉ ƒë√£ bi·∫øt. D∆∞·ªõi ƒë√¢y l√† m·ªôt v√≠ d·ª• ƒë·ªÉ kh·ªüi t·∫°o c·ª≠a h√†ng v·ªõi m·ªôt th·ª±c th·ªÉ Gravatar:

```typescript
let gravatar = new Gravatar('entryId')
gravatar.save()
```

### G·ªçi m·ªôt h√†m √°nh x·∫° v·ªõi m·ªôt s·ª± ki·ªán

Ng∆∞·ªùi d√πng c√≥ th·ªÉ t·∫°o m·ªôt s·ª± ki·ªán t√πy ch·ªânh v√† chuy·ªÉn n√≥ ƒë·∫øn m·ªôt h√†m √°nh x·∫° ƒë∆∞·ª£c li√™n k·∫øt v·ªõi store:

```typescript
import { store } from 'matchstick-as/assembly/store'
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { handleNewGravatars, createNewGravatarEvent } from './mapping'

let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

handleNewGravatar(newGravatarEvent)
```

### G·ªçi t·∫•t c·∫£ c√°c √°nh x·∫° v·ªõi c√°c ƒë·ªì ƒë·∫°c s·ª± ki·ªán

Ng∆∞·ªùi d√πng c√≥ th·ªÉ g·ªçi c√°c √°nh x·∫° v·ªõi ƒë·ªì ƒë·∫°c ki·ªÉm tra.

```typescript
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { store } from 'matchstick-as/assembly/store'
import { handleNewGravatars, createNewGravatarEvent } from './mapping'

let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

let anotherGravatarEvent = createNewGravatarEvent(3546, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

handleNewGravatars([newGravatarEvent, anotherGravatarEvent])
```

```
export function handleNewGravatars(events: NewGravatar[]): void {
    events.forEach(event => {
        handleNewGravatar(event);
    });
}
```

### G·ªçi h·ª£p ƒë·ªìng gi·∫£ l·∫≠p

Ng∆∞·ªùi d√πng c√≥ th·ªÉ gi·∫£ l·∫≠p c√°c cu·ªôc g·ªçi h·ª£p ƒë·ªìng:

```typescript
import { addMetadata, assert, createMockedFunction, clearStore, test } from 'matchstick-as/assembly/index'
import { Gravity } from '../../generated/Gravity/Gravity'
import { Address, BigInt, ethereum } from '@graphprotocol/graph-ts'

let contractAddress = Address.fromString('0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
let expectedResult = Address.fromString('0x90cBa2Bbb19ecc291A12066Fd8329D65FA1f1947')
let bigIntParam = BigInt.fromString('1234')
createMockedFunction(contractAddress, 'gravatarToOwner', 'gravatarToOwner(uint256):(address)')
  .withArgs([ethereum.Value.fromSignedBigInt(bigIntParam)])
  .returns([ethereum.Value.fromAddress(Address.fromString('0x90cBa2Bbb19ecc291A12066Fd8329D65FA1f1947'))])

let gravity = Gravity.bind(contractAddress)
let result = gravity.gravatarToOwner(bigIntParam)

assert.equals(ethereum.Value.fromAddress(expectedResult), ethereum.Value.fromAddress(result))
```

As demonstrated, in order to mock a contract call and hardcore a return value, the user must provide a contract address, function name, function signature, an array of arguments, and of course - the return value.

Users can also mock function reverts:

```typescript
let contractAddress = Address.fromString('0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
createMockedFunction(contractAddress, 'getGravatar', 'getGravatar(address):(string,string)')
  .withArgs([ethereum.Value.fromAddress(contractAddress)])
  .reverts()
```

### Asserting the state of the store

Users are able to assert the final (or midway) state of the store through asserting entities. In order to do this, the user has to supply an Entity type, the specific ID of an Entity, a name of a field on that Entity, and the expected value of the field. Here's a quick example:

```typescript
import { assert } from 'matchstick-as/assembly/index'
import { Gravatar } from '../generated/schema'

let gravatar = new Gravatar('gravatarId0')
gravatar.save()

assert.fieldEquals('Gravatar', 'gravatarId0', 'id', 'gravatarId0')
```

Running the assert.fieldEquals() function will check for equality of the given field against the given expected value. The test will fail and an error message will be outputted if the values are **NOT** equal. Otherwise the test will pass successfully.

### Interacting with Event metadata

Users can use default transaction metadata, which could be returned as an ethereum.Event by using the `newMockEvent()` function. The following example shows how you can read/write to those fields on the Event object:

```typescript
// Read
let logType = newGravatarEvent.logType

// Write
let UPDATED_ADDRESS = '0xB16081F360e3847006dB660bae1c6d1b2e17eC2A'
newGravatarEvent.address = Address.fromString(UPDATED_ADDRESS)
```

### Asserting variable equality

```typescript
assert.equals(ethereum.Value.fromString("hello"); ethereum.Value.fromString("hello"));
```

### Asserting that an Entity is **not** in the store

Users can assert that an entity does not exist in the store. The function takes an entity type and an id. If the entity is in fact in the store, the test will fail with a relevant error message. Here's a quick example of how to use this functionality:

```typescript
assert.notInStore('Gravatar', '23')
```

### Test run time duration in the log output

The log output includes the test run duration. Here's an example:

`Jul 09 14:54:42.420 INFO Program execution time: 10.06022ms`

## Feedback

If you have any questions, feedback, feature requests or just want to reach out, the best place would be The Graph Discord where we have a dedicated channel for Matchstick, called üî•| unit-testing.
