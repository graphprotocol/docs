---
title: Khung Unit Test
---

Matchstick lÃ  má»™t khung unit test Ä‘Æ°á»£c phÃ¡t triá»ƒn bá»Ÿi [LimeChain](https://limechain.tech/), cho phÃ©p cÃ¡c nhÃ  phÃ¡t triá»ƒn subgraph kiá»ƒm tra logic Ã¡nh xáº¡ cá»§a há» trong mÃ´i trÆ°á»ng há»™p cÃ¡t vÃ  tá»± tin triá»ƒn khai cÃ¡c subgraph cá»§a há»!

LÃ m theo [hÆ°á»›ng dáº«n cÃ i Ä‘áº·t Matchstick](https://github.com/LimeChain/matchstick/blob/main/README.md#quick-start-) Ä‘á»ƒ cÃ i Ä‘áº·t. BÃ¢y giá», báº¡n cÃ³ thá»ƒ chuyá»ƒn sang viáº¿t bÃ i unit test Ä‘áº§u tiÃªn cá»§a mÃ¬nh.

## Viáº¿t Unit Test

HÃ£y xem má»™t bÃ i kiá»ƒm tra Ä‘Æ¡n vá»‹ Ä‘Æ¡n giáº£n sáº½ trÃ´ng nhÆ° tháº¿ nÃ o, báº±ng cÃ¡ch sá»­ dá»¥ng [Subgraph máº«u](https://github.com/graphprotocol/example-subgraph) Gravatar.

Giáº£ sá»­ chÃºng ta cÃ³ hÃ m xá»­ lÃ½ sau (cÃ¹ng vá»›i hai hÃ m trá»£ giÃºp Ä‘á»ƒ lÃ m cho cuá»™c sá»‘ng cá»§a chÃºng ta dá»… dÃ ng hÆ¡n):

```javascript
export function handleNewGravatar(event: NewGravatar): void {
  let gravatar = new Gravatar(event.params.id.toHex())
  gravatar.owner = event.params.owner
  gravatar.displayName = event.params.displayName
  gravatar.imageUrl = event.params.imageUrl
  gravatar.save()
}

export function handleNewGravatars(events: NewGravatar[]): void {
  events.forEach((event) => {
    handleNewGravatar(event)
  })
}

export function createNewGravatarEvent(
  id: i32,
  ownerAddress: string,
  displayName: string,
  imageUrl: string
): NewGravatar {
  let mockEvent = newMockEvent()
  let newGravatarEvent = new NewGravatar(
    mockEvent.address,
    mockEvent.logIndex,
    mockEvent.transactionLogIndex,
    mockEvent.logType,
    mockEvent.block,
    mockEvent.transaction,
    mockEvent.parameters
  )
  newGravatarEvent.parameters = new Array()
  let idParam = new ethereum.EventParam('id', ethereum.Value.fromI32(id))
  let addressParam = new ethereum.EventParam(
    'ownderAddress',
    ethereum.Value.fromAddress(Address.fromString(ownerAddress))
  )
  let displayNameParam = new ethereum.EventParam('displayName', ethereum.Value.fromString(displayName))
  let imageUrlParam = new ethereum.EventParam('imageUrl', ethereum.Value.fromString(imageUrl))

  newGravatarEvent.parameters.push(idParam)
  newGravatarEvent.parameters.push(addressParam)
  newGravatarEvent.parameters.push(displayNameParam)
  newGravatarEvent.parameters.push(imageUrlParam)

  return newGravatarEvent
}
```

Äáº§u tiÃªn chÃºng ta pháº£i táº¡o má»™t tá»‡p thá»­ nghiá»‡m trong dá»± Ã¡n cá»§a mÃ¬nh. ChÃºng tÃ´i Ä‘Ã£ chá»n tÃªn `gravity.test.ts`. Trong tá»‡p má»›i táº¡o, chÃºng ta cáº§n xÃ¡c Ä‘á»‹nh má»™t hÃ m cÃ³ tÃªn lÃ  `runTests()`. Äiá»u quan trá»ng lÃ  hÃ m pháº£i cÃ³ tÃªn chÃ­nh xÃ¡c Ä‘Ã³. ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ vá» cÃ¡ch cÃ¡c bÃ i kiá»ƒm tra cá»§a chÃºng ta cÃ³ thá»ƒ trÃ´ng nhÆ° tháº¿ nÃ o:

```typescript
import { clearStore, test, assert } from 'matchstick-as/assembly/index'
import { Gravatar } from '../../generated/schema'
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { createNewGravatarEvent, handleNewGravatars } from '../mappings/gravity'

export function runTests(): void {
  test('Can call mappings with custom events', () => {
    // Initialise
    let gravatar = new Gravatar('gravatarId0')
    gravatar.save()

    // Call mappings
    let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

    let anotherGravatarEvent = createNewGravatarEvent(3546, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

    handleNewGravatars([newGravatarEvent, anotherGravatarEvent])

    assert.fieldEquals('Gravatar', 'gravatarId0', 'id', 'gravatarId0')
    assert.fieldEquals('Gravatar', '12345', 'owner', '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
    assert.fieldEquals('Gravatar', '3546', 'displayName', 'cap')

    clearStore()
  })

  test('Next test', () => {
    //...
  })
}
```

KhÃ¡ nhiá»u Ä‘á»ƒ giáº£i thÃ­ch nhá»‰? TrÆ°á»›c háº¿t, má»™t Ä‘iá»u quan trá»ng cáº§n lÆ°u Ã½ lÃ  chÃºng ta Ä‘ang nháº­p má»i thá»© tá»« `matchstick-as`, thÆ° viá»‡n trÃ¬nh trá»£ giÃºp AssemblyScript cá»§a chÃºng ta (Ä‘Æ°á»£c phÃ¢n phá»‘i dÆ°á»›i dáº¡ng mÃ´-Ä‘un npm). Báº¡n cÃ³ thá»ƒ tÃ¬m tháº¥y kho lÆ°u trá»¯ [táº¡i Ä‘Ã¢y](https://github.com/LimeChain/matchstick-as). `matchstick-as` cung cáº¥p cho chÃºng ta cÃ¡c phÆ°Æ¡ng phÃ¡p kiá»ƒm tra há»¯u Ã­ch vÃ  cÅ©ng xÃ¡c Ä‘á»‹nh hÃ m `test()` mÃ  chÃºng ta sáº½ sá»­ dá»¥ng Ä‘á»ƒ xÃ¢y dá»±ng cÃ¡c khá»‘i kiá»ƒm tra cá»§a mÃ¬nh. Pháº§n cÃ²n láº¡i cá»§a nÃ³ khÃ¡ Ä‘Æ¡n giáº£n - Ä‘Ã¢y lÃ  nhá»¯ng gÃ¬ sáº½ xáº£y ra:

- ChÃºng ta Ä‘ang thiáº¿t láº­p tráº¡ng thÃ¡i ban Ä‘áº§u vÃ  thÃªm má»™t thá»±c thá»ƒ Gravatar tÃ¹y chá»‰nh;
- ChÃºng ta xÃ¡c Ä‘á»‹nh hai Ä‘á»‘i tÆ°á»£ng sá»± kiá»‡n `NewGravatar` cÃ¹ng vá»›i dá»¯ liá»‡u cá»§a chÃºng, sá»­ dá»¥ng hÃ m `createNewGravatarEvent()`;
- ChÃºng ta Ä‘ang gá»i cÃ¡c phÆ°Æ¡ng thá»©c xá»­ lÃ½ cho cÃ¡c sá»± kiá»‡n Ä‘Ã³ - `handleNewGravatars()` vÃ  chuyá»ƒn vÃ o danh sÃ¡ch cÃ¡c sá»± kiá»‡n tÃ¹y chá»‰nh cá»§a chÃºng ta;
- ChÃºng ta kháº³ng Ä‘á»‹nh tráº¡ng thÃ¡i cá»§a cá»­a hÃ ng. NÃ³ hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o? - ChÃºng ta Ä‘ang chuyá»ƒn má»™t sá»± káº¿t há»£p duy nháº¥t cá»§a loáº¡i Thá»±c thá»ƒ vÃ  id. Sau Ä‘Ã³, chÃºng ta kiá»ƒm tra má»™t trÆ°á»ng cá»¥ thá»ƒ trÃªn Äá»‘i tÆ°á»£ng Ä‘Ã³ vÃ  kháº³ng Ä‘á»‹nh ráº±ng nÃ³ cÃ³ giÃ¡ trá»‹ mÃ  chÃºng ta mong Ä‘á»£i. ChÃºng ta Ä‘ang lÃ m Ä‘iá»u nÃ y cho cáº£ Thá»±c thá»ƒ Gravatar ban Ä‘áº§u mÃ  chÃºng ta Ä‘Ã£ thÃªm vÃ o cá»­a hÃ ng, cÅ©ng nhÆ° hai thá»±c thá»ƒ Gravatar Ä‘Æ°á»£c thÃªm vÃ o khi hÃ m xá»­ lÃ½ Ä‘Æ°á»£c gá»i;
- VÃ  cuá»‘i cÃ¹ng - chÃºng ta Ä‘ang dá»n dáº¹p cá»­a hÃ ng báº±ng cÃ¡ch sá»­ dá»¥ng `clearStore()` Ä‘á»ƒ thá»­ nghiá»‡m tiáº¿p theo cá»§a chÃºng ta cÃ³ thá»ƒ báº¯t Ä‘áº§u vá»›i má»™t Ä‘á»‘i tÆ°á»£ng cá»­a hÃ ng má»›i vÃ  trá»‘ng. ChÃºng ta cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh bao nhiÃªu khá»‘i thá»­ nghiá»‡m tÃ¹y thÃ­ch.

Váº­y lÃ  xong - chÃºng ta Ä‘Ã£ táº¡o bÃ i kiá»ƒm tra Ä‘áº§u tiÃªn cá»§a mÃ¬nh! ğŸ‘

â— **QUAN TRá»ŒNG:** _Äá»ƒ cÃ¡c bÃ i kiá»ƒm tra hoáº¡t Ä‘á»™ng, chÃºng ta cáº§n xuáº¥t hÃ m `runTests()` trong tá»‡p Ã¡nh xáº¡ cá»§a chÃºng ta. NÃ³ sáº½ khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ Ä‘Ã³, nhÆ°ng cÃ¢u lá»‡nh xuáº¥t pháº£i á»Ÿ Ä‘Ã³ Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c Rust chá»n sau nÃ y khi cháº¡y cÃ¡c bÃ i kiá»ƒm tra._

Báº¡n cÃ³ thá»ƒ xuáº¥t hÃ m trÃ¬nh bao bá»c kiá»ƒm tra rong tá»‡p Ã¡nh xáº¡ cá»§a mÃ¬nh nhÆ° sau:

```
export { runTests } from "../tests/gravity.test.ts";
```

â— **QUAN TRá»ŒNG:** _Hiá»‡n táº¡i cÃ³ má»™t váº¥n Ä‘á» vá»›i viá»‡c sá»­ dá»¥ng Matchstick khi triá»ƒn khai subgraph cá»§a báº¡n. Vui lÃ²ng chá»‰ sá»­ dá»¥ng Matchstick Ä‘á»ƒ kiá»ƒm tra cá»¥c bá»™ vÃ  xÃ³a/nháº­n xÃ©t dÃ²ng nÃ y (`export { runTests } from "../tests/gravity.test.ts"`) khi báº¡n Ä‘Ã£ hoÃ n thÃ nh. ChÃºng tÃ´i hy vá»ng sáº½ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y trong thá»i gian ngáº¯n, xin lá»—i vÃ¬ sá»± báº¥t tiá»‡n nÃ y!_

_Náº¿u báº¡n khÃ´ng xÃ³a dÃ²ng Ä‘Ã³, báº¡n sáº½ nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o lá»—i sau khi cá»‘ gáº¯ng triá»ƒn khai subgraph cá»§a mÃ¬nh:_

```
/...
Mapping terminated before handling trigger: oneshot canceled
.../
```

BÃ¢y giá» Ä‘á»ƒ cháº¡y cÃ¡c kiá»ƒm tra cá»§a chÃºng ta, báº¡n chá»‰ cáº§n cháº¡y pháº§n sau trong thÆ° má»¥c gá»‘c cá»§a subgraph cá»§a báº¡n:

`graph test Gravity`

VÃ  náº¿u má»i viá»‡c suÃ´n sáº», báº¡n sáº½ Ä‘Æ°á»£c chÃ o Ä‘Ã³n vá»›i nhá»¯ng Ä‘iá»u sau:

![Matchstick saying â€œAll tests passed!â€](/img/matchstick-tests-passed.png)

## CÃ¡c tÃ¬nh huá»‘ng kiá»ƒm tra phá»• biáº¿n

### Hydrat hÃ³a cá»­a hÃ ng vá»›i má»™t tráº¡ng thÃ¡i nháº¥t Ä‘á»‹nh

NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ hydrat hÃ³a cho cá»­a hÃ ng vá»›i má»™t táº­p há»£p cÃ¡c thá»±c thá»ƒ Ä‘Ã£ biáº¿t. DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ Ä‘á»ƒ khá»Ÿi táº¡o cá»­a hÃ ng vá»›i má»™t thá»±c thá»ƒ Gravatar:

```typescript
let gravatar = new Gravatar('entryId')
gravatar.save()
```

### Gá»i má»™t hÃ m Ã¡nh xáº¡ vá»›i má»™t sá»± kiá»‡n

NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ táº¡o má»™t sá»± kiá»‡n tÃ¹y chá»‰nh vÃ  chuyá»ƒn nÃ³ Ä‘áº¿n má»™t hÃ m Ã¡nh xáº¡ Ä‘Æ°á»£c liÃªn káº¿t vá»›i store:

```typescript
import { store } from 'matchstick-as/assembly/store'
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { handleNewGravatars, createNewGravatarEvent } from './mapping'

let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

handleNewGravatar(newGravatarEvent)
```

### Gá»i táº¥t cáº£ cÃ¡c Ã¡nh xáº¡ vá»›i cÃ¡c Ä‘á»“ Ä‘áº¡c sá»± kiá»‡n

NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ gá»i cÃ¡c Ã¡nh xáº¡ vá»›i Ä‘á»“ Ä‘áº¡c kiá»ƒm tra.

```typescript
import { NewGravatar } from '../../generated/Gravity/Gravity'
import { store } from 'matchstick-as/assembly/store'
import { handleNewGravatars, createNewGravatarEvent } from './mapping'

let newGravatarEvent = createNewGravatarEvent(12345, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

let anotherGravatarEvent = createNewGravatarEvent(3546, '0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7', 'cap', 'pac')

handleNewGravatars([newGravatarEvent, anotherGravatarEvent])
```

```
export function handleNewGravatars(events: NewGravatar[]): void {
    events.forEach(event => {
        handleNewGravatar(event);
    });
}
```

### Giáº£ láº­p gá»i há»£p Ä‘á»“ng

NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ giáº£ láº­p cÃ¡c cuá»™c gá»i há»£p Ä‘á»“ng:

```typescript
import { addMetadata, assert, createMockedFunction, clearStore, test } from 'matchstick-as/assembly/index'
import { Gravity } from '../../generated/Gravity/Gravity'
import { Address, BigInt, ethereum } from '@graphprotocol/graph-ts'

let contractAddress = Address.fromString('0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
let expectedResult = Address.fromString('0x90cBa2Bbb19ecc291A12066Fd8329D65FA1f1947')
let bigIntParam = BigInt.fromString('1234')
createMockedFunction(contractAddress, 'gravatarToOwner', 'gravatarToOwner(uint256):(address)')
  .withArgs([ethereum.Value.fromSignedBigInt(bigIntParam)])
  .returns([ethereum.Value.fromAddress(Address.fromString('0x90cBa2Bbb19ecc291A12066Fd8329D65FA1f1947'))])

let gravity = Gravity.bind(contractAddress)
let result = gravity.gravatarToOwner(bigIntParam)

assert.equals(ethereum.Value.fromAddress(expectedResult), ethereum.Value.fromAddress(result))
```

NhÆ° Ä‘Ã£ chá»©ng minh, Ä‘á»ƒ giáº£ láº­p má»™t lá»‡nh gá»i há»£p Ä‘á»“ng vÃ  táº¡o ra má»™t giÃ¡ trá»‹ tráº£ vá», ngÆ°á»i dÃ¹ng pháº£i cung cáº¥p Ä‘á»‹a chá»‰ há»£p Ä‘á»“ng, tÃªn hÃ m, chá»¯ kÃ½ hÃ m, má»™t máº£ng Ä‘á»‘i sá»‘ vÃ  táº¥t nhiÃªn - giÃ¡ trá»‹ tráº£ vá».

NgÆ°á»i dÃ¹ng cÅ©ng cÃ³ thá»ƒ giáº£ láº­p cÃ¡c láº§n hoÃ n nguyÃªn chá»©c nÄƒng:

```typescript
let contractAddress = Address.fromString('0x89205A3A3b2A69De6Dbf7f01ED13B2108B2c43e7')
createMockedFunction(contractAddress, 'getGravatar', 'getGravatar(address):(string,string)')
  .withArgs([ethereum.Value.fromAddress(contractAddress)])
  .reverts()
```

### Kháº³ng Ä‘á»‹nh tráº¡ng thÃ¡i cá»§a cá»­a hÃ ng

NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ xÃ¡c nháº­n tráº¡ng thÃ¡i cuá»‘i cÃ¹ng (hoáº·c giá»¯a chá»«ng) cá»§a cá»­a hÃ ng thÃ´ng qua cÃ¡c thá»±c thá»ƒ xÃ¡c nháº­n. Äá»ƒ thá»±c hiá»‡n viá»‡c nÃ y, ngÆ°á»i dÃ¹ng pháº£i cung cáº¥p loáº¡i Äá»‘i tÆ°á»£ng, ID cá»¥ thá»ƒ cá»§a Äá»‘i tÆ°á»£ng, tÃªn cá»§a má»™t trÆ°á»ng trÃªn Äá»‘i tÆ°á»£ng Ä‘Ã³ vÃ  giÃ¡ trá»‹ mong Ä‘á»£i cá»§a trÆ°á»ng. ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ nhanh:

```typescript
import { assert } from 'matchstick-as/assembly/index'
import { Gravatar } from '../generated/schema'

let gravatar = new Gravatar('gravatarId0')
gravatar.save()

assert.fieldEquals('Gravatar', 'gravatarId0', 'id', 'gravatarId0')
```

Cháº¡y hÃ m kháº³ng Ä‘á»‹nh assert.fieldEquals() sáº½ kiá»ƒm tra sá»± bÃ¬nh Ä‘áº³ng cá»§a trÆ°á»ng Ä‘Ã£ cho so vá»›i giÃ¡ trá»‹ mong Ä‘á»£i Ä‘Ã£ cho. QuÃ¡ trÃ¬nh kiá»ƒm tra sáº½ khÃ´ng thÃ nh cÃ´ng vÃ  má»™t thÃ´ng bÃ¡o lá»—i sáº½ Ä‘Æ°á»£c xuáº¥t ra náº¿u cÃ¡c giÃ¡ trá»‹ lÃ  **KHÃ”NG** bÃ¬nh Ä‘áº³ng. Náº¿u khÃ´ng, bÃ i kiá»ƒm tra sáº½ vÆ°á»£t qua thÃ nh cÃ´ng.

### TÆ°Æ¡ng tÃ¡c vá»›i siÃªu dá»¯ liá»‡u Sá»± kiá»‡n

NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ sá»­ dá»¥ng siÃªu dá»¯ liá»‡u giao dá»‹ch máº·c Ä‘á»‹nh, siÃªu dá»¯ liá»‡u nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c tráº£ vá» dÆ°á»›i dáº¡ng ethereum.Event báº±ng cÃ¡ch sá»­ dá»¥ng hÃ m `newMockEvent()`. VÃ­ dá»¥ sau cho tháº¥y cÃ¡ch báº¡n cÃ³ thá»ƒ Ä‘á»c/ghi cÃ¡c trÆ°á»ng Ä‘Ã³ trÃªn Ä‘á»‘i tÆ°á»£ng Sá»± kiá»‡n:

```typescript
// Äá»c
let logType = newGravatarEvent.logType

// Ghi
let UPDATED_ADDRESS = '0xB16081F360e3847006dB660bae1c6d1b2e17eC2A'
newGravatarEvent.address = Address.fromString(UPDATED_ADDRESS)
```

### Kháº³ng Ä‘á»‹nh bÃ¬nh Ä‘áº³ng biáº¿n

```typescript
assert.equals(ethereum.Value.fromString("hello"); ethereum.Value.fromString("hello"));
```

### Kháº³ng Ä‘á»‹nh ráº±ng má»™t Thá»±c thá»ƒ **khÃ´ng** trong cá»­a hÃ ng

NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ kháº³ng Ä‘á»‹nh ráº±ng má»™t thá»±c thá»ƒ khÃ´ng tá»“n táº¡i trong cá»­a hÃ ng. HÃ m nháº­n má»™t loáº¡i thá»±c thá»ƒ vÃ  má»™t id. Náº¿u thá»±c thá»ƒ náº±m trong cá»­a hÃ ng, quÃ¡ trÃ¬nh kiá»ƒm tra sáº½ khÃ´ng thÃ nh cÃ´ng vá»›i má»™t thÃ´ng bÃ¡o lá»—i liÃªn quan. DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ nhanh vá» cÃ¡ch sá»­ dá»¥ng chá»©c nÄƒng nÃ y:

```typescript
assert.notInStore('Gravatar', '23')
```

### Khoáº£ng thá»i gian cháº¡y kiá»ƒm tra trong Ä‘áº§u ra log

Äáº§u ra log bao gá»“m thá»i lÆ°á»£ng cháº¡y kiá»ƒm tra. ÄÃ¢y lÃ  má»™t vÃ­ dá»¥:

`Jul 09 14:54:42.420 INFO Program execution time: 10.06022ms`

## Pháº£n há»“i

Náº¿u báº¡n cÃ³ báº¥t ká»³ cÃ¢u há»i, pháº£n há»“i, yÃªu cáº§u tÃ­nh nÄƒng nÃ o hoáº·c chá»‰ muá»‘n liÃªn há»‡, nÆ¡i tá»‘t nháº¥t lÃ  The Graph Discord, nÆ¡i chÃºng tÃ´i cÃ³ má»™t kÃªnh dÃ nh riÃªng cho Matchstick, Ä‘Æ°á»£c gá»i lÃ  ğŸ”¥| unit-testing.
