user nginx;
worker_processes 1;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;

    gzip on;
    gzip_static on;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_proxied any;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;

    server {
        listen 80;
        root /usr/share/nginx/html;
        index index.html index.htm;
        
        # Short cache with revalidation
        add_header Cache-Control "no-cache, must-revalidate";
        expires 5m;

        # Redirect `http` to `https`
        if ($http_x_forwarded_proto = "http") {
            return 301 https://$host$request_uri;
        }

        # Normalize URLs
        merge_slashes off; # required for the next two rules to see the adjacent slashes
        rewrite ^//+(.*)        $scheme://$http_host/$1     permanent; # remove adjacent slashes at the start of the URI
        rewrite ^/(.*)//+(.*)   $scheme://$http_host/$1/$2  permanent; # remove adjacent slashes in the middle of the URI
        rewrite ^/([^.]*[^/])$  $scheme://$http_host/$1/    permanent; # force a trailing slash except for files with an extension

        # Redirect to `/en` if no language in URL and not an asset URL
        rewrite ^/docs/(?!(?:[a-zA-Z][a-zA-Z]|_next|img)(?:/|$))(.*)$ $scheme://$http_host/docs/en/$1 permanent;

        # Redirect non-English language paths to `/en`
        rewrite ^/docs/(?!en(?:/|$))[a-zA-Z][a-zA-Z](?:/(.*))?$ $scheme://$http_host/docs/en/$1 permanent;

        # Permanent redirects (301)
        rewrite ^/docs/en/about/introduction/$                          $scheme://$http_host/docs/en/about/                                                 permanent;
        rewrite ^/docs/en/arbitrum-faq/$                                $scheme://$http_host/docs/en/archived/arbitrum/arbitrum-faq/                        permanent;
        rewrite ^/docs/en/arbitrum/l2-transfer-tools-faq/$              $scheme://$http_host/docs/en/archived/arbitrum/l2-transfer-tools-faq/               permanent;
        rewrite ^/docs/en/arbitrum/l2-transfer-tools-guide/$            $scheme://$http_host/docs/en/archived/arbitrum/l2-transfer-tools-guide/             permanent;
        rewrite ^/docs/en/billing/$                                     $scheme://$http_host/docs/en/subgraphs/billing/                                     permanent;
        rewrite ^/docs/en/chain-integration-overview/$                  $scheme://$http_host/docs/en/indexing/chain-integration-overview/                   permanent;
        rewrite ^/docs/en/cookbook/arweave/$                            $scheme://$http_host/docs/en/subgraphs/cookbook/arweave/                            permanent;
        rewrite ^/docs/en/cookbook/avoid-eth-calls/$                    $scheme://$http_host/docs/en/subgraphs/best-practices/avoid-eth-calls/              permanent;
        rewrite ^/docs/en/subgraphs/cookbook/avoid-eth-calls/$          $scheme://$http_host/docs/en/subgraphs/best-practices/avoid-eth-calls/              permanent;
        rewrite ^/docs/en/cookbook/derivedfrom/$                        $scheme://$http_host/docs/en/subgraphs/best-practices/derivedfrom/                  permanent;
        rewrite ^/docs/en/subgraphs/cookbook/derivedfrom/$              $scheme://$http_host/docs/en/subgraphs/best-practices/derivedfrom/                  permanent;
        rewrite ^/docs/en/cookbook/enums/$                              $scheme://$http_host/docs/en/subgraphs/cookbook/enums/                              permanent;
        rewrite ^/docs/en/cookbook/grafting-hotfix/$                    $scheme://$http_host/docs/en/subgraphs/best-practices/grafting-hotfix/              permanent;
        rewrite ^/docs/en/subgraphs/cookbook/grafting-hotfix/$          $scheme://$http_host/docs/en/subgraphs/best-practices/grafting-hotfix/              permanent;
        rewrite ^/docs/en/cookbook/grafting/$                           $scheme://$http_host/docs/en/subgraphs/cookbook/grafting/                           permanent;
        rewrite ^/docs/en/cookbook/immutable-entities-bytes-as-ids/$    $scheme://$http_host/docs/en/subgraphs/best-practices/immutable-entities-bytes-as-ids/ permanent;
        rewrite ^/docs/en/subgraphs/cookbook/immutable-entities-bytes-as-ids/$ $scheme://$http_host/docs/en/subgraphs/best-practices/immutable-entities-bytes-as-ids/ permanent;
        rewrite ^/docs/en/cookbook/near/$                               $scheme://$http_host/docs/en/subgraphs/cookbook/near/                               permanent;
        rewrite ^/docs/en/cookbook/pruning/$                            $scheme://$http_host/docs/en/subgraphs/best-practices/pruning/                      permanent;
        rewrite ^/docs/en/subgraphs/cookbook/pruning/$                  $scheme://$http_host/docs/en/subgraphs/best-practices/pruning/                      permanent;
        rewrite ^/docs/en/cookbook/quick-start/$                        $scheme://$http_host/docs/en/subgraphs/quick-start/                                 permanent;
        rewrite ^/docs/en/cookbook/subgraph-debug-forking/$             $scheme://$http_host/docs/en/subgraphs/cookbook/subgraph-debug-forking/             permanent;
        rewrite ^/docs/en/cookbook/subgraph-uncrashable/$               $scheme://$http_host/docs/en/subgraphs/cookbook/subgraph-uncrashable/               permanent;
        rewrite ^/docs/en/cookbook/substreams-powered-subgraphs/$       $scheme://$http_host/docs/en/substreams/sps/introduction/                           permanent;
        rewrite ^/docs/en/subgraphs/cookbook/substreams-powered-subgraphs/$ $scheme://$http_host/docs/en/substreams/sps/introduction/                       permanent;
        rewrite ^/docs/en/cookbook/timeseries/$                         $scheme://$http_host/docs/en/subgraphs/best-practices/timeseries/                   permanent;
        rewrite ^/docs/en/subgraphs/cookbook/timeseries/$               $scheme://$http_host/docs/en/subgraphs/best-practices/timeseries/                   permanent;
        rewrite ^/docs/en/cookbook/transfer-to-the-graph/$              $scheme://$http_host/docs/en/subgraphs/cookbook/transfer-to-the-graph/              permanent;
        rewrite ^/docs/en/subgraphs/cookbook/(.*)$                      $scheme://$http_host/docs/en/subgraphs/guides/$1                                    permanent;
        rewrite ^/docs/en/curating/$                                    $scheme://$http_host/docs/en/resources/roles/curating/                              permanent;
        rewrite ^/docs/en/delegating/$                                  $scheme://$http_host/docs/en/resources/roles/delegating/delegating/                 permanent;
        rewrite ^/docs/en/deploying/deploy-using-subgraph-studio/$      $scheme://$http_host/docs/en/subgraphs/developing/deploying/using-subgraph-studio/  permanent;
        rewrite ^/docs/en/deploying/deploying-a-subgraph-to-studio/$    $scheme://$http_host/docs/en/subgraphs/developing/deploying/using-subgraph-studio/  permanent;
        rewrite ^/docs/en/deploying/multiple-networks/$                 $scheme://$http_host/docs/en/subgraphs/developing/deploying/multiple-networks/      permanent;
        rewrite ^/docs/en/deploying/subgraph-studio-faqs/$              $scheme://$http_host/docs/en/resources/subgraph-studio-faq/                         permanent;
        rewrite ^/docs/en/subgraphs/developing/deploying/subgraph-studio-faq/$ $scheme://$http_host/docs/en/resources/subgraph-studio-faq/                  permanent;
        rewrite ^/docs/en/deploying/subgraph-studio/$                   $scheme://$http_host/docs/en/subgraphs/developing/deploying/using-subgraph-studio/  permanent;
        rewrite ^/docs/en/developer/quick-start/$                       $scheme://$http_host/docs/en/subgraphs/quick-start/                                 permanent;
        rewrite ^/docs/en/developing/assemblyscript-api/$               $scheme://$http_host/docs/en/subgraphs/developing/creating/graph-ts/api/            permanent;
        rewrite ^/docs/en/developing/creating-a-subgraph/$              $scheme://$http_host/docs/en/subgraphs/developing/creating/starting-your-subgraph/  permanent;
        rewrite ^/docs/en/developing/creating-a-subgraph/starting-your-subgraph/$ $scheme://$http_host/docs/en/subgraphs/developing/creating/starting-your-subgraph/ permanent;
        rewrite ^/docs/en/developing/creating-a-subgraph/install-the-cli/$ $scheme://$http_host/docs/en/subgraphs/developing/creating/install-the-cli/      permanent;
        rewrite ^/docs/en/developing/creating-a-subgraph/ql-schema/$    $scheme://$http_host/docs/en/subgraphs/developing/creating/ql-schema/               permanent;
        rewrite ^/docs/en/developing/creating-a-subgraph/assemblyscript-mappings/$ $scheme://$http_host/docs/en/subgraphs/developing/creating/assemblyscript-mappings/ permanent;
        rewrite ^/docs/en/developing/creating-a-subgraph/advanced/$     $scheme://$http_host/docs/en/subgraphs/developing/creating/advanced/                permanent;
        rewrite ^/docs/en/developing/defining-a-subgraph/$              $scheme://$http_host/docs/en/subgraphs/developing/creating/starting-your-subgraph/  permanent;
        rewrite ^/docs/en/developing/developer-faqs/$                   $scheme://$http_host/docs/en/subgraphs/developing/developer-faq/                    permanent;
        rewrite ^/docs/en/developing/graph-ts/api/$                     $scheme://$http_host/docs/en/subgraphs/developing/creating/graph-ts/api/            permanent;
        rewrite ^/docs/en/developing/graph-ts/CHANGELOG/$               $scheme://$http_host/docs/en/subgraphs/developing/creating/graph-ts/CHANGELOG/      permanent;
        rewrite ^/docs/en/developing/graph-ts/common-issues/$           $scheme://$http_host/docs/en/subgraphs/developing/creating/graph-ts/common-issues/  permanent;
        rewrite ^/docs/en/developing/graph-ts/README/$                  $scheme://$http_host/docs/en/subgraphs/developing/creating/graph-ts/README/         permanent;
        rewrite ^/docs/en/developing/substreams-powered-subgraphs-faq/$ $scheme://$http_host/docs/en/substreams/sps/faq/                                    permanent;
        rewrite ^/docs/en/developing/supported-networks/$               $scheme://$http_host/docs/en/supported-networks/                                    permanent;
        rewrite ^/docs/en/developing/unit-testing-framework/$           $scheme://$http_host/docs/en/subgraphs/developing/creating/unit-testing-framework/  permanent;
        rewrite ^/docs/en/explorer/$                                    $scheme://$http_host/docs/en/subgraphs/explorer/                                    permanent;
        rewrite ^/docs/en/firehose/$                                    $scheme://$http_host/docs/en/indexing/tooling/firehose/                             permanent;
        rewrite ^/docs/en/glossary/$                                    $scheme://$http_host/docs/en/resources/glossary/                                    permanent;
        rewrite ^/docs/en/graph-assistant/quick-start/$                 $scheme://$http_host/docs/en/ai-suite/graph-assistant/quick-start/                  permanent;
        rewrite ^/docs/en/graphcast/$                                   $scheme://$http_host/docs/en/indexing/tooling/graphcast/                            permanent;
        rewrite ^/docs/en/indexing/$                                    $scheme://$http_host/docs/en/indexing/overview/                                     permanent;
        rewrite ^/docs/en/managing/delete-a-subgraph/$                  $scheme://$http_host/docs/en/subgraphs/developing/managing/deleting-a-subgraph/     permanent;
        rewrite ^/docs/en/managing/deprecate-a-subgraph/$               $scheme://$http_host/docs/en/subgraphs/developing/managing/deleting-a-subgraph/     permanent;
        rewrite ^/docs/en/managing/transfer-a-subgraph/$                $scheme://$http_host/docs/en/subgraphs/developing/managing/transferring-a-subgraph/ permanent;
        rewrite ^/docs/en/network-transition-faq/$                      $scheme://$http_host/docs/en/archived/arbitrum/arbitrum-faq/                        permanent;
        rewrite ^/docs/en/network/benefits/$                            $scheme://$http_host/docs/en/resources/benefits/                                    permanent;
        rewrite ^/docs/en/network/contracts/$                           $scheme://$http_host/docs/en/contracts/                                             permanent;
        rewrite ^/docs/en/network/curating/$                            $scheme://$http_host/docs/en/resources/roles/curating/                              permanent;
        rewrite ^/docs/en/network/delegating/$                          $scheme://$http_host/docs/en/resources/roles/delegating/delegating/                 permanent;
        rewrite ^/docs/en/network/developing/$                          $scheme://$http_host/docs/en/subgraphs/developing/introduction/                     permanent;
        rewrite ^/docs/en/network/explorer/$                            $scheme://$http_host/docs/en/subgraphs/explorer/                                    permanent;
        rewrite ^/docs/en/network/indexing/$                            $scheme://$http_host/docs/en/indexing/overview/                                     permanent;
        rewrite ^/docs/en/new-chain-integration/$                       $scheme://$http_host/docs/en/indexing/new-chain-integration/                        permanent;
        rewrite ^/docs/en/operating-graph-node/$                        $scheme://$http_host/docs/en/indexing/tooling/graph-node/                           permanent;
        rewrite ^/docs/en/publishing/publishing-a-subgraph/$            $scheme://$http_host/docs/en/subgraphs/developing/publishing/publishing-a-subgraph/ permanent;
        rewrite ^/docs/en/querying/distributed-systems/$                $scheme://$http_host/docs/en/subgraphs/querying/distributed-systems/                permanent;
        rewrite ^/docs/en/querying/graph-client/README/$                $scheme://$http_host/docs/en/subgraphs/querying/graph-client/README/                permanent;
        rewrite ^/docs/en/querying/graph-client/architecture/$          $scheme://$http_host/docs/en/subgraphs/querying/graph-client/architecture/          permanent;
        rewrite ^/docs/en/querying/graph-client/live/$                  $scheme://$http_host/docs/en/subgraphs/querying/graph-client/live/                  permanent;
        rewrite ^/docs/en/querying/graphql-api/$                        $scheme://$http_host/docs/en/subgraphs/querying/graphql-api/                        permanent;
        rewrite ^/docs/en/querying/managing-api-keys/$                  $scheme://$http_host/docs/en/subgraphs/querying/managing-api-keys/                  permanent;
        rewrite ^/docs/en/querying/querying-best-practices/$            $scheme://$http_host/docs/en/subgraphs/querying/best-practices/                     permanent;
        rewrite ^/docs/en/querying/querying-by-subgraph-id-vs-deployment-id/$ $scheme://$http_host/docs/en/subgraphs/querying/subgraph-id-vs-deployment-id/ permanent;
        rewrite ^/docs/en/querying/querying-from-an-application/$       $scheme://$http_host/docs/en/subgraphs/querying/from-an-application/                permanent;
        rewrite ^/docs/en/querying/querying-the-graph/$                 $scheme://$http_host/docs/en/subgraphs/querying/introduction/                       permanent;
        rewrite ^/docs/en/querying/querying-with-python/$               $scheme://$http_host/docs/en/subgraphs/querying/python/                             permanent;
        rewrite ^/docs/en/quick-start/$                                 $scheme://$http_host/docs/en/subgraphs/quick-start/                                 permanent;
        rewrite ^/docs/en/release-notes/assemblyscript-migration-guide/$ $scheme://$http_host/docs/en/resources/migration-guides/assemblyscript-migration-guide/ permanent;
        rewrite ^/docs/en/resources/release-notes/assemblyscript-migration-guide/$ $scheme://$http_host/docs/en/resources/migration-guides/assemblyscript-migration-guide/ permanent;
        rewrite ^/docs/en/release-notes/graphql-validations-migration-guide/$ $scheme://$http_host/docs/en/resources/migration-guides/graphql-validations-migration-guide/ permanent;
        rewrite ^/docs/en/resources/release-notes/graphql-validations-migration-guide/$ $scheme://$http_host/docs/en/resources/migration-guides/graphql-validations-migration-guide/ permanent;
        rewrite ^/docs/en/sps/sps-faq/$                                 $scheme://$http_host/docs/en/substreams/sps/faq/                                    permanent;
        rewrite ^/docs/en/sps/(.*)$                                     $scheme://$http_host/docs/en/substreams/sps/$1                                      permanent;
        rewrite ^/docs/en/studio/billing/$                              $scheme://$http_host/docs/en/subgraphs/billing/                                     permanent;
        rewrite ^/docs/en/studio/deploy-subgraph-studio/$               $scheme://$http_host/docs/en/subgraphs/developing/deploying/using-subgraph-studio/  permanent;
        rewrite ^/docs/en/studio/managing-api-keys/$                    $scheme://$http_host/docs/en/subgraphs/querying/managing-api-keys/                  permanent;
        rewrite ^/docs/en/studio/multisig/$                             $scheme://$http_host/docs/en/subgraphs/cookbook/multisig/                           permanent;
        rewrite ^/docs/en/studio/studio-faq/$                           $scheme://$http_host/docs/en/resources/subgraph-studio-faq/                         permanent;
        rewrite ^/docs/en/studio/subgraph-studio/$                      $scheme://$http_host/docs/en/subgraphs/developing/deploying/using-subgraph-studio/  permanent;
        rewrite ^/docs/en/studio/transferring-subgraph-ownership/$      $scheme://$http_host/docs/en/subgraphs/developing/managing/transferring-a-subgraph/ permanent;
        rewrite ^/docs/en/subgraphs/$                                   $scheme://$http_host/docs/en/subgraphs/quick-start/                                 permanent;
        rewrite ^/docs/en/subgraphs/mcp/claude/$                        $scheme://$http_host/docs/en/ai-suite/subgraph-mcp/                                 permanent;
        rewrite ^/docs/en/subgraphs/mcp/cline/$                         $scheme://$http_host/docs/en/ai-suite/subgraph-mcp/                                 permanent;
        rewrite ^/docs/en/subgraphs/mcp/cursor/$                        $scheme://$http_host/docs/en/ai-suite/subgraph-mcp/                                 permanent;
        rewrite ^/docs/en/subgraphs/mcp/cline/$                         $scheme://$http_host/docs/en/ai-suite/subgraph-mcp/                                 permanent;
        rewrite ^/docs/en/substreams/$                                  $scheme://$http_host/docs/en/substreams/quick-start/                                permanent;
        rewrite ^/docs/en/substreams/developing/sinks/sinks/$           $scheme://$http_host/docs/en/substreams/developing/sinks/                           permanent;
        rewrite ^/docs/en/substreams/sps/$                              $scheme://$http_host/docs/en/substreams/sps/introduction/                           permanent;
        rewrite ^/docs/en/sunrise/$                                     $scheme://$http_host/docs/en/archived/sunrise/                                      permanent;
        rewrite ^/docs/en/supported-network-requirements/$              $scheme://$http_host/docs/en/indexing/supported-network-requirements/               permanent;
        rewrite ^/docs/en/supported-networks/arweave/$                  $scheme://$http_host/docs/en/subgraphs/cookbook/arweave/                            permanent;
        rewrite ^/docs/en/supported-networks/near/$                     $scheme://$http_host/docs/en/subgraphs/cookbook/near/                               permanent;
        rewrite ^/docs/en/tap/$                                         $scheme://$http_host/docs/en/indexing/tap/                                          permanent;
        rewrite ^/docs/en/tokenomics/$                                  $scheme://$http_host/docs/en/resources/tokenomics/                                  permanent;
        rewrite ^/docs/en/token-api/$                                   $scheme://$http_host/docs/en/token-api/quick-start/                                 permanent;
        rewrite ^/docs/en/token-api/mcp/cline/$                         $scheme://$http_host/docs/en/ai-suite/token-api-mcp/                                permanent;
        rewrite ^/docs/en/token-api/mcp/cline/$                         $scheme://$http_host/docs/en/ai-suite/token-api-mcp/                                permanent;
        rewrite ^/docs/en/token-api/mcp/cline/$                         $scheme://$http_host/docs/en/ai-suite/token-api-mcp/                                permanent;
        rewrite ^/docs/en/token-api/endpoint-pricing/$                  $scheme://$http_host/docs/en/token-api/endpoints/pricing/                           permanent;
        # Temporary redirects (302)
        rewrite ^/docs/en/querying/graph-client/$                                       $scheme://$http_host/docs/en/subgraphs/querying/graph-client/README/                redirect;
        rewrite ^/docs/en/developing/graph-ts/$                                         $scheme://$http_host/docs/en/subgraphs/developing/creating/graph-ts/README/         redirect;

        location / {
            try_files $uri $uri.html $uri/index.html =404;
        }

        # Use localized 404 pages for documentation paths
        location ~ ^/docs/en/(.*) {
            try_files $uri $uri.html $uri/index.html /docs/en/404/index.html;
        }

        error_page 500 502 503 504 /docs/50x/index.html;
    }
}

stream {}
